{
  "id": "e01ba7f3-4c7c-4b30-953a-f00f153b9613",
  "prefix": "GetXMLdataFromAuditTable",
  "description": "GetXMLdata From DBAudit.dbo.AuditTable",
  "body": "/* =========================================================================================================================================\r\n-- Server\t\t: LOCAL SERVER\r\n-- Database\t\t: DBAudit\r\n-- Script\t\t: GetXMLdataFromAuditTable\r\n-- Description\t: GetXMLdata From DBAudit.dbo.AuditTable\r\n-- Usage\t\t: Once DML Triggers are Created and Modifications will be captured in DBAudit.dbo.AuditTable as XML in DMLchange Column\r\n\t\t\t\t\tSo, To Read the XML Data, the Below Query will be helpful.\r\n========================================================================================================================================= */\r\nUSE DBAudit;\r\nGO\r\n--\r\n--\r\n--/*SELECT * FROM DBAudit.dbo.AuditTable;*/\r\nDECLARE @ID INT = $id$; -- Get Xid from DBAudit.dbo.AuditTable \r\n--\r\nDECLARE @XMLdata XML;\r\nSELECT @XMLdata = DMLchange FROM DBAudit.dbo.AuditTable WHERE Xid = @ID;\r\n--PRINT CONVERT(VARCHAR(MAX), @XMLdata);\r\n--\r\n--$BeginRegion: Analysing Data in @XMLdata\r\n----$BeginRegion: Retriving ColumnNames from @XMLdata\r\nDECLARE @TableColumns VARCHAR(MAX) = '';\r\nSELECT @TableColumns = SUBSTRING((\tSELECT ', ' + QUOTENAME(S.Att_Id)\r\n\t\t\t\t\t\t\t\t\tFROM (\r\n\t\t\t\t\t\t\t\t\t\t\tSELECT DENSE_RANK() OVER (ORDER BY p.parent) AS \"Id\",\r\n\t\t\t\t\t\t\t\t\t\t\t\t   child.value('local-name(.)', 'NVARCHAR(256)') AS \"Att_Id\"\r\n\t\t\t\t\t\t\t\t\t\t\tFROM @XMLdata.nodes('/TableHeader/row') AS p(parent)\r\n\t\t\t\t\t\t\t\t\t\t\tCROSS APPLY p.parent.nodes('./*') AS c(child)\r\n\t\t\t\t\t\t\t\t\t\t ) AS S\r\n\t\t\t\t\t\t\t\t\tWHERE S.Id = 1\r\n\t\t\t\t\t\t\t\t\tFOR XML PATH('')), 2, 200000);\r\n--SELECT @TableColumns;\r\n----$EndRegion: Retriving ColumnNames from @XMLdata\r\n--\r\n----$BeginRegion: Visualising @XMLdata as Tabular Format\r\nDECLARE @SQLstring NVARCHAR(MAX) = N'';\r\nSET @SQLstring = --\r\nN'SELECT ' + @TableColumns + N'\r\nFROM\r\n(\r\n\tSELECT DENSE_RANK() OVER (ORDER BY p.parent) AS \"Id\",\r\n\t\t   child.value(''local-name(.)'', ''NVARCHAR(256)'') AS \"Att_Id\",\r\n\t\t   child.value(''.'', ''VARCHAR(MAX)'') AS \"Att_Value\"\r\n\tFROM @XMLdata.nodes(''/TableHeader/row'') AS p(parent)\r\n\tCROSS APPLY p.parent.nodes(''./*'') AS c(child)\r\n) AS \"Source\"\r\nPIVOT\r\n(\r\n\tMAX(Att_Value)\r\n\tFOR Att_Id IN (' + @TableColumns + N')\r\n) AS \"Target\";';\r\n--PRINT @SQLstring;\r\nEXEC sys.sp_executesql @command = @SQLstring, @params = N'@XMLdata XML', @XMLdata = @XMLdata;\r\n----$EndRegion: Visualising @XMLdata as Tabular Format\r\n--$EndRegion: Analysing Data in @XMLdata",
  "placeholders": [
    {
      "name": "id",
      "defaultValue": null
    }
  ]
}
