{
  "id": "db7e5e56-b0f6-462e-aaf6-919e9a7cbfdf",
  "prefix": "GenerateDMLTriggerScripts",
  "description": "Generate Scripts to Create Triggers for Delete, Insert and Update for a Table",
  "body": "/* =============================================================================================================================================================\r\n-- Server\t\t: LOCAL SERVER\r\n-- Database\t\t: USER Database\r\n-- Script\t\t: Generate DML Trigger for Any Table Mentioned Dynamically - v6\r\n-- Description\t: Generate Scripts to Create Triggers for Delete, Insert and Update for Table(s)\r\n-- Usage\t\t: Exec in the Database where you wanted to Create DML Trigger Statements. Provide Values for @DatabaseName, @SchemaNames, @TableNames.\r\n\t\t\t\t  * Need to Have DBaudit DB to store the Data Modifications as per DML Triggers.\r\n\t\t\t\t  * This Script Generates the DML Trigger Statements (and its pre-requisites as well) for the Table specified.\r\n\t\t\t\t  * Copy the Generated Code and Execute Against Same User Database.\r\n\t\t\t\t  Refer: Snippet \"GetXMLdataFromDataAuditTbl\" to Analyse Data Stored in DataAuditTbl (XMLchange).\r\n--\r\n--$BeginRegion: Query to Alter Column DataTypes If text, ntext and image\r\nSELECT T.TABLE_CATALOG, T.TABLE_SCHEMA, T.TABLE_NAME, C.COLUMN_NAME, C.ORDINAL_POSITION, C.DATA_TYPE, '|' AS \"O\",\r\n\tCASE\r\n\t\tWHEN C.DATA_TYPE = 'text' THEN 'ALTER TABLE [' + T.TABLE_SCHEMA + '].[' + T.TABLE_NAME + '] ALTER COLUMN [' + C.COLUMN_NAME + '] VARCHAR(MAX);'\r\n\t\tWHEN C.DATA_TYPE = 'ntext' THEN 'ALTER TABLE [' + T.TABLE_SCHEMA + '].[' + T.TABLE_NAME + '] ALTER COLUMN [' + C.COLUMN_NAME + '] NVARCHAR(MAX);'\r\n\t\tWHEN C.DATA_TYPE = 'image' THEN 'ALTER TABLE [' + T.TABLE_SCHEMA + '].[' + T.TABLE_NAME + '] ALTER COLUMN [' + C.COLUMN_NAME + '] VARBINARY(MAX);'\r\n\t\tELSE '' END AS \"ALTER DATATYPE STATEMENT\"\r\nFROM INFORMATION_SCHEMA.COLUMNS AS C\r\nINNER JOIN INFORMATION_SCHEMA.TABLES AS T\r\n\tON T.TABLE_SCHEMA = C.TABLE_SCHEMA AND T.TABLE_NAME = C.TABLE_NAME\r\nWHERE T.TABLE_TYPE = 'BASE TABLE' AND C.DATA_TYPE IN ('text', 'ntext', 'image')\r\nORDER BY T.TABLE_SCHEMA ASC, T.TABLE_NAME ASC;\r\n--$EndRegion: Query to Alter Column DataTypes If text, ntext and image\r\n============================================================================================================================================================= */\r\nDECLARE @DatabaseName VARCHAR(256) = $Database_Name$;--USER Database\r\nDECLARE @SchemaNames VARCHAR(128) = '$Schema_Names$';--CommaSeparated Values Allowed\r\nDECLARE @TableNames VARCHAR(256) = '$Table_Names$';--CommaSeparated Values Allowed\r\n--\r\nDECLARE @RequireExclusiveAuditDB BIT = 1; -- 1 = ExclusiveAudit DB will be Created | 0 = Default \"DBaudit\" Database will be Created.\r\nDECLARE @DBprefix VARCHAR(32) = '$Prefix$'; --DataAuditTbl will Contain DatabaseName as @DBprefix. If Not Mentioned, it will pick the @DatabaseName\r\n--To Include/Exclude Scripts for DataAuditTbl, DeleteTrigger, InsertTrigger, UpdateTrigger.\r\nDECLARE @CreateDataAuditTbl BIT = 1; --DataAuditTbl Script will be Generated. (We can Disable if We already have Audit Tables Created)\r\nDECLARE @IncludeGenaralAudit BIT = 1; -- General Audit Table will be Created and Respective Trigger Statements inside Trigger: 1 = Included (Default) | 0 = Excluded\r\nDECLARE @GenerateDeleteTrigger BIT = 1; -- 1 = Included (Default) | 0 = Excluded\r\nDECLARE @GenerateInsertTrigger BIT = 1; -- 1 = Included (Default) | 0 = Excluded\r\nDECLARE @GenerateUpdateTrigger BIT = 1; -- 1 = Included (Default) | 0 = Excluded\r\n--\r\nDECLARE @Debug BIT = 0;\t-- 0 = Excluded (Default) | 1 = Shows TableColumns InDetail\r\n/* ===== ** DO NOT CHANGE CODE BELOW FROM HERE ** =========================================================================================================== */\r\nSET NOCOUNT ON;\r\n--\r\nSET @SchemaNames = LTRIM(RTRIM(@SchemaNames)); IF @SchemaNames = '' SET @SchemaNames = NULL; --Trimming and Resetting Value\r\nSET @TableNames = LTRIM(RTRIM(@TableNames)); IF @TableNames = '' SET @TableNames = NULL; --Trimming and Resetting Value\r\n--$BeginRegion: Variables and PreRequisites Declaration\r\nDECLARE @SQLstring AS NVARCHAR(MAX);\r\nDECLARE @DataAuditTblName NVARCHAR(256);\r\n--\r\nDECLARE @TableColumns TABLE\r\n(\r\n\tColID INT NULL, --ORDINAL_POSITION\r\n\tColumnName VARCHAR(256) NULL,\r\n\tColumnDataType VARCHAR(64) NULL,\r\n\tIsPrimaryKeyCol BIT NULL,\r\n\tIsComputedCol BIT NULL,\r\n\tIsIdentityCol BIT NULL\r\n);\r\n--$EndRegion: Variables and PreRequisites Declaration\r\n--\r\n--$BeginRegion: Generate Create Audit Database If Not Exists\r\nPRINT N'--$BeginRegion: Create Database \"' + CASE WHEN @RequireExclusiveAuditDB = 1 THEN @DatabaseName + '_Audit' ELSE 'DBaudit' END +'\" If Not Exists'; --\r\nPRINT N'USE master;'; --\r\nPRINT N'GO'; --\r\nPRINT N'IF NOT EXISTS (SELECT * FROM master.sys.databases WHERE name = ''' + CASE WHEN @RequireExclusiveAuditDB = 1 THEN @DatabaseName + '_Audit' ELSE 'DBaudit' END +''')'; --\r\nPRINT N'\tEXEC master.sys.sp_executesql N''CREATE DATABASE [' + CASE WHEN @RequireExclusiveAuditDB = 1 THEN @DatabaseName + '_Audit' ELSE 'DBaudit' END +'];'';'; --\r\nPRINT N'GO'; --\r\nPRINT N'--$EndRegion: Create Database \"' + CASE WHEN @RequireExclusiveAuditDB = 1 THEN @DatabaseName + '_Audit' ELSE 'DBaudit' END +'\" If Not Exists'; --\r\nPRINT N'--'+CHAR(10);\r\n--$EndRegion: Generate Create Audit Database If Not Exists\r\n--\r\n--$BeginRegion: Generate Create Generalised DataAuditTbl in Audit Database\r\nIF @IncludeGenaralAudit = 1\r\nBEGIN\r\n\tPRINT N'--$BeginRegion: Create Generalised DataAuditTbl in \"' + CASE WHEN @RequireExclusiveAuditDB = 1 THEN @DatabaseName + '_Audit' ELSE 'DBaudit' END +'\" Database';\r\n\tPRINT N'IF OBJECT_ID(''' + CASE WHEN @RequireExclusiveAuditDB = 1 THEN @DatabaseName + '_Audit' ELSE 'DBaudit' END +'.dbo.DataAuditTbl'', ''U'') IS NULL';\r\n\tPRINT N'\tCREATE TABLE ' + CASE WHEN @RequireExclusiveAuditDB = 1 THEN @DatabaseName + '_Audit' ELSE 'DBaudit' END +'.dbo.DataAuditTbl';\r\n\tPRINT N'\t(';\r\n\tPRINT N'\t\tXid INT IDENTITY(1,1), AuditTimeX DATETIME DEFAULT GETDATE(), HostNameX VARCHAR(128), AppNameX VARCHAR(256), LoginUserX VARCHAR(128), SPIDX INT,';\r\n\tPRINT N'\t\tDBname VARCHAR(256), SCHname VARCHAR(256), TBLname VARCHAR(256), DML VARCHAR(2), RowsX INT, DMLchange XML';\r\n\tPRINT N'\t);';\r\n\tPRINT N'GO';\r\n\tPRINT N'--$EndRegion: Create Generalised DataAuditTbl in \"' + CASE WHEN @RequireExclusiveAuditDB = 1 THEN @DatabaseName + '_Audit' ELSE 'DBaudit' END +'\" Database';\r\n\tPRINT N'--'+CHAR(10);\r\nEND;\r\n--$EndRegion: Generate Create Generalised DataAuditTbl in Audit Database\r\n--\r\n--\r\n--$BeginRegion: _TableCursor For Generating DML Triggers for Each Table\r\nDECLARE @SCHxml XML, @TBLxml XML;\r\nSET @SCHxml = CAST(('<x>' + REPLACE(@SchemaNames, ',', '</x><x>') + '</x>') AS XML);\r\nSET @TBLxml = CAST(('<x>' + REPLACE(@TableNames, ',', '</x><x>') + '</x>') AS XML);\r\n--\r\n----$BeginRegion: Get Detailed Columns Information\r\nIF OBJECT_ID('tempdb..#ColumnsDetailedList', 'U') IS NOT NULL\r\n\tDROP TABLE #ColumnsDetailedList;\r\nCREATE TABLE #ColumnsDetailedList\r\n(\r\n\tSchemaName NVARCHAR(128) NOT NULL, TableName NVARCHAR(128) NOT NULL,\r\n\tColumnId INT NOT NULL, ColumnName NVARCHAR(128) NOT NULL, ColumnDataType NVARCHAR(128) NOT NULL,\r\n\tis_primary INT NOT NULL DEFAULT(0), is_identity BIT NOT NULL DEFAULT(0), is_computed BIT NOT NULL DEFAULT(0)\r\n);\r\nINSERT INTO #ColumnsDetailedList\r\n(\r\n\tSchemaName, TableName,\r\n\tColumnId, ColumnName, ColumnDataType,\r\n\tis_primary, is_identity, is_computed\r\n)\r\nSELECT SCH.name AS \"SchemaName\", TBL.name AS \"TableName\",\r\n\t   COL.column_id AS \"ColID\", COL.name AS \"ColumnName\",\r\n\t   ST.name --\r\n\t\t   + CASE\r\n\t\t\t\t WHEN ST.name IN ( 'decimal', 'numeric' ) THEN '(' + CAST(COL.precision AS VARCHAR(4)) + ', ' + CAST(COL.scale AS VARCHAR(4)) + ')'\r\n\t\t\t\t WHEN COL.max_length = -1 AND ST.name NOT IN ( 'xml' ) THEN '(max)'\r\n\t\t\t\t WHEN ST.name IN ( 'nvarchar', 'nchar' ) THEN '(' + CAST(COL.max_length / 2 AS VARCHAR(5)) + ')'\r\n\t\t\t\t WHEN ST.name IN ( 'varchar', 'char', 'varbinary', 'binary' ) THEN '(' + CAST(COL.max_length AS VARCHAR(5)) + ')'\r\n\t\t\t\t ELSE ''\r\n\t\t\t END AS \"ColumnDataType\",\r\n\t   ISNULL(PKC.Is_PK, 0) AS \"IsPrimaryKeyCol?\", COL.is_identity AS \"IsIdentityCol?\", COL.is_computed AS \"IsComputedCol?\"\r\nFROM sys.columns AS COL --UT\r\nINNER JOIN sys.types AS ST ON ST.user_type_id = COL.system_type_id\r\nINNER JOIN sys.tables AS TBL ON TBL.object_id = COL.object_id\r\nINNER JOIN sys.schemas AS SCH ON SCH.schema_id = TBL.schema_id\r\nLEFT JOIN (\r\n\t\t\t  SELECT IC.object_id, IC.column_id, 1 AS \"Is_PK\"\r\n\t\t\t  FROM sys.index_columns AS IC\r\n\t\t\t  INNER JOIN sys.key_constraints AS KC ON IC.object_id = KC.parent_object_id\r\n\t\t\t\t\t AND IC.index_id = KC.unique_index_id AND KC.type = 'PK'\r\n\t\t  ) AS PKC ON PKC.column_id = COL.column_id AND PKC.object_id = COL.object_id\r\nWHERE TBL.type = 'U'\r\n\tAND (EXISTS(SELECT * FROM @SCHxml.nodes('x') AS T(N) WHERE T.N.value('.', 'nvarchar(max)') = SCH.name) OR @SchemaNames IS NULL)\r\n\tAND (EXISTS(SELECT * FROM @TBLxml.nodes('x') AS T(N) WHERE T.N.value('.', 'nvarchar(max)') = TBL.name) OR @TableNames IS NULL)\r\nORDER BY SCH.name ASC, TBL.name ASC, COL.column_id ASC;\r\n----$EndRegion: Get Detailed Columns Information\r\n--\r\nDECLARE @DBname NVARCHAR(128), @SCHname AS NVARCHAR(128), @TBLname AS NVARCHAR(128);\r\nDECLARE _TableCursor CURSOR READ_ONLY LOCAL FAST_FORWARD FOR\r\n(\r\n\tSELECT TABLE_CATALOG, TABLE_SCHEMA, TABLE_NAME\r\n\tFROM INFORMATION_SCHEMA.TABLES\r\n\tWHERE TABLE_TYPE = 'BASE TABLE'\r\n\t\tAND (EXISTS(SELECT * FROM @SCHxml.nodes('x') AS T(N) WHERE T.N.value('.', 'nvarchar(max)') = TABLE_SCHEMA) OR @SchemaNames IS NULL)\r\n\t\tAND (EXISTS(SELECT * FROM @TBLxml.nodes('x') AS T(N) WHERE T.N.value('.', 'nvarchar(max)') = TABLE_NAME) OR @TableNames IS NULL)\r\n);\r\n--\r\nOPEN _TableCursor;\r\nFETCH NEXT FROM _TableCursor INTO @DBname, @SCHname, @TBLname;\r\nWHILE @@FETCH_STATUS = 0\r\nBEGIN\r\n\tPRINT N'/* $BeginScript: == DML Triggers Script For Table: [' + @DBname + '].[' + @SCHname + '].[' + @TBLname + '] == */';\r\n\t--\r\n\t--$BeginRegion: Getting Table Column Details\r\n\tDELETE FROM @TableColumns WHERE 1=1;\r\n\tINSERT INTO @TableColumns (ColID, ColumnName, ColumnDataType, IsPrimaryKeyCol, IsIdentityCol, IsComputedCol)\r\n\tSELECT ColumnId, ColumnName, ColumnDataType, is_primary, is_identity, is_computed\r\n\tFROM #ColumnsDetailedList\r\n\tWHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t--\r\n\tIF @Debug = 1\r\n\tBEGIN\r\n\t\tSELECT @DBname AS \"DatabaseName\", @SCHname AS \"SchemaName\", @TBLname AS \"TableName\",\r\n\t\t\t   ColID, ColumnName, ColumnDataType, IsPrimaryKeyCol, IsIdentityCol, IsComputedCol\r\n\t\tFROM @TableColumns AS TC;\r\n\tEND;\r\n\t--$EndRegion: Getting Table Column Details\r\n\t--\r\n\t--$BeginRegion: Setting Audit Table Name\r\n\tIF @RequireExclusiveAuditDB = 1\r\n\tBEGIN\r\n\t\t--$BeginRegion: Generate Create Schema in Audit Database If Not Exists\r\n\t\tPRINT N'--$BeginRegion: Create Schema \"'+@SCHname+N'\" in \"'+@DatabaseName+'_Audit\" Database If Not Exists';\r\n\t\tPRINT N'USE ['+@DatabaseName+'_Audit];';\r\n\t\tPRINT N'GO';\r\n\t\tPRINT N'IF NOT EXISTS (SELECT * FROM ['+@DatabaseName+'_Audit].sys.schemas WHERE name = N'''+@SCHname+N''')';\r\n\t\tPRINT N'\tEXEC ['+@DatabaseName+'_Audit].sys.sp_executesql N''CREATE SCHEMA ['+@SCHname+N'];'';';\r\n\t\tPRINT N'GO';\r\n\t\tPRINT N'--$EndRegion: Create Schema \"'+@SCHname+N'\" in \"'+@DatabaseName+'_Audit\" Database If Not Exists';\r\n\t\tPRINT N'--'+CHAR(10);\r\n\t\t--$EndRegion: Generate Create Schema in Audit Database If Not Exists\r\n\t\tSET @DataAuditTblName = '['+@DatabaseName+'_Audit'+'].['+@SCHname+'].['+@TBLname+']';\r\n\tEND;\r\n\tELSE\r\n\tBEGIN\r\n\t\tIF REPLACE(@DBprefix, ' ', '') = '' OR @DBprefix IS NULL\r\n\t\t\tSET @DBprefix = @DBname;\r\n\t\tSET @DataAuditTblName = '[DBaudit].[dbo].['+@DBprefix+'_'+@SCHname+'_'+@TBLname+'_Audit]';\r\n\tEND;\r\n\t--$EndRegion: Setting Audit Table Name\r\n\t--\r\n\t--\r\n\tIF @CreateDataAuditTbl = 1\r\n\tBEGIN\r\n\t\t--$BeginRegion: Generate Create Specific DataAuditTbl in Audit Database\r\n\t\tPRINT N'--$BeginRegion: Create Specific DataAuditTbl \"'+@DataAuditTblName+N'\"';\r\n\t\tPRINT N'USE [' + CASE WHEN @RequireExclusiveAuditDB = 1 THEN @DatabaseName + '_Audit' ELSE 'DBaudit' END +'];';\r\n\t\tPRINT N'GO';\r\n\t\tPRINT N'IF OBJECT_ID('''+@DataAuditTblName+N''', ''U'') IS NOT NULL';\r\n\t\tPRINT N'\tDROP TABLE '+@DataAuditTblName+N';';\r\n\t\tPRINT N'CREATE TABLE '+@DataAuditTblName;\r\n\t\tPRINT N'(';\r\n\t\tPRINT N'\tXid INT IDENTITY(1,1), AuditTimeX DATETIME DEFAULT GETDATE(), HostNameX VARCHAR(128), AppNameX VARCHAR(256), LoginUserX VARCHAR(128), SPIDX INT, DML VARCHAR(2),';\r\n\t\tSET @SQLstring = N'\t'+STUFF((SELECT ', '+QUOTENAME(ColumnName)+N' '+ColumnDataType FROM @TableColumns ORDER BY ColID ASC FOR XML PATH('')), 1, 2, '');\r\n\t\tPRINT @SQLstring;\r\n\t\tPRINT N');';\r\n\t\tPRINT N'GO';\r\n\t\tPRINT N'--$EndRegion: Create Specific DataAuditTbl \"'+@DataAuditTblName+N'\"';\r\n\t\tPRINT N'--'+CHAR(10);\r\n\t\t--$EndRegion: Generate Create Specific DataAuditTbl in Audit Database\r\n\tEND;\r\n\t--\r\n\t--\r\n\tIF @GenerateDeleteTrigger = 1\r\n\tBEGIN\r\n\t\t--$BeginRegion: Generate Delete Trigger Script\r\n\t\tPRINT N'--$BeginRegion: Create Delete Trigger Script';\r\n\t\tPRINT N'USE ['+@DBname+N'];';\r\n\t\tPRINT N'GO';\r\n\t\tPRINT N'IF OBJECT_ID(''['+@SCHname+N'].['+@TBLname+N'_DelX]'', ''TR'') IS NOT NULL';\r\n\t\tPRINT N'\tDROP TRIGGER ['+@SCHname+N'].['+@TBLname+N'_DelX];';\r\n\t\tPRINT N'GO';\r\n\t\tPRINT N'CREATE TRIGGER ['+@SCHname+N'].['+@TBLname+N'_DelX]';\r\n\t\tPRINT N'ON ['+@DBname+N'].['+@SCHname+N'].['+@TBLname+N']';\r\n\t\tPRINT N'FOR DELETE';\r\n\t\tPRINT N'AS';\r\n\t\tPRINT N'BEGIN';\r\n\t\tPRINT N'\tDECLARE @GETDATE DATETIME = GETDATE();';\r\n\t\tSET @SQLstring = N'\tINSERT INTO '+@DataAuditTblName+N'(AuditTimeX, HostNameX, AppNameX, LoginUserX, SPIDX, DML, '+STUFF((SELECT ', '+QUOTENAME(ColumnName) FROM @TableColumns ORDER BY ColID ASC FOR XML PATH('')), 1, 2, '')+N')';\r\n\t\tPRINT @SQLstring;\r\n\t\tSET @SQLstring = N'\tSELECT @GETDATE, HOST_NAME(), APP_NAME(), SUSER_SNAME(), @@SPID, ''D'', '+STUFF((SELECT ', D.'+QUOTENAME(ColumnName) FROM @TableColumns ORDER BY ColID ASC FOR XML PATH('')), 1, 2, '');\r\n\t\tPRINT @SQLstring;\r\n\t\tPRINT N'\tFROM Deleted AS D;';\r\n\t\tIF @IncludeGenaralAudit = 1\r\n\t\tBEGIN\r\n\t\t\tPRINT N'\tINSERT INTO ' + CASE WHEN @RequireExclusiveAuditDB = 1 THEN @DatabaseName + '_Audit' ELSE 'DBaudit' END +'.dbo.DataAuditTbl(AuditTimeX, HostNameX, AppNameX, LoginUserX, SPIDX, DBName, SCHname, TBLname, DML, RowsX, DMLchange)';\r\n\t\t\tPRINT N'\tSELECT @GETDATE, HOST_NAME(), APP_NAME(), SUSER_SNAME(), @@SPID, '''+@DBname+''', '''+@SCHname+''', '''+@TBLname+''', ''D'', @@ROWCOUNT, (SELECT * FROM DELETED AS D FOR XML RAW, BINARY BASE64, ROOT(''TableHeader''), ELEMENTS);';\r\n\t\tEND;\r\n\t\tPRINT N'END;';\r\n\t\tPRINT N'GO';\r\n\t\tPRINT N'--$EndRegion: Create Delete Trigger Script';\r\n\t\tPRINT N'--'+CHAR(10);\r\n\t\t--$EndRegion: Generate Delete Trigger Script\t    \r\n\tEND;\r\n\t--\r\n\t--\r\n\tIF @GenerateInsertTrigger = 1\r\n\tBEGIN\r\n\t\t--$BeginRegion: Generate Insert Trigger Script\r\n\t\tPRINT N'--$BeginRegion: Create Insert Trigger Script';\r\n\t\tPRINT N'USE ['+@DBname+N'];';\r\n\t\tPRINT N'GO';\r\n\t\tPRINT N'IF OBJECT_ID(''['+@SCHname+N'].['+@TBLname+N'_InsX]'', ''TR'') IS NOT NULL';\r\n\t\tPRINT N'\tDROP TRIGGER ['+@SCHname+N'].['+@TBLname+N'_InsX];';\r\n\t\tPRINT N'GO';\r\n\t\tPRINT N'CREATE TRIGGER ['+@SCHname+N'].['+@TBLname+N'_InsX]';\r\n\t\tPRINT N'ON ['+@DBname+N'].['+@SCHname+N'].['+@TBLname+N']';\r\n\t\tPRINT N'FOR INSERT';\r\n\t\tPRINT N'AS';\r\n\t\tPRINT N'BEGIN';\r\n\t\tPRINT N'\tDECLARE @GETDATE DATETIME = GETDATE();';\r\n\t\tSET @SQLstring = N'\tINSERT INTO '+@DataAuditTblName+N'(AuditTimeX, HostNameX, AppNameX, LoginUserX, SPIDX, DML, '+STUFF((SELECT ', '+QUOTENAME(ColumnName) FROM @TableColumns ORDER BY ColID ASC FOR XML PATH('')), 1, 2, '')+N')';\r\n\t\tPRINT @SQLstring;\r\n\t\tSET @SQLstring = N'\tSELECT @GETDATE, HOST_NAME(), APP_NAME(), SUSER_SNAME(), @@SPID, ''I'', '+STUFF((SELECT ', I.'+QUOTENAME(ColumnName) FROM @TableColumns ORDER BY ColID ASC FOR XML PATH('')), 1, 2, '');\r\n\t\tPRINT @SQLstring;\r\n\t\tPRINT N'\tFROM Inserted AS I;';\r\n\t\tIF @IncludeGenaralAudit = 1\r\n\t\tBEGIN\r\n\t\t\tPRINT N'\tINSERT INTO ' + CASE WHEN @RequireExclusiveAuditDB = 1 THEN @DatabaseName + '_Audit' ELSE 'DBaudit' END +'.dbo.DataAuditTbl(AuditTimeX, HostNameX, AppNameX, LoginUserX, SPIDX, DBName, SCHname, TBLname, DML, RowsX, DMLchange)';\r\n\t\t\tPRINT N'\tSELECT @GETDATE, HOST_NAME(), APP_NAME(), SUSER_SNAME(), @@SPID, '''+@DBname+''', '''+@SCHname+''', '''+@TBLname+''', ''I'', @@ROWCOUNT, (SELECT * FROM INSERTED AS I FOR XML RAW, BINARY BASE64, ROOT(''TableHeader''), ELEMENTS);';\r\n\t\tEND;\r\n\t\tPRINT N'END;';\r\n\t\tPRINT N'GO';\r\n\t\tPRINT N'--$EndRegion: Create Insert Trigger Script';\r\n\t\tPRINT N'--'+CHAR(10);\r\n\t\t--$EndRegion: Generate Insert Trigger Script\r\n\tEND;\r\n\t--\r\n\t--\r\n\tIF @GenerateUpdateTrigger = 1\r\n\tBEGIN\r\n\t\t--$BeginRegion: Generate Update Trigger Script\r\n\t\tPRINT N'--$BeginRegion: Create Update Trigger Script';\r\n\t\tPRINT N'USE ['+@DBname+N'];';\r\n\t\tPRINT N'GO';\r\n\t\tPRINT N'IF OBJECT_ID(''['+@SCHname+N'].['+@TBLname+N'_UpdX]'', ''TR'') IS NOT NULL';\r\n\t\tPRINT N'\tDROP TRIGGER ['+@SCHname+N'].['+@TBLname+N'_UpdX];';\r\n\t\tPRINT N'GO';\r\n\t\tPRINT N'CREATE TRIGGER ['+@SCHname+N'].['+@TBLname+N'_UpdX]';\r\n\t\tPRINT N'ON ['+@DBname+N'].['+@SCHname+N'].['+@TBLname+N']';\r\n\t\tPRINT N'FOR UPDATE';\r\n\t\tPRINT N'AS';\r\n\t\tPRINT N'BEGIN';\r\n\t\tPRINT N'\tDECLARE @GETDATE DATETIME = GETDATE();';\r\n\t\tSET @SQLstring = N'\tINSERT INTO '+@DataAuditTblName+N'(AuditTimeX, HostNameX, AppNameX, LoginUserX, SPIDX, DML, '+STUFF((SELECT ', '+QUOTENAME(ColumnName) FROM @TableColumns ORDER BY ColID ASC FOR XML PATH('')), 1, 2, '')+N')';\r\n\t\tPRINT @SQLstring;\r\n\t\tSET @SQLstring = N'\tSELECT @GETDATE, HOST_NAME(), APP_NAME(), SUSER_SNAME(), @@SPID, ''UD'', '+STUFF((SELECT ', D.'+QUOTENAME(ColumnName) FROM @TableColumns ORDER BY ColID ASC FOR XML PATH('')), 1, 2, '');\r\n\t\tPRINT @SQLstring;\r\n\t\tPRINT N'\tFROM DELETED AS D;';\r\n\t\tIF @IncludeGenaralAudit = 1\r\n\t\tBEGIN\r\n\t\t\tPRINT N'\tINSERT INTO ' + CASE WHEN @RequireExclusiveAuditDB = 1 THEN @DatabaseName + '_Audit' ELSE 'DBaudit' END +'.dbo.DataAuditTbl(AuditTimeX, HostNameX, AppNameX, LoginUserX, SPIDX, DBName, SCHname, TBLname, DML, RowsX, DMLchange)';\r\n\t\t\tPRINT N'\tSELECT @GETDATE, HOST_NAME(), APP_NAME(), SUSER_SNAME(), @@SPID, '''+@DBname+''', '''+@SCHname+''', '''+@TBLname+''', ''UD'', @@ROWCOUNT, (SELECT * FROM DELETED AS D FOR XML RAW, BINARY BASE64, ROOT(''TableHeader''), ELEMENTS);';\r\n\t\tEND;\r\n\t\tPRINT N'\t--';\r\n\t\tSET @SQLstring = N'\tINSERT INTO '+@DataAuditTblName+N'(AuditTimeX, HostNameX, AppNameX, LoginUserX, SPIDX, DML, '+STUFF((SELECT ', '+QUOTENAME(ColumnName) FROM @TableColumns ORDER BY ColID ASC FOR XML PATH('')), 1, 2, '')+N')';\r\n\t\tPRINT @SQLstring;\r\n\t\tSET @SQLstring = N'\tSELECT @GETDATE, HOST_NAME(), APP_NAME(), SUSER_SNAME(), @@SPID, ''UI'', '+STUFF((SELECT ', I.'+QUOTENAME(ColumnName) FROM @TableColumns ORDER BY ColID ASC FOR XML PATH('')), 1, 2, '');\r\n\t\tPRINT @SQLstring;\r\n\t\tPRINT N'\tFROM INSERTED AS I;';\r\n\t\tIF @IncludeGenaralAudit = 1\r\n\t\tBEGIN\r\n\t\t\tPRINT N'\tINSERT INTO ' + CASE WHEN @RequireExclusiveAuditDB = 1 THEN @DatabaseName + '_Audit' ELSE 'DBaudit' END +'.dbo.DataAuditTbl(AuditTimeX, HostNameX, AppNameX, LoginUserX, SPIDX, DBName, SCHname, TBLname, DML, RowsX, DMLchange)';\r\n\t\t\tPRINT N'\tSELECT @GETDATE, HOST_NAME(), APP_NAME(), SUSER_SNAME(), @@SPID, '''+@DBname+''', '''+@SCHname+''', '''+@TBLname+''', ''UI'', @@ROWCOUNT, (SELECT * FROM INSERTED AS I FOR XML RAW, BINARY BASE64, ROOT(''TableHeader''), ELEMENTS);';\t\t    \r\n\t\tEND;\r\n\t\tPRINT N'END;';\r\n\t\tPRINT N'GO';\r\n\t\tPRINT N'--$EndRegion: Create Update Trigger Script';\r\n\t\tPRINT N'--'+CHAR(10);\r\n\t\t--$EndRegion: Generate Update Trigger Script\r\n\tEND;\r\n\t--\r\n\tPRINT N'/* $EndScript: == DML Triggers Script For Table: [' + @DBname + '].[' + @SCHname + '].[' + @TBLname + '] == */';\r\n\tPRINT N'GO'+CHAR(10)+CHAR(10)+CHAR(10);\r\n\t--\r\n\tFETCH NEXT FROM _TableCursor INTO @DBname, @SCHname, @TBLname;\r\nEND;\r\n--\r\nCLOSE _TableCursor;\r\nDEALLOCATE _TableCursor;\r\n--$EndRegion: _TableCursor For Generating DML Triggers for Each Table",
  "placeholders": [
    {
      "name": "Database_Name",
      "defaultValue": "DB_NAME()"
    },
    {
      "name": "Schema_Names",
      "defaultValue": "Production,Sales"
    },
    {
      "name": "Table_Names",
      "defaultValue": "Product,SalesTerritory"
    },
    {
      "name": "Prefix",
      "defaultValue": "w3s"
    }
  ]
}