{
  "id": "bec3dc35-8363-4405-8151-605f06961ce6",
  "prefix": "GetRowCountDifference_MergeDataHierarchically",
  "description": "Get Table Row Count Difference Between Source and Target Databases >> Merge Data Hierarchically w.r.to Table Dependency",
  "body": "/* =============================================================================================================================================================\r\n-- Server\t\t: LOCAL SERVER\r\n-- Database\t\t: master\r\n-- Script\t\t: GetRowCountDifference_MergeDataHierarchically\r\n-- Description\t: Get Table Row Count Difference Between Source and Target Databases >> Merge Data Hierarchically w.r.to Table Dependency\r\n-- Usage\t\t: Execute in [master] to Get Row Count Differences along with Generating Statements to Merge Data btwn Source and Target and ViceVersa\r\n-- Applicable For All below Table Types:\r\n--  Table Contains All Columns as PrimaryKey Columns Only (i.e., No Other Columns Except PK Columns)\r\n--  Table Contains PrimaryKey Columns Along with Other Columns\r\n--  Table Contains All Columns as PrimaryKey Columns in which One of the PrimaryKey Column is an IdentityKey Column (i.e., No Other Columns Except PK and ID Columns)\r\n--  Table Contains PrimaryKey Columns in which One of the PrimaryKey Column is an IdentityKey Column Along with Other Columns\r\n--  Table Contains All Columns with Both Exclusive PrimaryKey Columns and Exclusive IdentityKey Column (i.e., No Other Columns Except PK and ID Columns)\r\n--  Table Contains Both Exclusive PrimaryKey Columns and Exclusive IdentityKey Column Along with Other Columns\r\n-- *Table Contains No PrimaryKey Columns But has IdentityKey Column Only (i.e., No Other Columns Except ID Column) --Invalid Table\r\n--  Table Contains No PrimaryKey Columns But has IdentityKey Column Along with Other Columns\r\n-- *Table DoesNot Contain Both PrimaryKey Columns and IdentityKey Column (i.e, Just like Heap and might not be Heap if clustered Index is Created)\r\n============================================================================================================================================================= */\r\nUSE master;\r\nGO\r\n--\r\nDECLARE @ReferSourceDatabase VARCHAR(128) = '$SourceDatabase$';\t--Source Database\r\nDECLARE @CheckTargetDatabase VARCHAR(128) = '$TargetDatabase$';\t--Target Database\r\nDECLARE @SchemaName VARCHAR(128) = NULL;\t--Optional\r\nDECLARE @TableName VARCHAR(128) = NULL;\t\t--Optional\r\nDECLARE @LinkedServer VARCHAR(128) = $LinkedServer$;\t--Optional\r\n--\r\nDECLARE --To Get All Dependent Tables in Hierarchy LVL\r\n\t@HierarchyCheck BIT = 1; -- 1 = Included (Default) | 0 = Excluded\r\n--\r\nDECLARE --To Include/Exclude Statements for Insert, Update, Delete in Merge Statements\r\n\t@IncludeInsert BIT = 1, -- 1 = Included (Default) | 0 = Excluded\r\n\t@IncludeUpdate BIT = 1, -- 1 = Included (Default) | 0 = Excluded\r\n\t@IncludeDelete BIT = 1; -- 1 = Included (Default) | 0 = Excluded\r\n--\r\nDECLARE @Debug BIT = 0;\t-- 1 = Show ColumnsList | 0 = Excluded (Default) -- Use if Checking For Single Table\r\n/* ===== ** DO NOT CHANGE CODE BELOW FROM HERE ** =========================================================================================================== */\r\nSET NOCOUNT ON;\r\nDECLARE @SQLcmd NVARCHAR(MAX), @SQLquery NVARCHAR(MAX), @ErrMsg NVARCHAR(MAX);\r\n--\r\nIF @HierarchyCheck = 1 AND (@SchemaName IS NULL OR @TableName IS NULL)\r\nBEGIN\r\n\tRAISERROR('To Get Particular Table Hierarchy Dependency Details, Provide Both (@SchemaName AND @TableName) OR Disable @HierarchyCheck.!', 11, 0) WITH NOWAIT;\r\n\tRETURN;\r\nEND;\r\n--\r\n--$BeginRegion: Get TablesList from @ReferSourceDatabase UNION @CheckTargetDatabase\r\nDECLARE @SourceHierarchyDetails TABLE (SchemaName NVARCHAR(128) NULL, TableName NVARCHAR(128) NOT NULL, LVL INT NOT NULL, DependencyPath NVARCHAR(MAX) NOT NULL);\r\nDECLARE @TargetHierarchyDetails TABLE (SchemaName NVARCHAR(128) NULL, TableName NVARCHAR(128) NOT NULL, LVL INT NOT NULL, DependencyPath NVARCHAR(MAX) NOT NULL);\r\n--\r\nIF OBJECT_ID('tempdb..#TablesList', 'U') IS NOT NULL\r\n\tDROP TABLE #TablesList;\r\nCREATE TABLE #TablesList (SCHname VARCHAR(128) NULL, TBLname VARCHAR(128) NULL, LVL INT NULL, FLG BIT NULL DEFAULT (0));\r\n--\r\n----$BeginRegion: Get Table Hierachy Details Query\r\nSET @SQLquery = NULL; --Reset Value\r\nSET @SQLquery = N'N'';WITH _Dependencies -- Get Objects with FK Dependencies\r\nAS (\r\n\t\tSELECT C.CONSTRAINT_NAME, FK.TABLE_SCHEMA AS \"OBJECTschema\", FK.TABLE_NAME AS \"OBJECTname\",\r\n\t\t\t   PK.TABLE_SCHEMA AS \"DEPENDSschema\", PK.TABLE_NAME AS \"DEPENDSname\"\r\n\t\tFROM INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS AS C\r\n\t\tINNER JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS AS FK ON C.CONSTRAINT_NAME=FK.CONSTRAINT_NAME\r\n\t\tINNER JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS AS PK ON C.UNIQUE_CONSTRAINT_NAME=PK.CONSTRAINT_NAME\r\n\t\tWHERE NOT EXISTS\r\n\t\t\t(\r\n\t\t\t\tSELECT FK1.name AS ForeignKeyName,\r\n\t\t\t\t\t   OBJECT_SCHEMA_NAME(FK1.parent_object_id)+''''.''''+OBJECT_NAME(FK1.parent_object_id) AS MainTableName,\r\n\t\t\t\t\t   OBJECT_SCHEMA_NAME(FK1.referenced_object_id)+''''.''''+OBJECT_NAME(FK1.referenced_object_id) AS ReferTableName\r\n\t\t\t\tFROM sys.foreign_keys AS FK1\r\n\t\t\t\tINNER JOIN sys.foreign_keys AS FK2 ON FK1.parent_object_id = FK2.referenced_object_id AND FK2.parent_object_id=FK1.referenced_object_id\r\n\t\t\t\tWHERE FK1.name = C.CONSTRAINT_NAME OR FK2.name = C.CONSTRAINT_NAME\r\n\t\t\t)\r\n   ),\r\n_NoDependencies -- The First Level Objects are with No Dependencies\r\nAS (\r\n\t\tSELECT T.TABLE_SCHEMA AS \"OBJECTschema\", T.TABLE_NAME AS \"OBJECTname\"\r\n\t\tFROM INFORMATION_SCHEMA.TABLES AS T\r\n\t\tWHERE T.TABLE_TYPE = ''''BASE TABLE'''' -- Considering Tables Only But Not Views\r\n\t\t\tAND NOT EXISTS (SELECT 1 FROM _Dependencies AS D WHERE D.OBJECTschema = T.TABLE_SCHEMA AND D.OBJECTname = T.TABLE_NAME)\r\n   ),\r\n_Recursive -- Recursive CTE to Get Dependencies\r\nAS (\r\n\t\tSELECT ND.OBJECTschema AS \"SchemaName\", ND.OBJECTname AS \"TableName\", 0 AS \"LVL\", -- Level 0 Indicates Tables with No Dependencies\r\n\t\t\t   CAST(''''['''' + ND.OBJECTschema + ''''].['''' + ND.OBJECTname + ''''] (0)'''' AS VARCHAR(MAX)) AS \"DependsON\"\r\n\t\tFROM _NoDependencies AS ND\r\n\t\tUNION ALL\r\n\t\tSELECT D.OBJECTschema AS \"SchemaName\", D.OBJECTname AS \"TableName\", R.LVL + 1 AS \"LVL\",\r\n\t\t\t   CAST((CASE WHEN LVL > 0 THEN R.DependsON + '''' => '''' ELSE '''''''' END) + (''''['''' + D.DEPENDSschema + ''''].['''' + D.DEPENDSname + ''''] (''''+CAST(R.LVL AS VARCHAR(2))+'''')'''') AS VARCHAR(MAX)) -- Visually Reflects Hierarchy\r\n\t\tFROM _Dependencies AS D\r\n\t\tINNER JOIN _Recursive AS R ON D.DEPENDSschema = R.SchemaName AND D.DEPENDSname = R.TableName\r\n   )\r\nSELECT DISTINCT TOP(100) PERCENT R.SchemaName, R.TableName, R.LVL,\r\n\t   CASE WHEN R.LVL > 0 THEN R.DependsON + '''' => '''' + ''''['''' + R.SchemaName + ''''].['''' + R.TableName + ''''] (''''+CAST(R.LVL AS VARCHAR(2))+'''')'''' ELSE R.DependsON END AS \"DependencyPath\"\r\nFROM _Recursive AS R\r\nORDER BY R.LVL ASC, R.SchemaName ASC, R.TableName ASC\r\nOPTION (MAXRECURSION 0);''';\r\n----$EndRegion: Get Table Hierachy Details Query\r\n--\r\n----$BeginRegion: Get TablesList from @ReferSourceDatabase\r\nSET @SQLcmd = NULL; --Reset Value\r\nSET @SQLcmd = N'EXECUTE ' + QUOTENAME(@@SERVERNAME) + '.' + QUOTENAME(@ReferSourceDatabase) + N'.sys.sp_executesql @command = ' + @SQLquery + ';';\r\nIF @Debug = 1 PRINT '--Get TablesList from @ReferSourceDatabase:' + CHAR(10) + ISNULL(@SQLcmd, 'NULL') + CHAR(10);\r\nINSERT INTO @SourceHierarchyDetails ( SchemaName, TableName, LVL, DependencyPath )\r\nEXECUTE sys.sp_executesql @command = @SQLcmd;\r\nIF @Debug = 1 SELECT @ReferSourceDatabase AS \"DatabaseName\", SchemaName, TableName, LVL, DependencyPath FROM @SourceHierarchyDetails;\r\n----$EndRegion: Get TablesList from @ReferSourceDatabase\r\n--\r\n----$BeginRegion: Get TablesList from @CheckTargetDatabase\r\nSET @SQLcmd = NULL; --Reset Value\r\nSET @SQLcmd = N'EXECUTE ' + QUOTENAME(ISNULL(@LinkedServer, @@SERVERNAME)) + '.' + QUOTENAME(@CheckTargetDatabase) + N'.sys.sp_executesql @command = ' + @SQLquery + ';';\r\nIF @Debug = 1 PRINT '--Get TablesList from @CheckTargetDatabase:' + CHAR(10) + ISNULL(@SQLcmd, 'NULL') + CHAR(10);\r\nINSERT INTO @TargetHierarchyDetails ( SchemaName, TableName, LVL, DependencyPath )\r\nEXECUTE sys.sp_executesql @command = @SQLcmd;\r\nIF @Debug = 1 SELECT @CheckTargetDatabase AS \"DatabaseName\", SchemaName, TableName, LVL, DependencyPath FROM @TargetHierarchyDetails;\r\n----$EndRegion: Get TablesList from @CheckTargetDatabase\r\n--\r\nIF @HierarchyCheck = 1 AND (@SchemaName IS NOT NULL AND @TableName IS NOT NULL)\r\n--$BeginRegion: If @HierarchyCheck is Enabled => Traverses All Posibilites where @SCHname and @TBLname is Involved\r\nBEGIN\r\n\tDELETE FROM #TablesList WHERE 1 = 1; --Reset Table\r\n\tWHILE @SchemaName IS NOT NULL AND @TableName IS NOT NULL\r\n\tBEGIN\r\n\t\tINSERT INTO #TablesList(SCHname, TBLname, LVL, FLG)\r\n\t\tSELECT HD.SchemaName, HD.TableName, MAX(HD.LVL) AS \"LVL\", 0 AS FLG\r\n\t\tFROM (\r\n\t\t\t\tSELECT DISTINCT --HP.SchemaName, HP.TableName, HP.LVL, N.R.value('.', 'varchar(255)'), --\r\n\t\t\t\t\tSUBSTRING(N.R.value('.', 'varchar(255)'), 1, CHARINDEX('].[', N.R.value('.', 'varchar(255)'), 1)) AS \"SchemaName\", --\r\n\t\t\t\t\tSUBSTRING(N.R.value('.', 'varchar(255)'), CHARINDEX('].[', N.R.value('.', 'varchar(255)'), 1) + 2, 255) AS \"TableName\"\r\n\t\t\t\tFROM (\r\n\t\t\t\t\t\tSELECT SchemaName, TableName, LVL, DependencyPath\r\n\t\t\t\t\t\tFROM @SourceHierarchyDetails\r\n\t\t\t\t\t\tWHERE REPLACE(REPLACE(DependencyPath, '[', ''), ']', '') LIKE '%' + ISNULL(@SchemaName, '') + '.' + ISNULL(@TableName + ' (', '') + '%'\r\n\t\t\t\t\t\tUNION\r\n\t\t\t\t\t\tSELECT SchemaName, TableName, LVL, DependencyPath\r\n\t\t\t\t\t\tFROM @TargetHierarchyDetails\r\n\t\t\t\t\t\tWHERE REPLACE(REPLACE(DependencyPath, '[', ''), ']', '') LIKE '%' + ISNULL(@SchemaName, '') + '.' + ISNULL(@TableName + ' (', '') + '%'\r\n\t\t\t\t\t) AS HP\r\n\t\t\t\tCROSS APPLY (SELECT CAST('<r>' + REPLACE(REPLACE(DependencyPath, '&', '&amp;'), ' => ', '</r><r>') + '</r>' AS XML)) AS S(XMLCol)\r\n\t\t\t\tCROSS APPLY S.XMLCol.nodes('r') AS N(R)\r\n\t\t\t ) AS T\r\n\t\tINNER JOIN (SELECT SchemaName, TableName, LVL FROM @SourceHierarchyDetails UNION SELECT SchemaName, TableName, LVL FROM @TargetHierarchyDetails) AS HD \r\n\t\t\tON HD.SchemaName = REPLACE(REPLACE(T.SchemaName, '[', ''), ']', '') \r\n\t\t\t\tAND HD.TableName = REPLACE(REPLACE(SUBSTRING(T.TableName, 1, CHARINDEX('] (', T.TableName, 1)), '[', ''), ']', '')\r\n\t\tWHERE NOT EXISTS (SELECT 1 FROM #TablesList WHERE SCHname = HD.SchemaName AND TBLname = HD.TableName)\r\n\t\tGROUP BY HD.SchemaName, HD.TableName\r\n\t\tORDER BY MAX(HD.LVL) ASC, HD.SchemaName ASC, HD.TableName ASC;\r\n\t\t--\r\n\t\tUPDATE #TablesList SET FLG = 1 WHERE SCHname = @SchemaName AND TBLname = @TableName;\r\n\t\tSELECT @SchemaName = NULL, @TableName = NULL;\r\n\t\tSELECT TOP (1) @SchemaName = SCHname, @TableName = TBLname FROM #TablesList WHERE FLG = 0 ORDER BY FLG;\r\n\tEND;\r\nEND;\r\n--$EndRegion: If @HierarchyCheck is Enabled => Traverses All Posibilites where @SCHname and @TBLname is Involved\r\nELSE --IF @HierarchyCheck = 0\r\n--$BeginRegion: If @HierarchyCheck is Disabled\r\nBEGIN\r\n\tDELETE FROM #TablesList WHERE 1 = 1; --Reset Table\r\n\tINSERT INTO #TablesList(SCHname, TBLname, LVL)\r\n\tSELECT TL.SchemaName, TL.TableName, MAX(TL.LVL)\r\n\tFROM (\r\n\t\t\tSELECT S.SchemaName, S.TableName, S.LVL\r\n\t\t\tFROM @SourceHierarchyDetails AS S\r\n\t\t\tWHERE (S.SchemaName = @SchemaName OR @SchemaName IS NULL) AND (S.TableName = @TableName OR @TableName IS NULL)\r\n\t\t\tUNION\r\n\t\t\tSELECT T.SchemaName, T.TableName, T.LVL\r\n\t\t\tFROM @TargetHierarchyDetails AS T\r\n\t\t\tWHERE (T.SchemaName = @SchemaName OR @SchemaName IS NULL) AND (T.TableName = @TableName OR @TableName IS NULL)\r\n\t\t ) AS TL\r\n\tGROUP BY TL.SchemaName, TL.TableName;\r\nEND;\r\n--$EndRegion: If @HierarchyCheck is Disabled\r\n--\r\nIF @Debug = 1 SELECT SCHname, TBLname, LVL FROM #TablesList ORDER BY LVL ASC, SCHname ASC, TBLname ASC;\r\n--$EndRegion: Get TablesList from @ReferSourceDatabase UNION @CheckTargetDatabase\r\n--\r\n--$BeginRegion: PreRequisites\r\nIF OBJECT_ID('tempdb..#COMPARISONTABLE', 'U') IS NOT NULL\r\n\tDROP TABLE #COMPARISONTABLE;\r\n--\r\nCREATE TABLE #COMPARISONTABLE\r\n(\r\n\tSchemaName VARCHAR(128) NULL, TableName VARCHAR(128) NULL, LVL INT NULL,\r\n\tSourceRowCount INT NULL, TargetRowCount INT NULL, RowsDEL INT NULL, RowsINS INT NULL, RowsUPD INT NULL,\r\n\tValidateQueryV1 VARCHAR(MAX) NULL,\t--Most Preferred to Check RowsINS or RowsDEL\r\n\tValidateQueryV2 VARCHAR(MAX) NULL,\t--Most Preferred to Check RowsUPD\r\n\tRemarks VARCHAR(MAX) NULL DEFAULT (''), --Errors will be Recorded If Any\r\n\tMergeQueryFromSourceToTarget VARCHAR(MAX) NULL,\r\n\tMergeQueryFromTargetToSource VARCHAR(MAX) NULL\r\n);\r\n--\r\nDECLARE @TableColumns TABLE\r\n(\r\n\tColID INT NULL, --ORDINAL_POSITION\r\n\tColumnName VARCHAR(128) NULL,\r\n\tColumnDataType VARCHAR(64) NULL,\r\n\tIsPrimaryKeyCol BIT NULL,\r\n\tIsComputedCol BIT NULL,\r\n\tIsIdentityCol BIT NULL\r\n);\r\n--\r\nDECLARE @TotalColumns INT, @TotalPKcols INT, @ExclusivePKcols INT, @ExclusiveIDcols INT, @IDasPKcols INT;\r\n--\r\nDECLARE @MatchColumns AS TABLE\r\n(\r\n\tColID INT NULL,\r\n\tColumnName VARCHAR(128) NULL\r\n);\r\n--\r\nDECLARE @SelColListV1S VARCHAR(MAX), @SelColListV1T VARCHAR(MAX), @SelColListV2 VARCHAR(MAX);\r\nDECLARE @ON_MatchedColList VARCHAR(MAX), @WhereColList AS VARCHAR(MAX), @WHERE_UnMatchedColList VARCHAR(MAX);\r\nDECLARE @UpdateColumnList VARCHAR(MAX);\r\nDECLARE @InsertColumnList VARCHAR(MAX), @InsertValueList VARCHAR(MAX);\r\n--$EndRegion: PreRequisites\r\n--\r\n--$BeginRegion: Cursor for Each Table\r\nDECLARE @SCHname VARCHAR(128), @TBLname VARCHAR(128), @LVL INT, @RowCount INT;\r\nDECLARE TableCursor CURSOR LOCAL FAST_FORWARD FOR SELECT SCHname, TBLname, LVL FROM #TablesList ORDER BY LVL ASC, SCHname ASC, TBLname ASC;\r\nOPEN TableCursor;\r\nFETCH NEXT FROM TableCursor INTO @SCHname, @TBLname, @LVL;\r\nWHILE @@FETCH_STATUS = 0\r\nBEGIN\r\n\tBEGIN TRY\r\n\t\tSET @SQLcmd = NULL; SET @ErrMsg = NULL; --Reset Value\r\n\t\tIF @Debug = 1  PRINT '/*** Debug Print Comments For @Schema: \"' + @SCHname + '\" and @Table: \"' + @TBLname + '\" ***/' + CHAR(10);\r\n\t\t--\r\n\t\tINSERT INTO #COMPARISONTABLE (SchemaName, TableName, LVL) VALUES (@SCHname, @TBLname, @LVL);\r\n\t\t--\r\n\t\t--$BeginRegion: Getting Table Columns In Detail w.r.to @SCHname and @TBLname\r\n\t\tDELETE @TableColumns WHERE 1 = 1; --Reset Table\r\n\t\t--\r\n\t\tSET @SQLquery = NULL; --Reset Value\r\n\t\tSET @SQLquery = N'N''SELECT DISTINCT COL.column_id, COL.name, ISC.DATA_TYPE, ISNULL(PKC.Is_PK, 0), COL.is_computed, COL.is_identity\r\n\t\tFROM sys.columns AS COL\r\n\t\tINNER JOIN sys.tables AS TBL ON TBL.object_id = COL.object_id\r\n\t\tINNER JOIN sys.schemas AS SCH ON SCH.schema_id = TBL.schema_id\r\n\t\tINNER JOIN INFORMATION_SCHEMA.COLUMNS AS ISC ON ISC.TABLE_SCHEMA = SCH.name AND ISC.TABLE_NAME = TBL.name AND ISC.COLUMN_NAME = COL.name\r\n\t\tLEFT JOIN (\r\n\t\t\t\t\tSELECT IC.object_id, IC.column_id, 1 AS \"Is_PK\"\r\n\t\t\t\t\tFROM sys.index_columns AS IC\r\n\t\t\t\t\tINNER JOIN sys.key_constraints AS KC ON IC.object_id = KC.parent_object_id AND IC.index_id = KC.unique_index_id AND KC.type = ''''PK''''\r\n\t\t\t\t  ) AS PKC ON PKC.column_id = COL.column_id AND PKC.object_id = COL.object_id\r\n\t\tWHERE SCH.name = ''''' + @SCHname + ''''' AND TBL.name = ''''' + @TBLname + '''''\r\n\t\tORDER BY COL.column_id ASC;''';\r\n\t\t--\r\n\t\tSET @SQLcmd = NULL; --Reset Value\r\n\t\tSET @SQLcmd = N'EXECUTE ' + QUOTENAME(@@SERVERNAME) + '.' + QUOTENAME(@ReferSourceDatabase) + N'.sys.sp_executesql @command = ' + @SQLquery + ';';\r\n\t\tIF @Debug = 1 PRINT '--Getting Table Columns In Detail w.r.to @SCHname and @TBLname:' + CHAR(10) + ISNULL(@SQLcmd, 'NULL') + CHAR(10);\r\n\t\tINSERT INTO @TableColumns(ColID, ColumnName, ColumnDataType, IsPrimaryKeyCol, IsComputedCol, IsIdentityCol)\r\n\t\tEXECUTE sys.sp_executesql @command = @SQLcmd;\r\n\t\t--\r\n\t\tSELECT @TotalColumns = 0, @TotalPKcols = 0, @ExclusivePKcols = 0, @ExclusiveIDcols = 0, @IDasPKcols = 0; --Reset Values\r\n\t\tSELECT @TotalColumns = COUNT(*) FROM @TableColumns;\r\n\t\tSELECT @TotalPKcols = COUNT(*) FROM @TableColumns WHERE IsPrimaryKeyCol = 1;\r\n\t\tSELECT @ExclusivePKcols = COUNT(*) FROM @TableColumns WHERE IsPrimaryKeyCol = 1 AND IsIdentityCol= 0;\r\n\t\tSELECT @ExclusiveIDcols = COUNT(*) FROM @TableColumns WHERE IsPrimaryKeyCol = 0 AND IsIdentityCol = 1;\r\n\t\tSELECT @IDasPKcols = COUNT(*) FROM @TableColumns WHERE IsPrimaryKeyCol = 1 AND IsIdentityCol = 1;\r\n\t\t--\r\n\t\t--$BeginRegion: Exceptional Case Remarks\r\n\t\tUPDATE #COMPARISONTABLE\r\n\t\tSET Remarks = Remarks\r\n\t\t\t+ CASE\r\n\t\t\t\tWHEN (@ExclusivePKcols + @ExclusiveIDcols + @IDasPKcols) = @TotalColumns AND (@ExclusiveIDcols + @IDasPKcols) = 0 \r\n\t\t\t\t\tTHEN '/** Table Contains All Columns as PrimaryKey Columns Only **/'\r\n\t\t\t\tWHEN (@ExclusivePKcols + @ExclusiveIDcols + @IDasPKcols) = @TotalColumns AND (@ExclusiveIDcols + @IDasPKcols) = 1 AND @ExclusiveIDcols = 0 AND @IDasPKcols = 1\r\n\t\t\t\t\tTHEN '/** Table Contains All Columns as PrimaryKey Columns in which One of the PrimaryKey Column is an IdentityKey Column **/'\r\n\t\t\t\tWHEN (@ExclusivePKcols + @ExclusiveIDcols + @IDasPKcols) = @TotalColumns AND (@ExclusiveIDcols + @IDasPKcols) = 1 AND @ExclusiveIDcols = 1 AND @IDasPKcols = 0\r\n\t\t\t\t\tTHEN '/** Table Contains All Columns with Both Exclusive PrimaryKey Columns and Exclusive IdentityKey Column **/'\r\n\t\t\t\tWHEN (@ExclusivePKcols = 0 AND @IDasPKcols = 0 AND @ExclusiveIDcols = 0)\r\n\t\t\t\t\tTHEN '/** Heap Table - DoesNot Contain Both PrimaryKey Columns and IdentityKey Column **/'\r\n\t\t\t\tELSE '' END\r\n\t\tWHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\t--$EndRegion: Exceptional Case Remarks\r\n\t\t--\r\n\t\tIF @Debug = 1\r\n\t\tBEGIN\r\n\t\t\tSELECT @SCHname AS \"@SCHname\", @TBLname AS \"@TBLname\", TC.ColID, TC.ColumnName, TC.ColumnDataType, TC.IsPrimaryKeyCol, TC.IsComputedCol, TC.IsIdentityCol \r\n\t\t\tFROM @TableColumns AS TC;\r\n\t\t\t--\r\n\t\t\tSELECT @SCHname AS \"@SCHname\", @TBLname AS \"@TBLname\", @TotalColumns AS \"@TotalColumns\", @TotalPKcols AS \"@TotalPKcols\", @ExclusivePKcols AS \"@ExclusivePKcols\", @ExclusiveIDcols AS \"@ExclusiveIDcols\", @IDasPKcols AS \"@IDasPKcols\",\r\n\t\t\tCASE WHEN (@ExclusivePKcols + @ExclusiveIDcols + @IDasPKcols) = @TotalColumns AND (@ExclusiveIDcols + @IDasPKcols) = 0 \r\n\t\t\t\t\tTHEN '/** Table Contains All Columns as PrimaryKey Columns Only **/'\r\n\t\t\t\t WHEN (@ExclusivePKcols + @ExclusiveIDcols + @IDasPKcols) = @TotalColumns AND (@ExclusiveIDcols + @IDasPKcols) = 1 AND @ExclusiveIDcols = 0 AND @IDasPKcols = 1\r\n\t\t\t\t\tTHEN '/** Table Contains All Columns as PrimaryKey Columns in which One of the PrimaryKey Column is an IdentityKey Column **/'\r\n\t\t\t\t WHEN (@ExclusivePKcols + @ExclusiveIDcols + @IDasPKcols) = @TotalColumns AND (@ExclusiveIDcols + @IDasPKcols) = 1 AND @ExclusiveIDcols = 1 AND @IDasPKcols = 0\r\n\t\t\t\t\tTHEN '/** Table Contains All Columns with Both Exclusive PrimaryKey Columns and Exclusive IdentityKey Column **/'\r\n\t\t\t\t WHEN (@ExclusivePKcols = 0 AND @IDasPKcols = 0 AND @ExclusiveIDcols = 0)\r\n\t\t\t\t\tTHEN '/** Heap Table - DoesNot Contain Both PrimaryKey Columns and IdentityKey Column **/'\r\n\t\t\t\t ELSE '' END AS Remarks;\r\n\t\tEND;\r\n\t\t--$EndRegion: Getting Table Columns In Detail w.r.to @SCHname and @TBLname\r\n\t\t--\r\n\t\t--$BeginRegion: Identifying Columns for ON - WHERE Conditions Clauses\r\n\t\tDELETE FROM @MatchColumns WHERE 1=1; --Reset Table\r\n\t\tIF EXISTS (SELECT * FROM @TableColumns WHERE IsPrimaryKeyCol = 1 OR IsIdentityCol = 1)\r\n\t\tBEGIN\r\n\t\t\tINSERT INTO @MatchColumns (ColID, ColumnName)\r\n\t\t\tSELECT ColID, ColumnName FROM @TableColumns WHERE IsPrimaryKeyCol = 1 OR IsIdentityCol = 1;\r\n\t\tEND;\r\n\t\t----$BeginRegion: Coalesce ON_MatchedColList\r\n\t\tSET @ON_MatchedColList = NULL; --Reset Value\r\n\t\tIF EXISTS (SELECT * FROM @MatchColumns)\r\n\t\t\tBEGIN\r\n\t\t\t\tSELECT @ON_MatchedColList = COALESCE(@ON_MatchedColList + ' AND T.[' + ColumnName + '] = S.[' + ColumnName + ']', 'T.[' + ColumnName + '] = S.[' + ColumnName + ']')\r\n\t\t\t\tFROM @MatchColumns;\r\n\t\t\tEND;\r\n\t\tELSE\r\n\t\t\tSET @ON_MatchedColList = 'T.<TargetColumnName> = S.<SourceColumnName>';\r\n\t\t--\r\n\t\tIF @Debug = 1 PRINT '--@ON_MatchedColList: ' + ISNULL(@ON_MatchedColList, 'NULL') + CHAR(10);\r\n\t\t----$EndRegion: Coalesce ON_MatchedColList\r\n\t\t--\r\n\t\t----$BeginRegion: Coalesce WHERE_UnMatchedColList\r\n\t\tSET @WHERE_UnMatchedColList = NULL; --Reset Value\r\n\t\tSELECT @WHERE_UnMatchedColList = COALESCE(@WHERE_UnMatchedColList +\r\n\t\t\tCASE\r\n\t\t\t\tWHEN ColumnDataType IN ('xml', 'text', 'uniqueidentifier', 'geography', 'hierarchyid')\r\n\t\t\t\t\tTHEN ' OR ISNULL(CONVERT(NVARCHAR(MAX), T.[' + ColumnName + '])COLLATE DATABASE_DEFAULT, '''') != ISNULL(CONVERT(NVARCHAR(MAX), S.[' + ColumnName + '])COLLATE DATABASE_DEFAULT, '''')'\r\n\t\t\t\tWHEN ColumnDataType IN ('varbinary', 'decimal')\r\n\t\t\t\t\tTHEN ' OR ISNULL(T.[' + ColumnName + '], 0) != ISNULL(S.[' + ColumnName + '], 0)'\r\n\t\t\t\tELSE ' OR ISNULL(T.[' + ColumnName + '], '''') != ISNULL(S.[' + ColumnName + '], '''')' END,\r\n\t\t\tCASE\r\n\t\t\t\tWHEN ColumnDataType IN ('xml', 'text', 'uniqueidentifier', 'geography', 'hierarchyid')\r\n\t\t\t\t\tTHEN 'ISNULL(CONVERT(NVARCHAR(MAX), T.[' + ColumnName + '])COLLATE DATABASE_DEFAULT, '''') != ISNULL(CONVERT(NVARCHAR(MAX), S.[' + ColumnName + '])COLLATE DATABASE_DEFAULT, '''')'\r\n\t\t\t\tWHEN ColumnDataType IN ('varbinary', 'decimal')\r\n\t\t\t\t\tTHEN 'ISNULL(T.[' + ColumnName + '], 0) != ISNULL(S.[' + ColumnName + '], 0)'\r\n\t\t\t\tELSE 'ISNULL(T.[' + ColumnName + '], '''') != ISNULL(S.[' + ColumnName + '], '''')' END)\r\n\t\tFROM @TableColumns\r\n\t\tWHERE ColumnName NOT IN ( SELECT ColumnName FROM @MatchColumns ) --Exclude PrimaryKey Columns and IdentityKey Column\r\n\t\t\tAND IsComputedCol <> 1 --Exclude Computed Columns\r\n\t\tORDER BY ColID ASC;\r\n\t\t--\r\n\t\tIF @Debug = 1 PRINT '--@WHERE_UnMatchedColList: ' + ISNULL(@WHERE_UnMatchedColList, 'NULL') + CHAR(10);\r\n\t\t----$EndRegion: Coalesce WHERE_UnMatchedColList\r\n\t\t--$EndRegion: Identifying Columns for ON - WHERE Conditions Clauses\r\n\t\t--\r\n\t\t--$BeginRegion: Getting Actual Manipulated Rows Count\r\n\t\t----$BeginRegion: SourceRowCount from @ReferSourceDatabase Table\r\n\t\tSET @SQLcmd = NULL; SET @RowCount = NULL; --Reset Value\r\n\t\tSET @SQLcmd = N'SELECT @RowCountOUT = COUNT(*) FROM [' + @@SERVERNAME + '].[' + @ReferSourceDatabase + '].[' + @SCHname + '].[' + @TBLname + '];';\r\n\t\tIF @Debug = 1 PRINT '--SourceRowCount from @ReferSourceDatabase Table:' + CHAR(10) + ISNULL(@SQLcmd, 'NULL') + CHAR(10);\r\n\t\tBEGIN TRY\r\n\t\t\tEXECUTE sys.sp_executesql @Command = @SQLcmd, @Param = N'@RowCountOUT INT OUTPUT', @RowCountOUT = @RowCount OUTPUT;\r\n\t\t\tUPDATE #COMPARISONTABLE SET SourceRowCount = @RowCount WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\tEND TRY\r\n\t\tBEGIN CATCH\r\n\t\t\tSET @ErrMsg = NULL; SET @ErrMsg = ERROR_MESSAGE(); --Reset Value\r\n\t\t\tUPDATE #COMPARISONTABLE SET Remarks = @ErrMsg WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\t\tIF @Debug = 1 PRINT '--* ' + @ErrMsg + CHAR(10);\r\n\t\tEND CATCH;\r\n\t\t----$EndRegion: SourceRowCount from @ReferSourceDatabase Table\r\n\t\t--\r\n\t\t----$BeginRegion: TargetRowCount from @CheckTargetDatabase Table\r\n\t\tSET @SQLcmd = NULL; SET @RowCount = NULL; --Reset Value\r\n\t\tSET @SQLcmd = N'SELECT @RowCountOUT = COUNT(*) FROM [' + ISNULL(@LinkedServer, @@SERVERNAME) + '].[' + @CheckTargetDatabase + '].[' + @SCHname + '].[' + @TBLname + '];';\r\n\t\tIF @Debug = 1 PRINT '--TargetRowCount from @CheckTargetDatabase Table:' + CHAR(10) + ISNULL(@SQLcmd, 'NULL') + CHAR(10);\r\n\t\tBEGIN TRY\r\n\t\t\tEXECUTE sys.sp_executesql @Command = @SQLcmd, @Param = N'@RowCountOUT INT OUTPUT', @RowCountOUT = @RowCount OUTPUT;\r\n\t\t\tUPDATE #COMPARISONTABLE SET TargetRowCount = @RowCount WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\tEND TRY\r\n\t\tBEGIN CATCH\r\n\t\t\tSET @ErrMsg = NULL; SET @ErrMsg = ERROR_MESSAGE();\r\n\t\t\tUPDATE #COMPARISONTABLE SET Remarks = @ErrMsg WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\t\tIF @Debug = 1 PRINT '--* ' + @ErrMsg + CHAR(10);\r\n\t\tEND CATCH;\r\n\t\t----$EndRegion: TargetRowCount from @CheckTargetDatabase Table\r\n\t\t--\r\n\t\tSET @WhereColList = NULL; --Reset Value\r\n\t\tSELECT @WhereColList = COALESCE(@WhereColList + ' AND [' + ColumnName + '] IS NULL', '[' + ColumnName + '] IS NULL') FROM @MatchColumns;\r\n\t\t----$BeginRegion: Actual Rows Deleted From @CheckTargetDatabase Table\r\n\t\tSET @SQLcmd = NULL; SET @RowCount = NULL; --Reset Value\r\n\t\tSET @SQLcmd = N'SELECT @RowCountOUT = COUNT(*) FROM [' + @@SERVERNAME + '].[' + @ReferSourceDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS S' + CHAR(10)--\r\n\t\t\t\t\t+ N'FULL OUTER JOIN [' + ISNULL(@LinkedServer, @@SERVERNAME) + '].[' + @CheckTargetDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS T' + CHAR(10)--\r\n\t\t\t\t\t+ N'\tON ' + @ON_MatchedColList + CHAR(10)--\r\n\t\t\t\t\t+ N'WHERE ' + REPLACE(@WhereColList, '[', 'T.[') + ';';\r\n\t\tIF @Debug = 1 PRINT '--Actual Rows Deleted From @CheckTargetDatabase Table:' + CHAR(10) + ISNULL(@SQLcmd, 'NULL') + CHAR(10);\r\n\t\tBEGIN TRY\r\n\t\t\tEXECUTE sys.sp_executesql @Command = @SQLcmd, @Param = N'@RowCountOUT INT OUTPUT', @RowCountOUT = @RowCount OUTPUT;\r\n\t\t\tUPDATE #COMPARISONTABLE SET RowsDEL = @RowCount WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\tEND TRY\r\n\t\tBEGIN CATCH\r\n\t\t\tSET @ErrMsg = NULL; SET @ErrMsg = ERROR_MESSAGE(); --Reset Value\r\n\t\t\tUPDATE #COMPARISONTABLE SET Remarks = @ErrMsg WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\t\tIF @Debug = 1 PRINT '--* ' + @ErrMsg + CHAR(10);\r\n\t\tEND CATCH;\r\n\t\t----$EndRegion: Actual Rows Deleted From @CheckTargetDatabase Table\r\n\t\t--\r\n\t\t----$BeginRegion: Actual Rows Inserted Into @CheckTargetDatabase Table\r\n\t\tSET @SQLcmd = NULL; SET @RowCount = NULL; --Reset Value\r\n\t\tSET @SQLcmd = N'SELECT @RowCountOUT = COUNT(*) FROM [' + @@SERVERNAME + '].[' + @ReferSourceDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS S' + CHAR(10)--\r\n\t\t\t\t\t+ N'FULL OUTER JOIN [' + ISNULL(@LinkedServer, @@SERVERNAME) + '].[' + @CheckTargetDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS T' + CHAR(10)--\r\n\t\t\t\t\t+ N'\tON ' + @ON_MatchedColList + CHAR(10)--\r\n\t\t\t\t\t+ N'WHERE ' + REPLACE(@WhereColList, '[', 'S.[') + ';';\r\n\t\tIF @Debug = 1 PRINT '--Actual Rows Inserted Into @CheckTargetDatabase Table:' + CHAR(10) + ISNULL(@SQLcmd, 'NULL') + CHAR(10);\r\n\t\tBEGIN TRY\r\n\t\t\tEXECUTE sys.sp_executesql @Command = @SQLcmd, @Param = N'@RowCountOUT INT OUTPUT', @RowCountOUT = @RowCount OUTPUT;\r\n\t\t\tUPDATE #COMPARISONTABLE SET RowsINS = @RowCount WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\tEND TRY\r\n\t\tBEGIN CATCH\r\n\t\t\tSET @ErrMsg = NULL; SET @ErrMsg = ERROR_MESSAGE(); --Reset Value\r\n\t\t\tUPDATE #COMPARISONTABLE SET Remarks = @ErrMsg WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\t\tIF @Debug = 1 PRINT '--* ' + @ErrMsg + CHAR(10);\r\n\t\tEND CATCH;\r\n\t\t----$EndRegion: Actual Rows Inserted Into @CheckTargetDatabase Table\r\n\t\t--\r\n\t\t----$BeginRegion: Actual Rows Updated In @CheckTargetDatabase Table\r\n\t\tSET @SQLcmd = NULL; SET @RowCount = NULL; --Reset Value\r\n\t\tSET @SQLcmd = N'SELECT @RowCountOUT = COUNT(*) FROM [' + @@SERVERNAME + '].[' + @ReferSourceDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS S ' + CHAR(10)--\r\n\t\t\t\t\t+ N'INNER JOIN [' + ISNULL(@LinkedServer, @@SERVERNAME) + '].[' + @CheckTargetDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS T ' + CHAR(10)--\r\n\t\t\t\t\t+ N'\tON ' + @ON_MatchedColList + ' ' + CHAR(10)--\r\n\t\t\t\t\t+ N'WHERE ' + @WHERE_UnMatchedColList + ';';\r\n\t\tIF @Debug = 1 PRINT '--Actual Rows Updated In @CheckTargetDatabase Table:' + CHAR(10) + ISNULL(@SQLcmd, 'NULL') + CHAR(10);\r\n\t\tBEGIN TRY\r\n\t\t\tEXECUTE sys.sp_executesql @Command = @SQLcmd, @Param = N'@RowCountOUT INT OUTPUT', @RowCountOUT = @RowCount OUTPUT;\r\n\t\t\tUPDATE #COMPARISONTABLE SET RowsUPD = @RowCount WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\tEND TRY\r\n\t\tBEGIN CATCH\r\n\t\t\tSET @ErrMsg = NULL; SET @ErrMsg = ERROR_MESSAGE(); --Reset Value\r\n\t\t\tIF (@ExclusivePKcols = 0 AND @IDasPKcols = 0 AND @ExclusiveIDcols = 0) --Exclusing Heap Tables\r\n\t\t\t\tSET @ErrMsg = '/** Heap Table - DoesNot Contain Both PrimaryKey Columns and IdentityKey Column **/';\r\n\t\t\tUPDATE #COMPARISONTABLE SET Remarks = @ErrMsg WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\t\tIF @Debug = 1 PRINT '--* ' + @ErrMsg + CHAR(10);\r\n\t\t\tIF (@ExclusivePKcols = 0 AND @IDasPKcols = 0 AND @ExclusiveIDcols = 0) SET @ErrMsg = NULL; --Reset @ErrMsg to Generate Statements for Heap Tables\r\n\t\tEND CATCH;\r\n\t\t----$EndRegion: Actual Rows Updated In @CheckTargetDatabase Table\r\n\t\t--$EndRegion: Getting Actual Manipulated Rows Count\r\n\t\t--\r\n\t\t--$BeginRegion: Generating ValidateQueries V1 and V2\r\n\t\t----$BeginRegion: Generating ValidateQuery V1 w.r.to @SCH and @TBL\r\n\t\tSET @SQLcmd = NULL; SET @SelColListV1S = NULL; SET @SelColListV1T = NULL; --Reset Value\r\n\t\tSELECT\t@SelColListV1S = COALESCE(@SelColListV1S + ', S.[' + ColumnName + ']', 'S.[' + ColumnName + ']'),\r\n\t\t\t\t@SelColListV1T = COALESCE(@SelColListV1T + ', T.[' + ColumnName + ']', 'T.[' + ColumnName + ']')\r\n\t\tFROM @TableColumns\r\n\t\tORDER BY ColID ASC;\r\n\t\tIF @Debug = 1 PRINT '--@SelColListV1S: ' + @SelColListV1S + CHAR(10) + '--@SelColListV1T: ' + @SelColListV1T + CHAR(10);\r\n\t\t--\r\n\t\tSET @SQLcmd = N'SELECT ''' + @SCHname + '.' + @TBLname + ''' AS \"TableName\", ' + @SelColListV1S + ', ' + '''|'' AS \"O\", ' + @SelColListV1T + CHAR(10)--\r\n\t\t\t\t\t+ N'FROM [' + @@SERVERNAME + '].[' + @ReferSourceDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS S ' + CHAR(10)--\r\n\t\t\t\t\t+ N'FULL OUTER JOIN [' + ISNULL(@LinkedServer, @@SERVERNAME) + '].[' + @CheckTargetDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS T ' + CHAR(10)--\r\n\t\t\t\t\t+ N'\tON ' + @ON_MatchedColList + CHAR(10)--\r\n\t\t\t\t\t+ CASE WHEN @WHERE_UnMatchedColList IS NOT NULL THEN N'WHERE /*1 = 1 OR*/ ' + @WHERE_UnMatchedColList ELSE '' END + ';';\r\n\t\tIF @Debug = 1 PRINT '--ValidateQuery V1 w.r.to @SCH and @TBL:' + CHAR(10) + ISNULL(@SQLcmd, 'NULL') + CHAR(10);\r\n\t\tUPDATE #COMPARISONTABLE SET ValidateQueryV1 = @SQLcmd WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\t----$EndRegion: Generating ValidateQuery V1 w.r.to @SCH and @TBL\r\n\t\t--\r\n\t\t----$BeginRegion: Generating ValidateQuery V2 w.r.to @SCH and @TBL\r\n\t\tSET @SQLcmd = NULL; SET @SelColListV2 = NULL; --Reset Value\r\n\t\tSELECT @SelColListV2 = COALESCE(@SelColListV2 + ', S.[' + ColumnName + '], T.[' + ColumnName + ']', 'S.[' + ColumnName + '], T.[' + ColumnName + ']')\r\n\t\tFROM @TableColumns\r\n\t\tORDER BY ColID ASC;\r\n\t\tIF @Debug = 1 PRINT '--@SelColListV2: ' + @SelColListV2 + CHAR(10);\r\n\t\t--\r\n\t\tSET @SQLcmd = N'SELECT ''' + @SCHname + '.' + @TBLname + ''' AS \"TableName\", ' + @SelColListV2 + CHAR(10)--\r\n\t\t\t\t\t+ N'FROM [' + @@SERVERNAME + '].[' + @ReferSourceDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS S ' + CHAR(10)--\r\n\t\t\t\t\t+ N'FULL OUTER JOIN [' + ISNULL(@LinkedServer, @@SERVERNAME) + '].[' + @CheckTargetDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS T ' + CHAR(10)--\r\n\t\t\t\t\t+ N'\tON ' + @ON_MatchedColList + CHAR(10)--\r\n\t\t\t\t\t+ CASE WHEN @WHERE_UnMatchedColList IS NOT NULL THEN N'WHERE /*1 = 1 OR*/ ' + @WHERE_UnMatchedColList ELSE '' END + ';';\r\n\t\tIF @Debug = 1 PRINT '--ValidateQuery V2 w.r.to @SCH and @TBL:' + CHAR(10) + ISNULL(@SQLcmd, 'NULL') + CHAR(10);\r\n\t\tUPDATE #COMPARISONTABLE SET ValidateQueryV2 = @SQLcmd WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\t----$EndRegion: Generating ValidateQuery V2 w.r.to @SCH and @TBL\r\n\t\t--$EndRegion: Generating ValidateQueries V1 and V2\r\n\t\t--\r\n\t\tIF @ErrMsg IS NULL\r\n\t\tBEGIN\r\n\t\t--$BeginRegion: Generating Merge Statements\r\n\t\t----$BeginRegion: Coalesce @UpdateColumnList\r\n\t\tSET @UpdateColumnList = NULL; --Reset Value\r\n\t\tSELECT @UpdateColumnList = COALESCE(@UpdateColumnList +\r\n\t\t\tCASE WHEN ColumnDataType IN ('xml', 'text') THEN ', T.[' + ColumnName + '] = CONVERT(NVARCHAR(MAX), S.[' + ColumnName + '])COLLATE DATABASE_DEFAULT'\r\n\t\t\t\tELSE ', T.[' + ColumnName + '] = S.[' + ColumnName + ']' END,\r\n\t\t\tCASE WHEN ColumnDataType IN ('xml', 'text') THEN 'T.[' + ColumnName + '] = CONVERT(NVARCHAR(MAX), S.[' + ColumnName + '])COLLATE DATABASE_DEFAULT'\r\n\t\t\t\tELSE 'T.[' + ColumnName + '] = S.[' + ColumnName + ']' END)\r\n\t\tFROM @TableColumns\r\n\t\tWHERE ColumnName NOT IN ( SELECT ColumnName FROM @MatchColumns ) --Exclude PrimaryKey Columns and IdentityKey Column\r\n\t\t\tAND IsComputedCol <> 1 --Exclude Computed Columns\r\n\t\tORDER BY ColID ASC;\r\n\t\tIF @Debug = 1 PRINT '--@UpdateColumnList: ' + @UpdateColumnList + CHAR(10);\r\n\t\t----$EndRegion: Coalesce @UpdateColumnList\r\n\t\t--\r\n\t\t----$BeginRegion: Coalesce @InsertColumnList\r\n\t\tSET @InsertColumnList = NULL; --Reset Value\r\n\t\tSELECT @InsertColumnList = COALESCE(@InsertColumnList + ', [' + ColumnName + ']', '[' + ColumnName + ']')\r\n\t\tFROM @TableColumns\r\n\t\tWHERE IsComputedCol <> 1 --Exclude Computed Columns\r\n\t\tORDER BY ColID ASC;\r\n\t\tIF @Debug = 1 PRINT '--@InsertColumnList: ' + @InsertColumnList + CHAR(10);\r\n\t\t----$EndRegion: Coalesce @InsertColumnList\r\n\t\t--\r\n\t\t----$BeginRegion: Coalesce @InsertValueList\r\n\t\tSET @InsertValueList = NULL; --Reset Value\r\n\t\tSELECT @InsertValueList = COALESCE(@InsertValueList +\r\n\t\t\tCASE WHEN ColumnDataType IN ('xml', 'text') THEN ', CONVERT(NVARCHAR(MAX), S.[' + ColumnName + '])COLLATE DATABASE_DEFAULT' ELSE ', S.[' + ColumnName + ']' END,\r\n\t\t\tCASE WHEN ColumnDataType IN ('xml', 'text') THEN 'CONVERT(NVARCHAR(MAX), S.[' + ColumnName + '])COLLATE DATABASE_DEFAULT' ELSE 'S.[' + ColumnName + ']' END)\r\n\t\tFROM @TableColumns\r\n\t\tWHERE IsComputedCol <> 1 --Exclude Computed Columns\r\n\t\tORDER BY ColID ASC;\r\n\t\tIF @Debug = 1 PRINT '--@InsertValueList: ' + @InsertValueList + CHAR(10);\r\n\t\t----$EndRegion: Coalesce @InsertValueList\r\n\t\t--\r\n\t\tIF (@IncludeDelete = 1 OR @IncludeInsert = 1 OR @IncludeUpdate = 1)\r\n\t\tBEGIN\r\n\t\t\t----$BeginRegion: Generating Query for MergeDataFromSourceToTarget\r\n\t\t\tSET @SQLcmd = ''; --Reset Value (Empty String to Append All Text Immediately)\r\n\t\t\t--\r\n\t\t\tIF @IncludeInsert = 1\r\n\t\t\t\tIF EXISTS (SELECT * FROM @TableColumns WHERE IsIdentityCol = 1)\r\n\t\t\t\t\tSET @SQLcmd = @SQLcmd + N'SET IDENTITY_INSERT [' + @CheckTargetDatabase + '].[' + @SCHname + '].[' + @TBLname + '] ON;' + CHAR(10);\r\n\t\t\t--\r\n\t\t\tIF ((@ExclusivePKcols > 0 OR @IDasPKcols > 0) AND @ExclusiveIDcols = 0) --Table have PrimaryKey Columns in which One PK column might be IdentityKey Column\r\n\t\t\t OR (@ExclusivePKcols = 0 AND @IDasPKcols = 0 AND @ExclusiveIDcols = 1) --Table doesnot have PrimaryKey Columns but have IdentityKey Column\r\n\t\t\t OR (@ExclusivePKcols = 0 AND @IDasPKcols = 0 AND @ExclusiveIDcols = 0) --Heap Tables\r\n\t\t\tBEGIN\r\n\t\t\t\t--$BeginRegion: Applicable for (Tables which has PrimaryKey Columns (or) ONE of PrimaryKey Columns might be IdentityKey Column) OR (Heap Tables)\r\n\t\t\t\t----Here, One Merge Statement is Enough to Sync Data From Source To Target\r\n\t\t\t\tSET @SQLcmd = @SQLcmd\r\n\t\t\t\t\t\t\t+ N'MERGE INTO [' + ISNULL(@LinkedServer, @@SERVERNAME) + '].[' + @CheckTargetDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS T' + CHAR(10)--\r\n\t\t\t\t\t\t\t+ N'USING [' + @@SERVERNAME + '].[' + @ReferSourceDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS S' + CHAR(10)--\r\n\t\t\t\t\t\t\t+ N'\tON ' + @ON_MatchedColList + CHAR(10);\r\n\t\t\t\tIF @IncludeUpdate = 1 AND @WHERE_UnMatchedColList IS NOT NULL AND @UpdateColumnList IS NOT NULL\r\n\t\t\t\t\tSET @SQLcmd = @SQLcmd\r\n\t\t\t\t\t\t\t+ N'WHEN MATCHED AND ' + @WHERE_UnMatchedColList + CHAR(10)--\r\n\t\t\t\t\t\t\t+ N'\tTHEN UPDATE SET ' + @UpdateColumnList + CHAR(10);\r\n\t\t\t\tIF @IncludeInsert = 1\r\n\t\t\t\t\tSET @SQLcmd = @SQLcmd\r\n\t\t\t\t\t\t\t+ N'WHEN NOT MATCHED BY TARGET ' + CHAR(10)--\r\n\t\t\t\t\t\t\t+ N'\tTHEN INSERT (' + @InsertColumnList + ')' + CHAR(10)--\r\n\t\t\t\t\t\t\t+ N'\t\t VALUES (' + @InsertValueList + ')' + CHAR(10);\r\n\t\t\t\tIF @IncludeDelete = 1\r\n\t\t\t\t\tSET @SQLcmd = @SQLcmd\r\n\t\t\t\t\t\t\t+ N'WHEN NOT MATCHED BY SOURCE ' + CHAR(10)--\r\n\t\t\t\t\t\t\t+ N'\tTHEN DELETE' + CHAR(10);\r\n\t\t\t\tSET @SQLcmd = @SQLcmd + N';';\r\n\t\t\t\t--$EndRegion: Applicable for (Tables which has PrimaryKey Columns (or) ONE of PrimaryKey Columns might be IdentityKey Column) OR (Heap Tables)\r\n\t\t\tEND;\r\n\t\t\tELSE --IF @ExclusiveIDcols = 1 AND @ExclusivePKcols > 0\r\n\t\t\tBEGIN\r\n\t\t\t\t--$BeginRegion: Applicable for Tables which Contains All Columns with Both Exclusive PrimaryKey Columns and Exclusive IdentityKey Column\r\n\t\t\t\t----Here, Two Merge Statements are Required to Sync Data From Source To Target\r\n\t\t\t\tIF @IncludeDelete = 1\r\n\t\t\t\t\tSET @SQLcmd = @SQLcmd\r\n\t\t\t\t\t\t\t\t+ N'MERGE INTO [' + ISNULL(@LinkedServer, @@SERVERNAME) + '].[' + @CheckTargetDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS T' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'USING [' + @@SERVERNAME + '].[' + @ReferSourceDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS S' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'\tON ' + @ON_MatchedColList + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'WHEN NOT MATCHED BY SOURCE ' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'\tTHEN DELETE' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N';';\r\n\t\t\t\t--\r\n\t\t\t\tIF @IncludeInsert = 1\r\n\t\t\t\t\tSET @SQLcmd = @SQLcmd\r\n\t\t\t\t\t\t\t\t+ N'MERGE INTO [' + ISNULL(@LinkedServer, @@SERVERNAME) + '].[' + @CheckTargetDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS T' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'USING [' + @@SERVERNAME + '].[' + @ReferSourceDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS S' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'\tON ' + @ON_MatchedColList + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'WHEN NOT MATCHED BY TARGET ' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'\tTHEN INSERT (' + @InsertColumnList + ')' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'\t\t VALUES (' + @InsertValueList + ')' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N';';\r\n\t\t\t\t--$EndRegion: Applicable for Tables which Contains All Columns with Both Exclusive PrimaryKey Columns and Exclusive IdentityKey Column\r\n\t\t\tEND;\r\n\t\t\t--\r\n\t\t\tIF @IncludeInsert = 1\r\n\t\t\t\tIF EXISTS (SELECT * FROM @TableColumns WHERE IsIdentityCol = 1)\r\n\t\t\t\t\tSET @SQLcmd = @SQLcmd + CHAR(10) + N'SET IDENTITY_INSERT [' + @CheckTargetDatabase + '].[' + @SCHname + '].[' + @TBLname + '] OFF;' + CHAR(10);\r\n\t\t\t--\r\n\t\t\tIF @Debug = 1 PRINT '--@MergeQueryFromSourceToTarget: ' + CHAR(10) + ISNULL(@SQLcmd, 'NULL') + CHAR(10);\r\n\t\t\tUPDATE #COMPARISONTABLE SET MergeQueryFromSourceToTarget = @SQLcmd WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\t\t----$EndRegion: Generating Query for MergeDataFromSourceToTarget\r\n\t\t\t--\t\t\t\r\n\t\t\t----$BeginRegion: Generating Query for MergeDataFromTargetToSource\r\n\t\t\tSET @SQLcmd = ''; --Reset Value\r\n\t\t\t--\r\n\t\t\tIF @IncludeInsert = 1\r\n\t\t\t\tIF EXISTS (SELECT * FROM @TableColumns WHERE IsIdentityCol = 1)\r\n\t\t\t\t\tSET @SQLcmd = @SQLcmd + N'SET IDENTITY_INSERT [' + @ReferSourceDatabase + '].[' + @SCHname + '].[' + @TBLname + '] ON;' + CHAR(10);\r\n\t\t\t--\r\n\t\t\tIF ((@ExclusivePKcols > 0 OR @IDasPKcols > 0) AND @ExclusiveIDcols = 0) --Table have PrimaryKey Columns in which One PK column might be IdentityKey Column\r\n\t\t\t OR (@ExclusivePKcols = 0 AND @IDasPKcols = 0 AND @ExclusiveIDcols = 1) --Table doesnot have PrimaryKey Columns but have IdentityKey Column\r\n\t\t\t OR (@ExclusivePKcols = 0 AND @IDasPKcols = 0 AND @ExclusiveIDcols = 0) --Heap Tables\r\n\t\t\tBEGIN\r\n\t\t\t\t--$BeginRegion: Applicable for (Tables which has PrimaryKey Columns (or) ONE of PrimaryKey Columns might be IdentityKey Column) OR (Heap Tables)\r\n\t\t\t\t----Here, One Merge Statement is Enough to Sync Data From Target To Source\r\n\t\t\t\tSET @SQLcmd = @SQLcmd\r\n\t\t\t\t\t\t\t+ N'MERGE INTO [' + @@SERVERNAME + '].[' + @ReferSourceDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS T' + CHAR(10)--\r\n\t\t\t\t\t\t\t+ N'USING [' + ISNULL(@LinkedServer, @@SERVERNAME) + '].[' + @CheckTargetDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS S' + CHAR(10)--\r\n\t\t\t\t\t\t\t+ N'\tON ' + @ON_MatchedColList + CHAR(10);\r\n\t\t\t\tIF @IncludeUpdate = 1 AND @WHERE_UnMatchedColList IS NOT NULL AND @UpdateColumnList IS NOT NULL\r\n\t\t\t\t\tSET @SQLcmd = @SQLcmd\r\n\t\t\t\t\t\t\t+ N'WHEN MATCHED AND ' + @WHERE_UnMatchedColList + CHAR(10)--\r\n\t\t\t\t\t\t\t+ N'\tTHEN UPDATE SET ' + @UpdateColumnList + CHAR(10);\r\n\t\t\t\tIF @IncludeInsert = 1\r\n\t\t\t\t\tSET @SQLcmd = @SQLcmd\r\n\t\t\t\t\t\t\t+ N'WHEN NOT MATCHED BY TARGET ' + CHAR(10)\r\n\t\t\t\t\t\t\t+ N'\tTHEN INSERT (' + @InsertColumnList + ')' + CHAR(10)--\r\n\t\t\t\t\t\t\t+ N'\t\t VALUES (' + @InsertValueList + ')' + CHAR(10);\r\n\t\t\t\tIF @IncludeDelete = 1\r\n\t\t\t\t\tSET @SQLcmd = @SQLcmd\r\n\t\t\t\t\t\t\t+ N'WHEN NOT MATCHED BY SOURCE ' + CHAR(10)--\r\n\t\t\t\t\t\t\t+ N'\tTHEN DELETE' + CHAR(10);\r\n\t\t\t\tSET @SQLcmd = @SQLcmd + N';';\r\n\t\t\t\t--$EndRegion: Applicable for (Tables which has PrimaryKey Columns (or) ONE of PrimaryKey Columns might be IdentityKey Column) OR (Heap Tables)\r\n\t\t\tEND;\r\n\t\t\tELSE --IF @ExclusiveIDcols = 1 AND @ExclusivePKcols > 0\r\n\t\t\tBEGIN\r\n\t\t\t\t--$BeginRegion: Applicable for Tables which Contains All Columns with Both Exclusive PrimaryKey Columns and Exclusive IdentityKey Column\r\n\t\t\t\t----Here, Two Merge Statements are Required to Sync Data From Target To Source\r\n\t\t\t\tIF @IncludeDelete = 1\r\n\t\t\t\t\tSET @SQLcmd = @SQLcmd\r\n\t\t\t\t\t\t\t\t+ N'MERGE INTO [' + @@SERVERNAME + '].[' + @ReferSourceDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS T' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'USING [' + ISNULL(@LinkedServer, @@SERVERNAME) + '].[' + @CheckTargetDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS S' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'\tON ' + @ON_MatchedColList + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'WHEN NOT MATCHED BY SOURCE ' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'\tTHEN DELETE' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N';';\r\n\t\t\t\t--\r\n\t\t\t\tIF @IncludeInsert = 1\r\n\t\t\t\t\tSET @SQLcmd = @SQLcmd\r\n\t\t\t\t\t\t\t\t+ N'MERGE INTO [' + @@SERVERNAME + '].[' + @ReferSourceDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS T' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'USING [' + ISNULL(@LinkedServer, @@SERVERNAME) + '].[' + @CheckTargetDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS S' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'\tON ' + @ON_MatchedColList + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'WHEN NOT MATCHED BY TARGET ' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'\tTHEN INSERT (' + @InsertColumnList + ')' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N'\t\t VALUES (' + @InsertValueList + ')' + CHAR(10)--\r\n\t\t\t\t\t\t\t\t+ N';';\r\n\t\t\t\t--$EndRegion: Applicable for Tables which Contains All Columns with Both Exclusive PrimaryKey Columns and Exclusive IdentityKey Column\r\n\t\t\tEND;\r\n\t\t\t--\r\n\t\t\tIF @IncludeInsert = 1\r\n\t\t\t\tIF EXISTS (SELECT * FROM @TableColumns WHERE IsIdentityCol = 1)\r\n\t\t\t\t\tSET @SQLcmd = @SQLcmd + CHAR(10) + N'SET IDENTITY_INSERT [' + @ReferSourceDatabase + '].[' + @SCHname + '].[' + @TBLname + '] OFF;' + CHAR(10);\r\n\t\t\t--\r\n\t\t\tIF @Debug = 1 PRINT '--@MergeQueryFromTargetToSource: ' + CHAR(10) + ISNULL(@SQLcmd, 'NULL') + CHAR(10);\r\n\t\t\tUPDATE #COMPARISONTABLE SET MergeQueryFromTargetToSource = @SQLcmd WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\t\t----$EndRegion: Generating Query for MergeDataFromTargetToSource\r\n\t\tEND;\r\n\t\t--$EndRegion: Generating Merge Statements\r\n\t\tEND;\r\n\tEND TRY\r\n\tBEGIN CATCH\r\n\t\tSET @ErrMsg = NULL; SET @ErrMsg = ERROR_MESSAGE(); --Reset Value\r\n\t\tUPDATE #COMPARISONTABLE SET Remarks = @ErrMsg WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\tIF @Debug = 1 PRINT '/** Error Occured: **/' + CHAR(10) + ISNULL(@SQLcmd, 'NULL') + CHAR(10) + '--* ' + @ErrMsg + CHAR(10);\r\n\tEND CATCH;\r\n\t--\r\n\tFETCH NEXT FROM TableCursor INTO @SCHname, @TBLname, @LVL;\r\nEND;\r\nCLOSE TableCursor;\r\nDEALLOCATE TableCursor;\r\n--$EndRegion: Cursor for Each Table\r\n--\r\n--\r\n--$BeginRegion: Final Stage Direct ResultSet\r\n/*--Direct Viewing of ResultSet\r\nSELECT\tSchemaName, TableName, LVL, SourceRowCount, TargetRowCount, RowsDEL, RowsINS, RowsUPD,\r\n\t\tValidateQueryV1 AS \"ValidateQuery (Preferred For RowsINS or RowsDEL)\", ValidateQueryV2 AS \"ValidateQuery (Preferred For RowsUPD)\",\r\n\t\tISNULL(Remarks, '') AS Remarks,\r\n\t\tMergeQueryFromSourceToTarget, MergeQueryFromTargetToSource\r\nFROM #COMPARISONTABLE\r\nWHERE RowsINS <> 0 OR RowsDEL <> 0 OR RowsUPD <> 0 OR SourceRowCount IS NULL OR TargetRowCount IS NULL\r\nORDER BY LVL ASC, SchemaName ASC, TableName ASC;\r\n*/\r\n--$EndRegion: Final Stage Direct ResultSet\r\n--\r\nSET @SQLcmd = NULL; --Reset Value\r\nSET @SQLcmd = N'\r\nSELECT\tSchemaName, TableName, LVL, SourceRowCount, TargetRowCount, RowsDEL, RowsINS, RowsUPD,\r\n\t\tValidateQueryV1 AS \"ValidateQuery (Preferred For RowsINS or RowsDEL)\", ValidateQueryV2  AS \"ValidateQuery (Preferred For RowsUPD)\",\r\n\t\tISNULL(Remarks, '''') AS Remarks,\r\n\t\tMergeQueryFromSourceToTarget AS \"MergeQueryFromSourceToTarget (EXEC in [' + ISNULL(@LinkedServer, @@SERVERNAME) + '].[' + @CheckTargetDatabase + '])\",\r\n\t\tMergeQueryFromTargetToSource AS \"MergeQueryFromTargetToSource (EXEC in [' + @@servername + '].[' + @ReferSourceDatabase + '])\"\r\nFROM #COMPARISONTABLE\r\nWHERE RowsINS <> 0 OR RowsDEL <> 0 OR RowsUPD <> 0 OR SourceRowCount IS NULL OR TargetRowCount IS NULL\r\nORDER BY ' + CASE WHEN @IncludeDelete = 1 AND @IncludeInsert = 0 THEN 'LVL DESC' ELSE 'LVL ASC' END + ', SchemaName ASC, TableName ASC;';\r\nEXEC sys.sp_executesql @command = @SQLcmd;",
  "placeholders": [
    {
      "name": "SourceDatabase",
      "defaultValue": null
    },
    {
      "name": "TargetDatabase",
      "defaultValue": null
    },
    {
      "name": "LinkedServer",
      "defaultValue": "NULL"
    }
  ]
}