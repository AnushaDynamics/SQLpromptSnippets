{
  "id": "3afbc32a-c784-443a-8132-babc53b70f4f",
  "prefix": "GapsAndIslands_GetMergingOfOverlappedTimePeriods",
  "description": "Merging Overlapped DateTime Periods with Different Appraoches",
  "body": "/* =========================================================================================================================================\r\n-- Database\t\t: User Database\r\n-- Script\t\t: Merging Overlapped DateTime Periods in the Original Table\r\n-- Description\t: Merging Overlapped DateTime Periods of below Scenarios with Event1(E1) and Event2 (E2)\r\n----$BeginRegion: Test Events for Demonstrating the Merging of Overlapping Events\r\n\t----Input:: Id, StartTime, EndTime\r\n\t----1\tE1 = 00:00:00.000 to 00:30:00.000 ; E2 = 00:30:01.000 to 02:00:00.000 => 2nd Event Started Just After 1st Event Completed with 1 second Diff -- Start to Finish\r\n\t----2\tE1 = 03:00:00.000 to 05:00:00.000 ; E2 = 04:00:00.000 to 06:00:00.000 => 2nd Event Started While 1st Event is Still in Progress -- Overlapped Event (Start to Start with Lag)\r\n\t----3\tE1 = 07:00:00.000 to 09:00:00.000 ; E2 = 08:00:00.000 to 09:00:00.000 => 2nd Event Completed Along with 1st Event eventhough 1st Event Started Later -- Finish to Finish\r\n\t----4\tE1 = 10:00:00.000 to 11:00:00.000 ; E2 = 10:00:00.000 to 12:00:00.000 => 2nd Event Started Along with 1st Event But 2nd Event Completed Later -- Start to Start\r\n\t----5\tE1 = 13:00:00.000 to 16:00:00.000 ; E2 = 14:00:00.000 to 15:00:00.000 => 2nd Event Started After 1st Event and Completed Before 1st Event -- Complete Overlapped Event\r\n\t----6\tE1 = 17:00:00.000 to 18:00:00.000 ; E2 = 19:00:00.000 to 20:00:00.000 => 2nd Event Started with a Gap After 1st Event Completed -- No OverLap\r\n----$EndRegion: Test Events for Demonstrating the Merging of Overlapping Events\r\n-- Usage\t\t: Use the Sample Data and Choose an Approach to Get the Required Result Set\r\n\t--Approach #1: This Approach is helpful to Merge DateRange Periods with a Custom Gap in Between the Events.(Ex: If Events have gap of 1 Sec | 10 Secs | 1 Hour | 1 Day... etc).\r\n\t--Approach #2: This Approach is Not Customisable as Approach #1 and DoesNot Merge the DateRange Periods If Events have MilliSecs Gap as well.\r\n-- History\t\t:\r\n-- Refer Links\t: https://stackoverflow.com/questions/2561130/merge-overlapping-date-intervals\r\n========================================================================================================================================= */\r\nUSE tempdb;\r\nGO\r\n--\r\n--$BeginRegion: #SampleTable with Sample Data\r\nDROP TABLE IF EXISTS dbo.#SampleTable;\r\nCREATE TABLE #SampleTable (Id INT NULL, StartTime DATETIME NULL, EndTime DATETIME NULL);\r\nINSERT INTO #SampleTable(Id, StartTime, EndTime)\r\nVALUES-- Id, Event #1 (E1), Event #2 (E2)\r\n\t(1, N'2010-01-01 00:00:00.000', N'2010-01-01 00:30:00.000'), (1, N'2010-01-01 00:30:01.000', N'2010-01-01 02:00:00.000'),\r\n\t(2, N'2010-01-01 03:00:00.000', N'2010-01-01 05:00:00.000'), (2, N'2010-01-01 04:00:00.000', N'2010-01-01 06:00:00.000'),\r\n\t(3, N'2010-01-01 07:00:00.000', N'2010-01-01 09:00:00.000'), (3, N'2010-01-01 08:00:00.000', N'2010-01-01 09:00:00.000'),\r\n\t(4, N'2010-01-01 10:00:00.000', N'2010-01-01 11:00:00.000'), (4, N'2010-01-01 10:00:00.000', N'2010-01-01 12:00:00.000'),\r\n\t(5, N'2010-01-01 13:00:00.000', N'2010-01-01 16:00:00.000'), (5, N'2010-01-01 14:00:00.000', N'2010-01-01 15:00:00.000'),\r\n\t(6, N'2010-01-01 17:00:00.000', N'2010-01-01 18:00:00.000'), (6, N'2010-01-01 19:00:00.000', N'2010-01-01 20:00:00.000');\r\n--\r\nSELECT\tId, StartTime, EndTime--\r\nFROM\t#SampleTable;\r\n--$EndRegion: #SampleTable with Sample Data\r\n--\r\n--$BeginRegion: Approach #1\r\n--\r\n--$BeginRegion: Phase #0 - Raw Data Input:: Id, StartTime, EndTime\r\n----1\tE1 = 00:00:00.000 to 00:30:00.000 ; E2 = 00:30:01.000 to 02:00:00.000\r\n----2\tE1 = 03:00:00.000 to 05:00:00.000 ; E2 = 04:00:00.000 to 06:00:00.000\r\n----3\tE1 = 07:00:00.000 to 09:00:00.000 ; E2 = 08:00:00.000 to 09:00:00.000\r\n----4\tE1 = 10:00:00.000 to 11:00:00.000 ; E2 = 10:00:00.000 to 12:00:00.000\r\n----5\tE1 = 13:00:00.000 to 16:00:00.000 ; E2 = 14:00:00.000 to 15:00:00.000\r\n----6\tE1 = 17:00:00.000 to 18:00:00.000 ; E2 = 19:00:00.000 to 20:00:00.000\r\n--$EndRegion: Phase #0 - Raw Data Input:: Id, StartTime, EndTime\r\nDECLARE @RowCount INT=0;\r\nWHILE(1=1) --\r\nBEGIN\r\n\tSET @RowCount=0;\r\n\t--\r\n\t--$BeginRegion: Phase #1 - Updating E1's EndTime with VeryNext Event E2's EndTime\r\n\tUPDATE\tT1\r\n\tSET T1.EndTime=T2.EndTime\r\n\tFROM\tdbo.#SampleTable AS T1\r\n\t\t\tINNER JOIN dbo.#SampleTable AS T2 ON T2.Id=T1.Id\r\n\tWHERE DATEADD(SECOND/*This can be Adjusted as Required*/, 1, T1.EndTime) BETWEEN T2.StartTime AND T2.EndTime;\r\n\t--\r\n\tSET @RowCount=@RowCount+@@ROWCOUNT;\r\n\t--$EndRegion: Phase #1 - Updating E1's EndTime with VeryNext Event E2's EndTime\r\n\t--\r\n\t--$BeginRegion: Phase #1 ResultSet:: Id, StartTime, EndTime\r\n\t----1\tE1 = 00:00:00:000 to 02:00:00:000 ; E2 = 00:30:01:000 to 02:00:00:000\r\n\t----2\tE1 = 03:00:00:000 to 06:00:00:000 ; E2 = 04:00:00:000 to 06:00:00:000\r\n\t----3\tE1 = 07:00:00:000 to 09:00:00:000 ; E2 = 08:00:00:000 to 09:00:00:000\r\n\t----4\tE1 = 10:00:00:000 to 12:00:00:000 ; E2 = 10:00:00:000 to 12:00:00:000\r\n\t----5\tE1 = 13:00:00:000 to 16:00:00:000 ; E2 = 14:00:00:000 to 16:00:00:000\r\n\t----6\tE1 = 17:00:00:000 to 18:00:00:000 ; E2 = 19:00:00:000 to 20:00:00:000\r\n\t--$EndRegion: Phase #1 ResultSet:: Id, StartTime, EndTime\r\n\t--\r\n\t--$BeginRegion: Phase #2 - Deleting Overlapped Events If E1's EndTime = E2's EndTime and E2's StartTime > E1's StartTime\r\n\tDELETE\tT1\r\n\tFROM\tdbo.#SampleTable AS T1\r\n\t\t\tINNER JOIN dbo.#SampleTable AS T2 ON T2.Id=T1.Id\r\n\tWHERE T1.EndTime=T2.EndTime AND T1.StartTime>T2.StartTime;\r\n\t--\r\n\tSET @RowCount=@RowCount+@@ROWCOUNT;\r\n\t--$EndRegion: Phase #2 - Deleting Overlapped Events If E1's EndTime = E2's EndTime and E2's StartTime > E1's StartTime\r\n\t--\r\n\t--$BeginRegion: Phase #2 ResultSet:: Id, StartTime, EndTime\r\n\t----1\tE1 = 00:00:00:000 to 02:00:00:000 ;\r\n\t----2\tE1 = 03:00:00:000 to 06:00:00:000 ;\r\n\t----3\tE1 = 07:00:00:000 to 09:00:00:000 ;\r\n\t----4\tE1 = 10:00:00:000 to 12:00:00:000 ; E2 = 10:00:00:000 to 12:00:00:000\r\n\t----5\tE1 = 13:00:00:000 to 16:00:00:000 ;\r\n\t----6\tE1 = 17:00:00:000 to 18:00:00:000 ; E2 = 19:00:00:000 to 20:00:00:000\r\n\t--$EndRegion: Phase #2 ResultSet:: Id, StartTime, EndTime\r\n\t--\r\n\t--$BeginRegion: Phase #3 - Deleting Full Duplicate Records w.r.to Id, StartTime, EndTime\r\n\tWITH _GetDups AS --\r\n\t(SELECT Id, StartTime, EndTime, DupID=ROW_NUMBER() OVER (PARTITION BY Id, StartTime, EndTime ORDER BY Id)FROM #SampleTable )\r\n\tDELETE FROM _GetDups WHERE _GetDups.DupID>1;\r\n\t--\r\n\tSET @RowCount=@RowCount+@@ROWCOUNT;\r\n\t--$EndRegion: Phase #3 - Deleting Full Duplicate Records w.r.to Id, StartTime, EndTime\r\n\t--\r\n\t--$BeginRegion: Phase #3 ResultSet:: Id, StartTime, EndTime\r\n\t----1\tE1 = 00:00:00:000 to 02:00:00:000 ;\r\n\t----2\tE1 = 03:00:00:000 to 06:00:00:000 ;\r\n\t----3\tE1 = 07:00:00:000 to 09:00:00:000 ;\r\n\t----4\tE1 = 10:00:00:000 to 12:00:00:000 ;\r\n\t----5\tE1 = 13:00:00:000 to 16:00:00:000 ;\r\n\t----6\tE1 = 17:00:00:000 to 18:00:00:000 ; E2 = 19:00:00:000 to 20:00:00:000\r\n\t--$EndRegion: Phase #3 ResultSet:: Id, StartTime, EndTime\r\n\t--\r\n\tIF\t@RowCount=0 --\r\n\t\tBREAK;\r\nEND;\r\nSELECT ST.Id, ST.StartTime, ST.EndTime FROM #SampleTable AS ST;\r\n--$EndRegion: Approach #1\r\n--\r\n--$BeginRegion: Approach #2\r\n--\r\n--$BeginRegion: Raw Data Input:: Id, StartTime, EndTime\r\n----1\tE1 = 00:00:00.000 to 00:30:00.000 ; E2 = 00:30:01.000 to 02:00:00.000\r\n----2\tE1 = 03:00:00.000 to 05:00:00.000 ; E2 = 04:00:00.000 to 06:00:00.000\r\n----3\tE1 = 07:00:00.000 to 09:00:00.000 ; E2 = 08:00:00.000 to 09:00:00.000\r\n----4\tE1 = 10:00:00.000 to 11:00:00.000 ; E2 = 10:00:00.000 to 12:00:00.000\r\n----5\tE1 = 13:00:00.000 to 16:00:00.000 ; E2 = 14:00:00.000 to 15:00:00.000\r\n----6\tE1 = 17:00:00.000 to 18:00:00.000 ; E2 = 19:00:00.000 to 20:00:00.000\r\n--$EndRegion: Raw Data Input:: Id, StartTime, EndTime\r\n--\r\nSELECT X1.Id,\r\n\t   StartTime = X1.StartTime,\r\n\t   EndTime = MIN(X2.EndTime)\r\nFROM dbo.#SampleTable AS X1\r\nINNER JOIN dbo.#SampleTable AS X2\r\n\tON X1.Id = X2.Id\r\n\t   AND X1.StartTime <= X2.EndTime\r\n\t   AND NOT EXISTS (\r\n\t\t\t\t\t\t  SELECT *\r\n\t\t\t\t\t\t  FROM dbo.#SampleTable AS X3\r\n\t\t\t\t\t\t  WHERE X2.Id = X3.Id\r\n\t\t\t\t\t\t\t\tAND X2.EndTime >= X3.StartTime\r\n\t\t\t\t\t\t\t\tAND X2.EndTime < X3.EndTime\r\n\t\t\t\t\t  )\r\nWHERE NOT EXISTS (\r\n\t\t\t\t\t SELECT *\r\n\t\t\t\t\t FROM dbo.#SampleTable AS X4\r\n\t\t\t\t\t WHERE X1.Id = X4.Id\r\n\t\t\t\t\t\t   AND X1.StartTime > X4.StartTime\r\n\t\t\t\t\t\t   AND X1.StartTime <= X4.EndTime\r\n\t\t\t\t )\r\nGROUP BY X1.Id,\r\n\t\t X1.StartTime\r\nORDER BY X1.StartTime;\r\n--\r\n--$BeginRegion: ResultSet:: Id, StartTime, EndTime\r\n----1\tE1 = 00:00:00.000 to 00:30:00.000 ; E2 = 00:30:01.000 to 02:00:00.000\r\n----2\tE1 = 03:00:00:000 to 06:00:00:000 ;\r\n----3\tE1 = 07:00:00:000 to 09:00:00:000 ;\r\n----4\tE1 = 10:00:00:000 to 12:00:00:000 ;\r\n----5\tE1 = 13:00:00:000 to 16:00:00:000 ;\r\n----6\tE1 = 17:00:00:000 to 18:00:00:000 ; E2 = 19:00:00:000 to 20:00:00:000\r\n--$EndRegion: ResultSet:: Id, StartTime, EndTime\r\n--\r\n--$EndRegion: Approach #2"
}