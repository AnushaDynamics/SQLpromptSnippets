{
  "id": "79682c35-2fe4-444a-9b4a-b126e5b3a787",
  "prefix": "Temp_MSDB_Queries",
  "description": "Temp MSDB Queries",
  "body": "--$BeginRegion: Get Job History w.r.to RunDate, RunTime and RunDuration\r\nSELECT DISTINCT --\r\n\t   SJ.name AS \"JobName\",\r\n\t   HS.run_date,\r\n\t   STUFF(STUFF(CAST(HS.run_date AS VARCHAR(8)), 7, 0, '-'), 5, 0, '-') AS \"RunDate1\",\r\n\t   (CONVERT(NVARCHAR(4), HS.run_date / 10000) + N'-' + CONVERT(NVARCHAR(2), (HS.run_date % 10000) / 100) + N'-' + CONVERT(NVARCHAR(2), HS.run_date % 100)) AS \"RunDate2\",\r\n\t   (SUBSTRING(CAST(HS.run_date AS VARCHAR(8)), 1, 4) + '-' + SUBSTRING(CAST(HS.run_date AS VARCHAR(8)), 5, 2) + '-' + SUBSTRING(CAST(HS.run_date AS VARCHAR(8)), 7, 2)) AS \"RunDate3\",\r\n\t   --\r\n\t   HS.run_time,\r\n\t   STUFF(STUFF(RIGHT('000000' + CAST(HS.run_time AS VARCHAR(6)), 6), 5, 0, ':'), 3, 0, ':') AS \"RunTime1\",\r\n\t   (CONVERT(NVARCHAR(2), HS.run_time / 10000) + N':' + CONVERT(NVARCHAR(2), (HS.run_time % 10000) / 100) + N':' + CONVERT(NVARCHAR(2), HS.run_time % 100)) AS \"RunTime2\",\r\n\t   (SUBSTRING(RIGHT('000000' + CAST(HS.run_time AS VARCHAR(6)), 6), 1, 2) + ':' + SUBSTRING(RIGHT('000000' + CAST(HS.run_time AS VARCHAR(6)), 6), 3, 2) + ':' + SUBSTRING(RIGHT('000000' + CAST(HS.run_time AS VARCHAR(6)), 6), 5, 2)) AS \"RunTime3\",\r\n\t   --\r\n\t   msdb.dbo.agent_datetime(HS.run_date, HS.run_time) AS \"RunDateTime1\", --Execute permission was denied on the object 'agent_datetime', database 'msdb', schema 'dbo'\r\n\t   CONVERT(DATETIME, STUFF(STUFF(REPLACE(STR(HS.run_date, 8, 0), '  ', '19'), 5, 0, '-'), 8, 0, '-') + ' ' + STUFF(STUFF(REPLACE(STR(HS.run_time, 6, 0), ' ', '0'), 3, 0, ':'), 6, 0, ':')) AS \"RunDateTime2\",\r\n\t   CONVERT(DATETIME, CONVERT(NVARCHAR(4), HS.run_date / 10000) + N'-' + CONVERT(NVARCHAR(2), (HS.run_date % 10000) / 100) + N'-' + CONVERT(NVARCHAR(2), HS.run_date % 100) + N' ' + CONVERT(NVARCHAR(2), HS.run_time / 10000) + N':' + CONVERT(NVARCHAR(2), (HS.run_time % 10000) / 100) + N':' + CONVERT(NVARCHAR(2), HS.run_time % 100), 120) AS \"RunDateTime3\",\r\n\t   CONVERT(DATETIME, SUBSTRING(CAST(HS.run_date AS VARCHAR(8)), 1, 4) + '-' + SUBSTRING(CAST(HS.run_date AS VARCHAR(8)), 5, 2) + '-' + SUBSTRING(CAST(HS.run_date AS VARCHAR(8)), 7, 2) + ' ' + SUBSTRING(RIGHT('000000' + CAST(HS.run_time AS VARCHAR(6)), 6), 1, 2) + ':' + SUBSTRING(RIGHT('000000' + CAST(HS.run_time AS VARCHAR(6)), 6), 3, 2) + ':' + SUBSTRING(RIGHT('000000' + CAST(HS.run_time AS VARCHAR(6)), 6), 5, 2)) AS \"RunDateTime4\",\r\n\t   --\r\n\t   HS.run_duration AS \"RunDuration\", --Returns INT which represents hhmmss(i.e, 123456 represents 12 hours 34 minutes 56 seconds => Read from Right to Left)\r\n\t   CONVERT(VARCHAR(8), CONVERT(TIME, STUFF(STUFF(REPLACE(STR(HS.run_duration, 6, 0), ' ', '0'), 3, 0, ':'), 6, 0, ':'))) AS \"RunDuration2(hh:mm:ss)\",\r\n\t   CONVERT(VARCHAR(8), CONVERT(TIME, CONVERT(NVARCHAR(2), HS.run_duration / 10000) + N':' + CONVERT(NVARCHAR(2), (HS.run_duration % 10000) / 100) + N':' + CONVERT(NVARCHAR(2), HS.run_duration % 100))) AS \"RunDuration3(hh:mm:ss)\",\r\n\t   SUBSTRING(RIGHT('000000' + CAST(HS.run_duration AS VARCHAR(6)), 6), 1, 2) + ':' + SUBSTRING(RIGHT('000000' + CAST(HS.run_duration AS VARCHAR(6)), 6), 3, 2) + ':' + SUBSTRING(RIGHT('000000' + CAST(HS.run_duration AS VARCHAR(6)), 6), 5, 2) AS \"RunDuration4(hh:mm:ss)\",\r\n\t   --\r\n\t   CASE HS.run_status WHEN 1 THEN 'Success' ELSE 'Failure' END AS \"Status\"\r\nFROM msdb.dbo.sysjobs AS SJ\r\nINNER JOIN msdb.dbo.sysjobhistory AS HS ON SJ.job_id = HS.job_id\r\nWHERE SJ.name = N'syspolicy_purge_history'\r\n\t--AND HS.run_status = 1 --hs.run_status = 1 => Success | hs.run_status = 0 => Failure\r\nORDER BY CONVERT(DATETIME, STUFF(STUFF(REPLACE(STR(HS.run_date, 8, 0), '  ', '19'), 5, 0, '-'), 8, 0, '-') + ' ' + STUFF(STUFF(REPLACE(STR(HS.run_time, 6, 0), ' ', '0'), 3, 0, ':'), 6, 0, ':')) DESC;\r\n--$EndRegion: Get Job History w.r.to RunDate, RunTime and RunDuration"
}