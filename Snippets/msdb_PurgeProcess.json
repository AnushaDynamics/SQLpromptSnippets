{
  "id": "8b0e6917-8e24-4830-a412-583d899f4fc5",
  "prefix": "msdb_PurgeProcess",
  "description": "Purging or Cleaning of MSDB History Tables",
  "body": "/* =============================================================================================================================================================\r\n-- Server\t\t: LOCAL SERVER\r\n-- Database\t\t: msdb\r\n-- Script\t\t: msdb_PurgeProcess\r\n-- Description\t: Purging or Cleaning of MSDB History Tables\r\n-- Usage\t\t: Execute in msdb for Retaining History for Days = \"@DaysToRetainHistory\"\r\n-- History\t\t:\r\n-- Refer Links\t: Individual Links Provided\r\n============================================================================================================================================================= */\r\nUSE msdb;\r\nGO\r\n--\r\nDECLARE @DaysToRetainHistory INT; SET @DaysToRetainHistory = $Days_To_Retain$;\r\n/* ===== ** DO NOT CHANGE CODE BELOW FROM HERE ** =========================================================================================================== */\r\nSET NOCOUNT ON;\r\nDECLARE @CutOffDate DATETIME; SET @CutOffDate = (GETDATE() - @DaysToRetainHistory);\r\n\r\n--\r\nBEGIN TRANSACTION;\r\n\t--\r\n\tPRINT 'MSDB MAINTAINANCE: DELETING HISTORY OLDER THAN: \"' + CONVERT(VARCHAR(32), @CutOffDate, 120) + '\"';\r\n\t--\r\n\t-- https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-delete-backuphistory-transact-sql\r\n\tPRINT '' + CHAR(10) + 'DELETING BACKUP HISTORY OLDER THAN: \"' + CONVERT(VARCHAR(32), @CutOffDate, 120) + '\"';\r\n\tEXECUTE dbo.sp_delete_backuphistory --Reduces the size of the backup and restore history tables by deleting the entries for backup sets older than the specified date.\r\n\t\t@oldest_date = @CutOffDate; --@oldest_date retained in the backup and restore history tables with NO default.\r\n\t--\r\n\t/*\r\n\t-- https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-delete-database-backuphistory-transact-sql\r\n\tEXECUTE dbo.sp_delete_database_backuphistory --Deletes information about the specified database from the backup and restore history tables.\r\n\t\t@database_name = NULL; --@database_name specifies the name of the database involved in backup and restore operations with NO default.\r\n\t*/\r\n\t--\r\n\t-- https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sysmail-delete-mailitems-sp-transact-sql \r\n\tPRINT '' + CHAR(10) + 'DELETING SYS MAIL ITEMS OLDER THAN: \"' + CONVERT(VARCHAR(32), @CutOffDate, 120) + '\"';\r\n\tEXECUTE dbo.sysmail_delete_mailitems_sp --Permanently deletes e-mail messages from the Database Mail internal tables.\r\n\t\t@sent_before = @CutOffDate, --Deletes e-mails up to the date and time provided as the @sent_before argument. NULL indicates all dates.\r\n\t\t@sent_status = NULL; --Deletes e-mails of the type specified by @sent_status. { sent | unsent | retrying | failed }. NULL indicates all statuses.\r\n\t--\r\n\t-- https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-purge-jobhistory-transact-sql\r\n\tPRINT '' + CHAR(10) + 'DELETING AGENT JOB LOG HISTORY OLDER THAN: \"' + CONVERT(VARCHAR(32), @CutOffDate, 120) + '\"';\r\n\tEXECUTE dbo.sp_purge_jobhistory --Removes the history records for a job.\r\n\t\t@job_name = NULL, --The name { name from dbo.sysjobs } of the job for which to delete the history records. NULL indicates all jobs.\r\n\t\t@job_id = NULL, --The id { job_id from dbo.sysjobs } of the job for the records to be deleted. NULL indicates all jobs.\r\n\t\t@oldest_date = @CutOffDate; --This removes records that are older than the @oldest_date specified. NULL indicates all dates.\r\n\t--\r\n\t-- https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sysmail-delete-log-sp-transact-sql\r\n\tPRINT '' + CHAR(10) + 'DELETING DATABASE MAIL LOG HISTORY LOGGED BEFORE: \"' + CONVERT(VARCHAR(32), @CutOffDate, 120) + '\"';\r\n\tEXECUTE dbo.sysmail_delete_log_sp --Deletes events in the Database Mail log or those events meeting a date or type criteria.\r\n\t\t@logged_before = @CutOffDate, --Deletes entries up to the date and time specified by the @logged_before parameter. NULL indicates all dates.\r\n\t\t@event_type = NULL; --Deletes log entries of the type specified as the @event_type. { success | warning | error | informational }. NULL indicates all event_types.\r\n\t--\r\n\t-- https://sswug.org/alexanderchigrik/sql-server/nine-undocumented-sql-server-2014-database-maintenance-plan-stored-procedures/\r\n\tPRINT '' + CHAR(10) + 'DELETING MAINTAINANCE PLAN HISTORY BEFORE: \"' + CONVERT(VARCHAR(32), @CutOffDate, 120) + '\"';\r\n\tEXECUTE dbo.sp_maintplan_delete_log --Deletes the maintenance plan log entries.\r\n\t\t@plan_id = NULL, --The ID of the maintenance plan. NULL indicates all plans.\r\n\t\t@subplan_id = NULL, --The ID of the maintenance subplan. NULL indicates all subplans.\r\n\t\t@oldest_time = @CutOffDate; --This removes records that are older than the @oldest_time specified. NULL indicates all dates.\r\n\t--\r\nCOMMIT TRANSACTION;",
  "placeholders": [
    {
      "name": "Days_To_Retain",
      "defaultValue": "90"
    }
  ]
}