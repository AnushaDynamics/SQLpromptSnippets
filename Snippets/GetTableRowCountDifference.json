{
  "id": "7f9b9a4b-2003-43be-aa22-bc644062939c",
  "prefix": "GetTableRowCountDifference",
  "description": "Get Table Row Count Difference Between Source and Target Databases",
  "body": "/* =============================================================================================================================================================\r\n-- Script\t\t: GetRowCountDifference\r\n-- Description\t: Get Table Row Count Difference Between Source and Target Databases\r\n============================================================================================================================================================= */\r\nDECLARE @SourceDatabase VARCHAR(256) = '$SourceDatabase$';\r\nDECLARE @TargetDatabase VARCHAR(256) = '$TargetDatabase$';\r\n/** DONOT CHANGE CODE BELOW ***********************************************************************************************************************************/\r\nSET NOCOUNT ON;\r\nDECLARE @SCHname VARCHAR(256), @TBLname VARCHAR(1024), @RowCount INT;\r\nDECLARE @SQLcmd NVARCHAR(MAX);\r\n--\r\n--$BeginRegion: Get TableList from Reference Database\r\nDECLARE @TableList TABLE (SCHname VARCHAR(256) NULL, TBLname VARCHAR(1024) NULL);\r\nSET @SQLcmd = N'SELECT TABLE_SCHEMA, TABLE_NAME FROM ' + @SourceDatabase + N'.INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = ''BASE TABLE''';\r\nINSERT INTO @TableList (SCHname, TBLname)\r\nEXECUTE sys.sp_executesql @Command = @SQLcmd;\r\n--$EndRegion: Get TableList from Reference Database\r\n--\r\n--$BeginRegion: RowCount Difference Check\r\nDECLARE @COMPARISONTABLE TABLE (SchemaName VARCHAR(256) NULL, TableName VARCHAR(1024) NULL, SourceRowCount INT NULL, TargetRowCount INT NULL, RowDiff INT NULL);\r\n\r\nDECLARE TableCursor CURSOR LOCAL FAST_FORWARD FOR SELECT SCHname, TBLname FROM @TableList;\r\nOPEN TableCursor;\r\nFETCH NEXT FROM TableCursor INTO @SCHname, @TBLname;\r\nWHILE @@FETCH_STATUS = 0\r\n\tBEGIN\r\n\t\t--$BeginRegion: RowCount from Reference Database Table\r\n\t\tSELECT @RowCount = NULL;\r\n\t\tSET @SQLcmd = N'SELECT @RowCountOUT = COUNT(*) FROM [' + @SourceDatabase + N'].[' + @SCHname + N'].[' + @TBLname + '];';\r\n\t\tEXECUTE sys.sp_executesql @Command = @SQLcmd, @Param = N'@RowCountOUT INT OUTPUT', @RowCountOUT = @RowCount OUTPUT;\r\n\t\tINSERT INTO @COMPARISONTABLE (SchemaName, TableName, SourceRowCount) VALUES (@SCHname, @TBLname, @RowCount);\r\n\t\t--$EndRegion: RowCount from Reference Database Table\r\n\t\t--\r\n\t\t--$BeginRegion: RowCount from Check Database Table\r\n\t\tSELECT @RowCount = NULL;\r\n\t\tBEGIN TRY\r\n\t\t\tSET @SQLcmd = N'SELECT @RowCountOUT = COUNT(*) FROM [' + @TargetDatabase + N'].[' + @SCHname + N'].[' + @TBLname + '];';\r\n\t\t\tEXECUTE sys.sp_executesql @Command = @SQLcmd, @Param = N'@RowCountOUT INT OUTPUT', @RowCountOUT = @RowCount OUTPUT;\r\n\t\t\tUPDATE @COMPARISONTABLE SET TargetRowCount = @RowCount, RowDiff = (@RowCount-SourceRowCount) WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\tEND TRY\r\n\t\tBEGIN CATCH\r\n\t\t\tDELETE FROM @COMPARISONTABLE WHERE SchemaName = @SCHname AND TableName = @TBLname;-- Access Error Reading from Remote Table\r\n\t\tEND CATCH;\r\n\t\t--$EndRegion: RowCount from Check Database Table\r\n\t\tFETCH NEXT FROM TableCursor INTO @SCHname, @TBLname;\r\n\tEND;\r\nCLOSE TableCursor;\r\nDEALLOCATE TableCursor;\r\n--$EndRegion: RowCount Difference Check\r\n--\r\nSELECT SchemaName, TableName, SourceRowCount, TargetRowCount, RowDiff\r\nFROM @COMPARISONTABLE\r\nWHERE RowDiff <> 0;",
  "placeholders": [
    {
      "name": "SourceDatabase",
      "defaultValue": null
    },
    {
      "name": "TargetDatabase",
      "defaultValue": null
    }
  ]
}
