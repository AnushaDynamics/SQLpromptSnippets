{
  "id": "7f9b9a4b-2003-43be-aa22-bc644062939c",
  "prefix": "GetTableRowCountDifference",
  "description": "Get Table Row Count Difference Between Source and Target Databases",
  "body": "/* =============================================================================================================================================================\r\n-- Server\t\t: LOCAL SERVER\r\n-- Database\t\t: @ReferDatabase[Source Database] (or) @CheckDatabase[Target Database]\r\n-- Script\t\t: GetRowCountDifference\r\n-- Description\t: Get Table Row Count Difference Between Source and Target Databases\r\n============================================================================================================================================================= */\r\nDECLARE @ReferDatabase VARCHAR(256) = '$ReferDatabase$';--Source Database\r\nDECLARE @CheckDatabase VARCHAR(256) = '$CheckDatabase$';--Target Database\r\nDECLARE @DetialedOUT BIT = 1; --To Get More Precise Details of Data Manipulated\r\nDECLARE @SchemaName VARCHAR(256) = NULL;\t--Optional\r\nDECLARE @TableName VARCHAR(256) = NULL;\t\t--Optional\r\n--\r\nDECLARE @Debug BIT = 0;\t-- 1 = Show ColumnsList | 0 = Excluded (Default) -- Use if Checking For Single Table\r\n/* ===== ** DO NOT CHANGE CODE BELOW FROM HERE ** =========================================================================================================== */\r\nIF DB_NAME() NOT IN (@ReferDatabase, @CheckDatabase)\r\nBEGIN\r\n\tRAISERROR('Script Should Only be Executed in @ReferDatabase (or) @CheckDatabase - Aborting....!', 16, 1) WITH NOWAIT;\r\n\tRETURN;\r\nEND;\r\n--\r\nSET NOCOUNT ON;\r\nDECLARE @SQLcmd NVARCHAR(MAX);\r\n--\r\n--$BeginRegion: Get TableList from Refer Database UNION Check Database\r\nDECLARE @TableList TABLE (SCHname VARCHAR(256) NULL, TBLname VARCHAR(1024) NULL);\r\nSET @SQLcmd = N'SELECT T1.TABLE_SCHEMA, T1.TABLE_NAME FROM ' + @ReferDatabase + N'.INFORMATION_SCHEMA.TABLES AS T1 ' + CHAR(10)\r\n\t\t\t+ N'WHERE T1.TABLE_TYPE = ''BASE TABLE'''\r\n\t\t\t\t+ CASE WHEN @SchemaName IS NOT NULL THEN ' AND T1.TABLE_SCHEMA LIKE ''%' + @SchemaName + '%''' ELSE '' END\r\n\t\t\t\t+ CASE WHEN @TableName IS NOT NULL THEN ' AND T1.TABLE_NAME LIKE ''%' + @TableName + '%''' ELSE '' END + CHAR(10)\r\n\t\t\t+ N'UNION ' + CHAR(10)\r\n\t\t\t+ N'SELECT T2.TABLE_SCHEMA, T2.TABLE_NAME FROM ' + @CheckDatabase + N'.INFORMATION_SCHEMA.TABLES AS T2 ' + CHAR(10)\r\n\t\t\t+ N'WHERE T2.TABLE_TYPE = ''BASE TABLE'''\r\n\t\t\t\t+ CASE WHEN @SchemaName IS NOT NULL THEN ' AND T2.TABLE_SCHEMA LIKE ''%' + @SchemaName + '%''' ELSE '' END\r\n\t\t\t\t+ CASE WHEN @TableName IS NOT NULL THEN ' AND T2.TABLE_NAME LIKE ''%' + @TableName + '%''' ELSE '' END\r\n\t\t\t+ N';';\r\n--PRINT @SQLcmd;\r\nINSERT INTO @TableList (SCHname, TBLname)\r\nEXECUTE sys.sp_executesql @Command = @SQLcmd;\r\n--SELECT * FROM @TableList\r\n--$EndRegion: Get TableList from Refer Database UNION Check Database\r\n--\r\n--$BeginRegion: Cursor for Each Table\r\nIF OBJECT_ID('tempdb..#COMPARISONTABLE') IS NOT NULL\r\n\tDROP TABLE #COMPARISONTABLE;\r\n--\r\nCREATE TABLE #COMPARISONTABLE\r\n(\r\n\tSchemaName VARCHAR(256) NULL, TableName VARCHAR(1024) NULL,\r\n\tReferRowCount INT NULL, CheckRowCount INT NULL, RowsDEL INT NULL, RowsINS INT NULL, RowsUPD INT NULL,\r\n\tValidateQueryV1 VARCHAR(MAX) NULL,\t--Most Preferred to Check RowsINS or RowsDEL\r\n\tValidateQueryV2 VARCHAR(MAX) NULL,\t--Most Preferred to Check RowsUPD\r\n\tRemarks VARCHAR(MAX) NULL --Errors will be Recorded If Any\r\n);\r\n--\r\nDECLARE @TableColumns TABLE\r\n(\r\n\tColID INT NULL, --ORDINAL_POSITION\r\n\tColumnName VARCHAR(256) NULL,\r\n\tColumnDataType VARCHAR(64) NULL,\r\n\tIsPrimaryKeyCol BIT NULL,\r\n\tIsComputedCol BIT NULL,\r\n\tIsIdentityCol BIT NULL\r\n);\r\nDECLARE @SelColListV1S VARCHAR(MAX), @SelColListV1T VARCHAR(MAX), @SelColListV2 VARCHAR(MAX);\r\nDECLARE @OnColList VARCHAR(MAX), @WhereColList AS VARCHAR(MAX);\r\n--\r\nDECLARE @SCHname VARCHAR(256), @TBLname VARCHAR(1024), @RowCount INT;\r\nDECLARE TableCursor CURSOR LOCAL FAST_FORWARD FOR SELECT SCHname, TBLname FROM @TableList;\r\nOPEN TableCursor;\r\nFETCH NEXT FROM TableCursor INTO @SCHname, @TBLname;\r\nWHILE @@FETCH_STATUS = 0\r\n\tBEGIN\r\n\t\tBEGIN TRY\r\n\t\t\tINSERT INTO #COMPARISONTABLE (SchemaName, TableName) VALUES (@SCHname, @TBLname);\r\n\t\t\t--\r\n\t\t\t--$BeginRegion: CheckRowCount from Check Database Table\r\n\t\t\tSELECT @RowCount = NULL; --Reset Value\r\n\t\t\tSET @SQLcmd = N'SELECT @RowCountOUT = COUNT(*) FROM [' + @CheckDatabase + N'].[' + @SCHname + N'].[' + @TBLname + '];';\r\n\t\t\tEXECUTE sys.sp_executesql @Command = @SQLcmd, @Param = N'@RowCountOUT INT OUTPUT', @RowCountOUT = @RowCount OUTPUT;\r\n\t\t\tUPDATE #COMPARISONTABLE SET CheckRowCount = @RowCount WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\t\t--$EndRegion: CheckRowCount from Check Database Table\r\n\t\t\t--\r\n\t\t\t--$BeginRegion: ReferRowCount from Refer Database Table\r\n\t\t\tBEGIN TRY\r\n\t\t\t\t--$BeginRegion: Getting RowsINS or RowsDEL (For Inserted and Deleted Records Only)\r\n\t\t\t\tSELECT @RowCount = NULL; --Reset Value\r\n\t\t\t\tSET @SQLcmd = N'SELECT @RowCountOUT = COUNT(*) FROM [' + @ReferDatabase + N'].[' + @SCHname + N'].[' + @TBLname + '];';\r\n\t\t\t\tEXECUTE sys.sp_executesql @Command = @SQLcmd, @Param = N'@RowCountOUT INT OUTPUT', @RowCountOUT = @RowCount OUTPUT;\r\n\t\t\t\tUPDATE #COMPARISONTABLE\r\n\t\t\t\tSET ReferRowCount = @RowCount,\r\n\t\t\t\t\tRowsDEL = CASE WHEN (@RowCount-CheckRowCount) > 0 THEN (@RowCount-CheckRowCount) ELSE 0 END,\r\n\t\t\t\t\tRowsINS = CASE WHEN (@RowCount-CheckRowCount) < 0 THEN (CheckRowCount - @RowCount) ELSE 0 END\r\n\t\t\t\tWHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\t\t\t--$EndRegion: Getting RowsINS or RowsDEL (For Inserted and Deleted Records Only)\r\n\t\t\t\t--\r\n\t\t\t\t--$BeginRegion: ValidateQuery Formation PreRequisites\r\n\t\t\t\tDELETE @TableColumns WHERE 1=1;\r\n\t\t\t\tINSERT INTO @TableColumns(ColID, ColumnName, ColumnDataType, IsPrimaryKeyCol, IsComputedCol, IsIdentityCol)\r\n\t\t\t\tSELECT DISTINCT COL.column_id, COL.name, ISC.DATA_TYPE, ISNULL(PKC.Is_PK, 0), COL.is_computed, COL.is_identity\r\n\t\t\t\tFROM sys.columns AS COL\r\n\t\t\t\tINNER JOIN sys.tables AS TBL ON TBL.object_id = COL.object_id\r\n\t\t\t\tINNER JOIN sys.schemas AS SCH ON SCH.schema_id = TBL.schema_id\r\n\t\t\t\tINNER JOIN INFORMATION_SCHEMA.COLUMNS AS ISC ON ISC.TABLE_SCHEMA = SCH.name AND ISC.TABLE_NAME = TBL.name AND ISC.COLUMN_NAME = COL.name\r\n\t\t\t\tLEFT JOIN (\r\n\t\t\t\t\t\t\tSELECT IC.object_id, IC.column_id, 1 AS \"Is_PK\"\r\n\t\t\t\t\t\t\tFROM sys.index_columns AS IC\r\n\t\t\t\t\t\t\tINNER JOIN sys.key_constraints AS KC ON IC.object_id = KC.parent_object_id AND IC.index_id = KC.unique_index_id AND KC.type = 'PK'\r\n\t\t\t\t\t\t  ) AS PKC ON PKC.column_id = COL.column_id AND PKC.object_id = COL.object_id\r\n\t\t\t\tWHERE SCH.name = @SCHname AND TBL.name = @TBLname\r\n\t\t\t\tORDER BY COL.column_id ASC;\r\n\t\t\t\t--\r\n\t\t\t\tIF @Debug = 1\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSELECT @SCHname AS SCHname, @TBLname AS TBLname, TC.ColID, TC.ColumnName, TC.ColumnDataType, TC.IsPrimaryKeyCol, TC.IsComputedCol, TC.IsIdentityCol \r\n\t\t\t\t\tFROM @TableColumns AS TC;\r\n\t\t\t\tEND\r\n\t\t\t\t--\r\n\t\t\t\tSET @SelColListV1S = NULL; SET @SelColListV1T = NULL; --Reset Value\r\n\t\t\t\tSELECT\t@SelColListV1S = COALESCE(@SelColListV1S + N', S.[' + ColumnName + N']', 'S.[' + ColumnName + N']'),\r\n\t\t\t\t\t\t@SelColListV1T = COALESCE(@SelColListV1T + N', T.[' + ColumnName + N']', 'T.[' + ColumnName + N']')\r\n\t\t\t\tFROM @TableColumns\r\n\t\t\t\tORDER BY ColID ASC;\r\n\t\t\t\t--SELECT @SelColListV1S, @SelColListV1T;\r\n\t\t\t\t--\r\n\t\t\t\tSET @SelColListV2 = NULL; --Reset Value\r\n\t\t\t\tSELECT @SelColListV2 = COALESCE(@SelColListV2 + N', S.[' + ColumnName + N'], T.[' + ColumnName + N']', 'S.[' + ColumnName + N'], T.[' + ColumnName + N']')\r\n\t\t\t\tFROM @TableColumns\r\n\t\t\t\tORDER BY ColID ASC;\r\n\t\t\t\t--SELECT @SelColListV2;\r\n\t\t\t\t--\r\n\t\t\t\tSET @OnColList = NULL; --Reset Value\r\n\t\t\t\tSELECT @OnColList = COALESCE(@OnColList + N' AND T.[' + ColumnName + N'] = S.[' + ColumnName + N']', 'T.[' + ColumnName + N'] = S.[' + ColumnName + N']')\r\n\t\t\t\tFROM @TableColumns\r\n\t\t\t\tWHERE IsPrimaryKeyCol = 1\r\n\t\t\t\tORDER BY ColID ASC;\r\n\t\t\t\t--SELECT @OnColList;\r\n\t\t\t\t--\r\n\t\t\t\tSET @WhereColList = NULL; --Reset Value\r\n\t\t\t\tSELECT @WhereColList = COALESCE(@WhereColList +\r\n\t\t\t\t\t\t\tCASE\r\n\t\t\t\t\t\t\t\tWHEN ColumnDataType IN ('xml', 'text') THEN ' OR ISNULL(CONVERT(NVARCHAR(MAX), T.[' + ColumnName + '])COLLATE DATABASE_DEFAULT, '''') != ISNULL(CONVERT(NVARCHAR(MAX), S.[' + ColumnName + '])COLLATE DATABASE_DEFAULT, '''')'\r\n\t\t\t\t\t\t\t\tWHEN ColumnDataType = 'varbinary' THEN ' OR ISNULL(T.[' + ColumnName + '], 0) != ISNULL(S.[' + ColumnName + '], 0)'\r\n\t\t\t\t\t\t\t\tELSE ' OR ISNULL(T.[' + ColumnName + '], '''') != ISNULL(S.[' + ColumnName + '], '''')' END, \r\n\t\t\t\t\t\t\tCASE\r\n\t\t\t\t\t\t\t\tWHEN ColumnDataType IN ('xml', 'text') THEN 'ISNULL(CONVERT(NVARCHAR(MAX), T.[' + ColumnName + '])COLLATE DATABASE_DEFAULT, '''') != ISNULL(CONVERT(NVARCHAR(MAX), S.[' + ColumnName + '])COLLATE DATABASE_DEFAULT, '''')'\r\n\t\t\t\t\t\t\t\tWHEN ColumnDataType = 'varbinary' THEN 'ISNULL(T.[' + ColumnName + '], 0) != ISNULL(S.[' + ColumnName + '], 0)'\r\n\t\t\t\t\t\t\t\tELSE 'ISNULL(T.[' + ColumnName + '], '''') != ISNULL(S.[' + ColumnName + '], '''')' END)\r\n\t\t\t\tFROM @TableColumns\r\n\t\t\t\tWHERE IsPrimaryKeyCol <> 1 --Exclude PrimaryKey Columns\r\n\t\t\t\t\tAND IsIdentityCol <> 1 --Exclude Identity Columns\r\n\t\t\t\t\tAND IsComputedCol <> 1 --Exclude Computed Columns\r\n\t\t\t\tORDER BY ColID ASC;\r\n\t\t\t\t--SELECT @WhereColList;\r\n\t\t\t\t--$EndRegion: ValidateQuery Formation PreRequisites\r\n\t\t\t\t--\r\n\t\t\t\t--$BeginRegion: ValidateQuery V1 Formation w.r.to @SCH and @TBL\r\n\t\t\t\tUPDATE #COMPARISONTABLE\r\n\t\t\t\tSET ValidateQueryV1 = (\r\n\t\t\t\t\t\t\t\t\t\tSELECT 'SELECT ' + @SelColListV1S + ', ' + '''|'' as \"O\", ' + @SelColListV1T + ' ' +\r\n\t\t\t\t\t\t\t\t\t\t'FROM [' + @ReferDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS S ' +\r\n\t\t\t\t\t\t\t\t\t\t'FULL OUTER JOIN [' + @CheckDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS T ' +\r\n\t\t\t\t\t\t\t\t\t\t'\tON ' + @OnColList + ' ' +\r\n\t\t\t\t\t\t\t\t\t\t'WHERE ' + @WhereColList +';'\r\n\t\t\t\t\t\t\t\t\t  )\r\n\t\t\t\tWHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\t\t\t--$EndRegion: ValidateQuery V1 Formation w.r.to @SCH and @TBL\r\n\t\t\t\t--\r\n\t\t\t\tIF @DetialedOUT = 1\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\t--$BeginRegion: Getting RowsUPD (For Updated or Modified Records Only)\r\n\t\t\t\t\tSELECT @RowCount = NULL; --Reset Value\r\n\t\t\t\t\tSET @SQLcmd = N'SELECT @RowCountOUT = COUNT(*) FROM [' + @ReferDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS S ' +\r\n\t\t\t\t\t\t\t\t\t'INNER JOIN [' + @CheckDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS T ' +\r\n\t\t\t\t\t\t\t\t\t'\tON ' + @OnColList + ' ' +\r\n\t\t\t\t\t\t\t\t\t'WHERE ' + @WhereColList +';';\r\n\t\t\t\t\tEXECUTE sys.sp_executesql @Command = @SQLcmd, @Param = N'@RowCountOUT INT OUTPUT', @RowCountOUT = @RowCount OUTPUT;\r\n\t\t\t\t\tUPDATE #COMPARISONTABLE SET RowsUPD = @RowCount WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\t\t\t\t--$EndRegion: Getting RowsUPD (For Updated or Modified Records Only)\r\n\t\t\t\t\t--\r\n\t\t\t\t\t--$BeginRegion: ValidateQuery V2 Formation w.r.to @SCH and @TBL\r\n\t\t\t\t\tUPDATE #COMPARISONTABLE\r\n\t\t\t\t\tSET ValidateQueryV2 = (\r\n\t\t\t\t\t\t\t\t\t\t\tSELECT 'SELECT ' + @SelColListV2 + ' ' +\r\n\t\t\t\t\t\t\t\t\t\t\t'FROM [' + @ReferDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS S ' +\r\n\t\t\t\t\t\t\t\t\t\t\t'FULL OUTER JOIN [' + @CheckDatabase + '].[' + @SCHname + '].[' + @TBLname + '] AS T ' +\r\n\t\t\t\t\t\t\t\t\t\t\t'\tON ' + @OnColList + ' ' +\r\n\t\t\t\t\t\t\t\t\t\t\t'WHERE ' + @WhereColList +';'\r\n\t\t\t\t\t\t\t\t\t\t  )\r\n\t\t\t\t\tWHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\t\t\t\t--$EndRegion: ValidateQuery V2 Formation w.r.to @SCH and @TBL\r\n\t\t\t\tEND\r\n\t\t\t\t--\r\n\t\t\tEND TRY\r\n\t\t\tBEGIN CATCH\r\n\t\t\t\tUPDATE #COMPARISONTABLE SET Remarks = ERROR_MESSAGE() WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\t\t\t--SELECT 'ERROR::' AS \"MSG\", @SCHname AS SchemaName, @TBLname AS TableName, ERROR_MESSAGE() AS \"ErrorMessage\";\r\n\t\t\t\t--DELETE FROM #COMPARISONTABLE WHERE SchemaName = @SCHname AND TableName = @TBLname; -- Access Error Reading from Remote Table\r\n\t\t\tEND CATCH;\r\n\t\t\t--$EndRegion: ReferRowCount from Refer Database Table\r\n\t\tEND TRY\r\n\t\tBEGIN CATCH\r\n\t\t\tUPDATE #COMPARISONTABLE SET Remarks = ERROR_MESSAGE() WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\t\t--SELECT 'ERROR::' AS \"MSG\", @SCHname AS SchemaName, @TBLname AS TableName, ERROR_MESSAGE() AS \"ErrorMessage\";\r\n\t\t\t--DELETE FROM #COMPARISONTABLE WHERE SchemaName = @SCHname AND TableName = @TBLname; -- Access Error Reading from Remote Table\r\n\t\t\tSELECT @RowCount = NULL; --Reset Value\r\n\t\t\tSET @SQLcmd = N'SELECT @RowCountOUT = COUNT(*) FROM [' + @ReferDatabase + N'].[' + @SCHname + N'].[' + @TBLname + '];';\r\n\t\t\tEXECUTE sys.sp_executesql @Command = @SQLcmd, @Param = N'@RowCountOUT INT OUTPUT', @RowCountOUT = @RowCount OUTPUT;\r\n\t\t\tUPDATE #COMPARISONTABLE SET ReferRowCount = @RowCount WHERE SchemaName = @SCHname AND TableName = @TBLname;\r\n\t\tEND CATCH;\r\n\t\t--\r\n\t\tFETCH NEXT FROM TableCursor INTO @SCHname, @TBLname;\r\n\tEND;\r\nCLOSE TableCursor;\r\nDEALLOCATE TableCursor;\r\n--$EndRegion: Cursor for Each Table\r\n--\r\nSELECT\tSchemaName, TableName, ReferRowCount, CheckRowCount, RowsDEL, RowsINS, RowsUPD,\r\n\t\tValidateQueryV1 AS \"ValidateQuery (Preferred For RowsINS or RowsDEL)\", ValidateQueryV2  AS \"ValidateQuery (Preferred For RowsUPD)\",\r\n\t\tRemarks\r\nFROM #COMPARISONTABLE\r\nWHERE RowsINS <> 0 OR RowsDEL <> 0 OR RowsUPD <> 0 OR ReferRowCount IS NULL OR CheckRowCount IS NULL\r\nORDER BY SchemaName, TableName ASC;",
  "placeholders": [
    {
      "name": "ReferDatabase",
      "defaultValue": null
    },
    {
      "name": "CheckDatabase",
      "defaultValue": null
    }
  ]
}
