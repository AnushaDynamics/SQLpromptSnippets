{
  "id": "7f9b9a4b-2003-43be-aa22-bc644062939c",
  "prefix": "GetTableRowCountDifference",
  "description": "Get Table Row Count Difference between Local and Remote Databases",
  "body": "/* =================================================================================================\r\n-- Script\t\t: GetRowCountDifference\r\n-- Description\t: Get Table Row Count Difference between Local and Remote Databases\r\n================================================================================================= */\r\nDECLARE @ReferenceDatabase VARCHAR(256) = '$ReferenceDatabase$'; --Local Database\r\nDECLARE @CheckDatabase VARCHAR(256) = '$CheckDatabase$'; --Remote Database\r\n/** DONOT CHANGE CODE BELOW ***********************************************************************/\r\nDECLARE @SCHname VARCHAR(256), @TBLname VARCHAR(1024);\r\nDECLARE @SchemaName NVARCHAR(1024), @TableName NVARCHAR(1024), @RowCount NVARCHAR(1024);\r\nDECLARE @SQLcmd NVARCHAR(MAX);\r\nDECLARE @ParmDefinition NVARCHAR(1024);\r\n--\r\n--$BeginRegion: Get TableList from Reference Database\r\nDECLARE @TableList TABLE (SCHname VARCHAR(256) NULL, TBLname VARCHAR(1024) NULL);\r\nSET @SQLcmd = N'SELECT TABLE_SCHEMA, TABLE_NAME FROM ' + @ReferenceDatabase + N'.INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = ''BASE TABLE''';\r\nINSERT INTO @TableList (SCHname, TBLname)\r\nEXECUTE sys.sp_executesql @SQLcmd;\r\n--$EndRegion: Get TableList from Reference Database\r\n--\r\n--$BeginRegion: RowCount Difference Check\r\nDECLARE @COMPARISONTABLE TABLE (Id INT IDENTITY, SchemaName VARCHAR(256) NULL, TableName VARCHAR(1024) NULL, ReferenceRowCount INT NULL, CheckRowCount INT NULL, RowDiff INT NULL);\r\nSET @ParmDefinition = N'@SchemaName NVARCHAR(1024) OUTPUT, @TableName NVARCHAR(1024) OUTPUT, @RowCount NVARCHAR(1024) OUTPUT';\r\nDECLARE TableCursor CURSOR FOR SELECT SCHname, TBLname FROM @TableList;\r\nOPEN TableCursor;\r\nFETCH NEXT FROM TableCursor INTO @SCHname, @TBLname;\r\nWHILE @@FETCH_STATUS = 0\r\n\tBEGIN\r\n\t\t--$BeginRegion: RowCount from Reference Database Table\r\n\t\tSELECT @SchemaName = NULL, @TableName = NULL, @RowCount = NULL;\r\n\t\tSET @SQLcmd = N'SELECT @RowCount=CAST(COUNT(*) AS NVARCHAR(1024)), @SchemaName=''' + @SCHname + N''', @TableName=''' + @TBLname + N''' FROM ' + @ReferenceDatabase + N'.' + @SCHname + N'.' + @TBLname;\r\n\t\tEXECUTE sys.sp_executesql @SQLcmd, @ParmDefinition, @RowCount = @RowCount OUTPUT, @SchemaName = @SchemaName OUTPUT, @TableName = @TableName OUTPUT;\r\n\t\tINSERT INTO @COMPARISONTABLE (SchemaName, TableName, ReferenceRowCount) VALUES (@SchemaName, @TableName, @RowCount);\r\n\t\t--$EndRegion: RowCount from Reference Database Table\r\n\t\t--\r\n\t\t--$BeginRegion: RowCount from Check Database Table\r\n\t\tSELECT @SchemaName = NULL, @TableName = NULL, @RowCount = NULL;\r\n\t\tBEGIN TRY\r\n\t\t\tSET @SQLcmd = N'SELECT @RowCount=CAST(COUNT(*) AS NVARCHAR(1024)), @SchemaName=''' + @SCHname + N''', @TableName=''' + @TBLname + N''' FROM ' + @CheckDatabase + N'.' + @SCHname + N'.' + @TBLname;\r\n\t\t\tEXECUTE sys.sp_executesql @SQLcmd, @ParmDefinition, @RowCount = @RowCount OUTPUT, @SchemaName = @SchemaName OUTPUT, @TableName = @TableName OUTPUT;\r\n\t\t\tUPDATE @COMPARISONTABLE SET CheckRowCount = @RowCount WHERE SchemaName = @SchemaName AND TableName = @TableName;\r\n\t\t\tUPDATE @COMPARISONTABLE SET RowDiff = (CheckRowCount - ReferenceRowCount) WHERE SchemaName = @SchemaName AND TableName = @TableName;\r\n\t\tEND TRY\r\n\t\tBEGIN CATCH\r\n\t\t\tDELETE FROM @COMPARISONTABLE WHERE SchemaName = @SchemaName AND TableName = @TBLname;-- Access Error Reading from Remote Table\r\n\t\tEND CATCH;\r\n\t\t--$EndRegion: RowCount from Check Database Table\r\n\t\tFETCH NEXT FROM TableCursor INTO @SCHname, @TBLname;\r\n\tEND;\r\nCLOSE TableCursor;\r\nDEALLOCATE TableCursor;\r\n--$EndRegion: RowCount Difference Check\r\n--\r\nSELECT Id, SchemaName, TableName, ReferenceRowCount, CheckRowCount, RowDiff\r\nFROM @COMPARISONTABLE\r\nWHERE RowDiff <> 0;",
  "placeholders": [
    {
      "name": "ReferenceDatabase",
      "defaultValue": null
    },
    {
      "name": "CheckDatabase",
      "defaultValue": null
    }
  ]
}