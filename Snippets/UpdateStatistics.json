{
  "id": "2941b25d-1638-4b21-986c-5cb185000c48",
  "prefix": "UpdateStatistics",
  "description": "Update Statistics Excluding System Generated Statistics",
  "body": "/* =========================================================================================================================================\r\n-- Script\t\t: UpdateStatistics\r\n-- Description\t: Update UserTable Statistics Excluding System Generated Statistics\r\n-- Usage\t\t: This Updates the STATS which are Modified in Last 7 Days\r\n--\t\t\t\t\tChange the WHERE Clause to Include OR Exclude STATS Accordingly\r\n----$BeginRegion: Update Statstics Similar to OlaHallengren\r\n\tEXECUTE dbo.IndexOptimize\r\n\t\t@Databases = 'w3schools',\r\n\t\t@FragmentationLow = NULL,\r\n\t\t@FragmentationMedium = NULL,\r\n\t\t@FragmentationHigh = NULL,\r\n\t\t@UpdateStatistics = 'ALL',\r\n\t\t@OnlyModifiedStatistics = 'Y';\r\n----$EndRegion: Update Statstics Similar to OlaHallengren\r\n========================================================================================================================================= */\r\nDECLARE @SCHname VARCHAR(128), @TBLname VARCHAR(128), @STATSname VARCHAR(256);\r\nDECLARE @SQLcmd NVARCHAR(MAX) = N'';\r\nDECLARE StatsCursor CURSOR FAST_FORWARD LOCAL FOR\r\n(\r\n\tSELECT OBJECT_SCHEMA_NAME(ST.object_id) AS \"SchemaName\",\r\n\t\t   OBJECT_NAME(ST.object_id) AS \"TableName\",\r\n\t\t   ST.name AS \"StatsName\"\r\n\tFROM sys.stats AS ST\r\n\tCROSS APPLY sys.dm_db_stats_properties(ST.object_id, ST.stats_id) AS SP\r\n\tWHERE 1 = 1\r\n\t\t  AND OBJECTPROPERTY(ST.object_id, 'IsUserTable') = 1 --Stats Only For User Created Tables\r\n\t\t  AND STATS_DATE(ST.object_id, ST.stats_id) <= DATEADD(DAY, -7, GETDATE()) --Stats Last Updated Date Less Than 7 Days\r\n\t\t  AND SP.modification_counter > 0 --Stats Modified from Last Updated\r\n\t\t  AND ST.name NOT LIKE '_WA_Sys_%' --Excluding System Stats\r\n\t\t  --AND OBJECT_SCHEMA_NAME(ST.object_id) NOT IN ('', '') --Exclude Schemas\r\n\t\t  --AND OBJECT_NAME(ST.object_id) NOT IN ('', '') --Exclude Tables\r\n)\r\nOPEN StatsCursor;\r\nFETCH NEXT FROM StatsCursor INTO @SCHname, @TBLname, @STATSname;\r\nWHILE @@FETCH_STATUS = 0\r\n    BEGIN\r\n        SET @SQLcmd = N'UPDATE STATISTICS ' + QUOTENAME(@SCHname) + N'.' + QUOTENAME(@TBLname) + N' ' + QUOTENAME(@STATSname) + N';';\r\n        EXEC sys.sp_executesql @command = @SQLcmd;\r\n        --\r\n        FETCH NEXT FROM StatsCursor INTO @SCHname, @TBLname, @STATSname;\r\n    END;\r\nCLOSE StatsCursor;\r\nDEALLOCATE StatsCursor;"
}