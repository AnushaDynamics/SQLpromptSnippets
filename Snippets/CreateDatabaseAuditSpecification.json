{
  "id": "0392bd4d-5748-41aa-9dc7-96e1e80f4501",
  "prefix": "CreateDatabaseAuditSpecification",
  "description": "Creates a Database Audit Specification object using the SQL Server Audit Feature",
  "body": "/* =============================================================================================================================================================\r\n-- Server\t\t: LOCALSERVER\r\n-- Database\t\t: master\r\n-- Script\t\t: Create Database Audit Specification\r\n-- Description\t: Creates a database audit specification object using the SQL Server audit feature\r\n-- Usage\t\t:\r\n-- History\t\t:\r\n-- Refer Links\t: https://docs.microsoft.com/en-us/sql/t-sql/statements/create-database-audit-specification-transact-sql?view=sql-server-ver15\r\n============================================================================================================================================================= */\r\n--$BeginRegion: Enable CMDshell and Create Audit Folder\r\n-- To Turn ON Advanced Options\r\nEXEC sys.sp_configure 'show advanced options', '1';\r\nRECONFIGURE;\r\n\r\n-- To Enable xp_cmdshell\r\nEXEC sys.sp_configure 'xp_cmdshell', '1';\r\nRECONFIGURE;\r\n\r\n-- To Turn OFF Advanced Options\r\nEXEC sys.sp_configure 'show advanced options', '0';\r\nRECONFIGURE;\r\n\r\n-- Create FolderPath for Audit Files\r\nEXEC sys.xp_cmdshell @command='mkdir \"C:\\SQL\\Audit\\\"';\r\nGO\r\n--$EndRegion: Enable CMDshell and Create Audit Folder\r\n--\r\n\r\n--$BeginRegion: Drop Database Audit and Then Server Audit\r\n-- Object:  Drop Database Audit [DMLwatchdog] ******/\r\n\r\nUSE w3schools;\r\nGO\r\nIF\tEXISTS (SELECT * FROM sys.database_audit_specifications WHERE name ='DMLwatchdog') --\r\nBEGIN\r\n\tALTER DATABASE AUDIT SPECIFICATION DMLwatchdog --\r\n\tWITH(STATE=OFF);\r\n\tDROP DATABASE AUDIT SPECIFICATION DMLwatchdog;\r\nEND;\r\nGO\r\n\r\n-- Object:  Drop Server Audit [ServerAudit] ******/\r\nUSE master;\r\nGO\r\nIF EXISTS (SELECT * FROM sys.server_audits WHERE name ='ServerAudit') --\r\nBEGIN\r\n\tALTER SERVER AUDIT ServerAudit --\r\n\tWITH(STATE=OFF);\r\n\tDROP SERVER AUDIT ServerAudit;\r\nEND;\r\nGO\r\n\r\n-- Delete All Audit Files\r\nEXEC sys.xp_cmdshell @command='forfiles -p \"C:\\SQL\\Audit\" -d -0 -c \"cmd /c del /f /q @path\"';\r\nGO\r\n--$EndRegion: Drop Database Audit and Then Server Audit\r\n--\r\n\r\n--$BeginRegion: Create Server Audit and Then Database Audit\r\n-- Object:  Create Server Audit [ServerAudit] ******/\r\n\r\nUSE master;\r\nGO\r\nIF NOT EXISTS (SELECT * FROM sys.server_audits WHERE name ='ServerAudit') --\r\nBEGIN\r\n\tCREATE\tSERVER AUDIT ServerAudit --\r\n\tTO FILE --\r\n\t\t( --\r\n\t\t\tFILEPATH=N'C:\\SQL\\Audit\\', --\r\n\t\t\tMAXSIZE=10MB, --\r\n\t\t\tMAX_ROLLOVER_FILES=2, --\r\n\t\t\tRESERVE_DISK_SPACE=ON --\r\n\t\t)\r\n\tWITH(QUEUE_DELAY=1000, ON_FAILURE=CONTINUE);\r\n\r\n\t--\r\n\tALTER\tSERVER AUDIT ServerAudit --\r\n\tWITH(STATE=ON);\r\nEND;\r\nGO\r\n\r\n-- Object:  Create Database DML Audit [DMLwatchdog] ******/\r\nUSE w3schools;\r\nGO\r\nIF\tNOT EXISTS (SELECT * FROM sys.database_audit_specifications WHERE name ='DMLwatchdog') --\r\nBEGIN\r\n\tCREATE\tDATABASE AUDIT SPECIFICATION DMLwatchdog\r\n\tFOR SERVER AUDIT ServerAudit\r\n\t\t--ADD(SELECT ON SCHEMA::[dbo] BY [public]), --\r\n\t\tADD(DELETE ON SCHEMA::[dbo] BY [public]), --\r\n\t\tADD(INSERT ON SCHEMA::[dbo] BY [public]), --\r\n\t\tADD(UPDATE ON SCHEMA::[dbo] BY [public]), --\r\n\t\tADD(EXECUTE ON SCHEMA::[dbo] BY [public]), --\r\n\t\tADD(RECEIVE ON SCHEMA::[dbo] BY [public]), --\r\n\t\tADD(REFERENCES ON SCHEMA::[dbo] BY [public])\r\n\tWITH(STATE=ON);\r\nEND;\r\nGO\r\n--$EndRegion: Create Server Audit and Then Database Audit\r\n--\r\n\r\n--$BeginRegion: Monitoring and Querying the SQLAUDIT File\r\n\r\nSELECT\tevent_time, action_id, schema_name, object_name, statement\r\nFROM\tsys.fn_get_audit_file('C:\\SQL\\Audit\\ServerAudit_*.sqlaudit', DEFAULT, DEFAULT)\r\nORDER BY event_time ASC;\r\nGO\r\n--$EndRegion: Monitoring and Querying the SQLAUDIT File\r\n--\r\n--\r\n\r\nRETURN\t;\r\n--$BeginRegion: CleanUp Activity for Audit and Files\r\n/*\r\n-- Object:  Drop Database Audit [DMLwatchdog]\r\nUSE w3schools;\r\nGO\r\nIF\tEXISTS (SELECT * FROM sys.database_audit_specifications WHERE name ='DMLwatchdog') --\r\nBEGIN\r\n\tALTER DATABASE AUDIT SPECIFICATION DMLwatchdog --\r\n\tWITH(STATE=OFF);\r\n\tDROP DATABASE AUDIT SPECIFICATION DMLwatchdog;\r\nEND;\r\nGO\r\n\r\n-- Object:  Drop Server Audit [ServerAudit]\r\nUSE master;\r\nGO\r\nIF EXISTS (SELECT * FROM sys.server_audits WHERE name ='ServerAudit') --\r\nBEGIN\r\n\tALTER SERVER AUDIT ServerAudit --\r\n\tWITH(STATE=OFF);\r\n\tDROP SERVER AUDIT ServerAudit;\r\nEND;\r\nGO\r\n\r\n-- Delete All Audit Files\r\nEXEC sys.xp_cmdshell @command='forfiles -p \"C:\\SQL\\Audit\" -d -0 -c \"cmd /c del /f /q @path\"';\r\nGO\r\n*/\r\n--$EndRegion: CleanUp Activity for Audit and Files"
}