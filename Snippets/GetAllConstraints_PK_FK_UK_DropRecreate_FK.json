{
  "id": "14b2e8b8-5b41-4ce3-a3fa-8b04f4e8575b",
  "prefix": "GetAllConstraints_PK_FK_UK_DropRecreate_FK",
  "description": "To Get Details of All Constraints like PK, FK, UK etc and Generate FK Drop and Recreate Statements",
  "body": "/* =========================================================================================================================================\r\n-- Script\t\t: Get_All_Constraints_And_PK_FK_Relations_Between_Tables(PK_FK_UK)\r\n-- Description\t: To Get Details of All Constraints like 'PRIMARY_KEY_CONSTRAINT', 'FOREIGN_KEY_CONSTRAINT', 'UNIQUE_CONSTRAINT'\r\n--\t\t\t\t  Retrives All Complex Relations like Composite Primary Keys, Foreign Keys And Respective Columns with CASCADE.\r\n--\t\t\t\t  Generate Drop and Create Scripts for the Foreign Keys Constraints.\r\n-- Server\t\t: LOCALHOST\r\n-- Database\t\t: USER Database\r\n========================================================================================================================================= */\r\nSELECT --\r\n\tCTE.CONSTRAINT_NAME,\r\n\tCTE.CONSTRAINT_TYPE,\r\n\tREPLACE(ISNULL(CTE.[ON_DELETE?], ''), 'NO_ACTION', '') AS \"ON_DELETE?\",\r\n\tREPLACE(ISNULL(CTE.[ON_UPDATE?], ''), 'NO_ACTION', '') AS \"ON_UPDATE?\",\r\n\tISNULL(CTE.[IS_ENABLED?], '') AS \"IS_ENABLED?\",\r\n\tISNULL(CTE.[IS_TRUSTED?], '') AS \"IS_TRUSTED?\",\r\n\t'|' AS \"||\",\r\n\tCTE.MAIN_TABLE_SCHEMA,\r\n\tCTE.MAIN_TABLE_NAME,\r\n\tCASE CTE.CONSTRAINT_TYPE\r\n\t\tWHEN 'PRIMARY_KEY_CONSTRAINT' THEN 'PK: ' + CASE WHEN (CHARINDEX(',', CTE.MAIN_TABLE_COLUMNS) > 0) THEN '( ' + CTE.MAIN_TABLE_COLUMNS + ' )' ELSE CTE.MAIN_TABLE_COLUMNS END\r\n\t\tWHEN 'FOREIGN_KEY_CONSTRAINT' THEN 'FK: ' + CASE WHEN (CHARINDEX(',', CTE.MAIN_TABLE_COLUMNS) > 0) THEN '( ' + CTE.MAIN_TABLE_COLUMNS + ' )' ELSE CTE.MAIN_TABLE_COLUMNS END\r\n\t\tWHEN 'UNIQUE_CONSTRAINT' THEN 'UK: ' + CASE WHEN (CHARINDEX(',', CTE.MAIN_TABLE_COLUMNS) > 0) THEN '( ' + CTE.MAIN_TABLE_COLUMNS + ' )' ELSE CTE.MAIN_TABLE_COLUMNS END\r\n\t\tELSE ''\r\n\t\tEND AS \"MAIN_TABLE_COLUMNS\",\r\n\tCASE WHEN (CTE.CONSTRAINT_TYPE = 'FOREIGN_KEY_CONSTRAINT') THEN '=>' ELSE '  |' END AS \"=>\",\r\n\tISNULL(CTE.REFER_TABLE_SCHEMA, '') AS REFER_TABLE_SCHEMA,\r\n\tISNULL(CTE.REFER_TABLE_NAME, '') AS REFER_TABLE_NAME,\r\n\tISNULL('PK: ' + CASE WHEN (CHARINDEX(',', CTE.REFER_TABLE_COLUMNS) > 0) THEN '( ' + CTE.REFER_TABLE_COLUMNS + ' )' ELSE CTE.REFER_TABLE_COLUMNS END, '') AS \"REFER_TABLE_COLUMNS\",\r\n\t'|' AS \"|||\",\r\n\tISNULL(CASE CTE.CONSTRAINT_TYPE\r\n\t\t\tWHEN 'FOREIGN_KEY_CONSTRAINT'\r\n\t\t\t\tTHEN 'FK:: Columns \" ' + CTE.MAIN_TABLE_COLUMNS + ' \" in Table \" ' + CTE.MAIN_TABLE_SCHEMA + '.' + CTE.MAIN_TABLE_NAME + ' \"' \r\n\t\t\t\t\t+ ' => REFERENCES => ' + 'PK:: Columns \" ' + CTE.REFER_TABLE_COLUMNS + ' \" in Table \" ' + CTE.REFER_TABLE_SCHEMA + '.' + CTE.REFER_TABLE_NAME + ' \"'\r\n\t\t\tELSE NULL\r\n\t\t\tEND, '') AS \"PRIMARYKEY_FOREIGNKEY_NOTATION\",\r\n\tISNULL(CTE.DROP_CONSTRAINT_STATEMENT, '') AS DROP_CONSTRAINT_STATEMENT,\r\n\tISNULL(CTE.RECREATE_CONSTRAINT_STATEMENT, '') AS RECREATE_CONSTRAINT_STATEMENT\r\nFROM \r\n(\r\n\t--$BeginRegion: Getting Primary Keys and Unique Keys\r\n\tSELECT --\r\n\t\tKC.name AS CONSTRAINT_NAME,\r\n\t\tKC.type_desc AS CONSTRAINT_TYPE,\r\n\t\tNULL AS \"ON_UPDATE?\",\r\n\t\tNULL AS \"ON_DELETE?\",\r\n\t\tNULL AS \"IS_ENABLED?\",\r\n\t\tNULL AS \"IS_TRUSTED?\",\r\n\t\t--'|' AS \"||\"\r\n\t\tOBJECT_SCHEMA_NAME(KC.parent_object_id) AS MAIN_TABLE_SCHEMA,\r\n\t\tOBJECT_NAME(KC.parent_object_id) AS MAIN_TABLE_NAME,\r\n\t\tSTUFF((SELECT ', ' + C.NAME\r\n\t\t\t\tFROM sys.columns AS C\r\n\t\t\t\tINNER JOIN sys.index_columns AS IC ON IC.object_id = C.object_id AND IC.column_id = C.column_id\r\n\t\t\t\tWHERE C.object_id = KC.parent_object_id AND IC.index_id = KC.unique_index_id\r\n\t\t\t\tORDER BY IC.key_ordinal ASC FOR XML PATH('')), 1, 2, '') AS MAIN_TABLE_COLUMNS,\r\n\t\t--'' AS \"=>\",\r\n\t\tNULL AS REFER_TABLE_SCHEMA,\r\n\t\tNULL AS REFER_TABLE_NAME,\r\n\t\tNULL AS REFER_TABLE_COLUMNS,\r\n\t\t--'|' AS \"|||\",\r\n\t\tNULL AS \"DROP_CONSTRAINT_STATEMENT\",\r\n\t\tNULL AS \"RECREATE_CONSTRAINT_STATEMENT\"\r\n\tFROM sys.key_constraints AS KC\r\n\t--$EndRegion: Getting Primary Keys and Unique Keys\r\n\tUNION ALL\r\n\t--$BeginRegion: Getting Foreign Keys and Statements\r\n\tSELECT --\r\n\t\t--$BeginRegion: Foreign Keys\r\n\t\tFK.NAME AS CONSTRAINT_NAME,\r\n\t\tFK.type_desc AS CONSTRAINT_TYPE,\r\n\t\tFK.update_referential_action_desc AS \"ON_UPDATE?\",\r\n\t\tFK.delete_referential_action_desc AS \"ON_DELETE?\",\r\n\t\tCASE FK.is_disabled WHEN 0 THEN 'YES' ELSE 'NO' END AS \"IS_ENABLED?\",\r\n\t\tCASE FK.is_not_trusted WHEN 0 THEN 'YES' ELSE 'NO' END AS \"IS_TRUSTED?\",\r\n\t\t--'|' AS \"||\"\r\n\t\tOBJECT_SCHEMA_NAME(FK.parent_object_id) AS MAIN_TABLE_SCHEMA,\r\n\t\tOBJECT_NAME(FK.parent_object_id) AS MAIN_TABLE_NAME,\r\n\t\tSTUFF((SELECT ', ' + C.NAME\r\n\t\t\t\tFROM sys.columns AS C\r\n\t\t\t\tINNER JOIN sys.foreign_key_columns AS KC ON C.object_id = KC.parent_object_id AND C.column_id = KC.parent_column_id\r\n\t\t\t\tWHERE KC.constraint_object_id = FK.object_id\r\n\t\t\t\tORDER BY KC.constraint_column_id FOR XML PATH('')), 1, 2, '') AS MAIN_TABLE_COLUMNS,\r\n\t\t--'' AS \"=>\",\r\n\t\tOBJECT_SCHEMA_NAME(FK.referenced_object_id) AS REFER_TABLE_SCHEMA,\r\n\t\tOBJECT_NAME(FK.referenced_object_id) AS REFER_TABLE_NAME,\r\n\t\tSTUFF((SELECT ', ' + C.name\r\n\t\t\t\tFROM sys.columns AS C\r\n\t\t\t\tINNER JOIN sys.foreign_key_columns AS KC ON C.object_id = KC.referenced_object_id AND C.column_id = KC.referenced_column_id\r\n\t\t\t\tWHERE KC.constraint_object_id = FK.object_id\r\n\t\t\t\tORDER BY KC.constraint_column_id FOR XML PATH('')), 1, 2, '') AS REFER_TABLE_COLUMNS,\r\n\t\t--$EndRegion: Foreign Keys\r\n\t\t--'|' AS \"|||\",\r\n\t\t--$BeginRegion: Generate Drop Foreign Keys Statements\r\n\t\t'IF OBJECT_ID(''' + QUOTENAME(OBJECT_SCHEMA_NAME(FK.parent_object_id)) + '.' + QUOTENAME(FK.NAME) + ''', ''F'') IS NOT NULL'\r\n\t\t\t+ ' ALTER TABLE ' + QUOTENAME(OBJECT_SCHEMA_NAME(FK.parent_object_id)) + '.' + QUOTENAME(OBJECT_NAME(FK.parent_object_id))\r\n\t\t\t+ ' DROP CONSTRAINT ' + QUOTENAME(FK.NAME)\r\n\t\t\t+ ';' \r\n\t\t\tAS \"DROP_CONSTRAINT_STATEMENT\",\r\n\t\t--$EndRegion: Generate Drop Foreign Keys Statements\r\n\t\t--\r\n\t\t--$BeginRegion: Generate ReCreate Foreign Keys Statements\r\n\t\t'IF OBJECT_ID(''' + QUOTENAME(OBJECT_SCHEMA_NAME(FK.parent_object_id)) + '.' + QUOTENAME(FK.NAME) + ''', ''F'') IS NULL'\r\n\t\t\t+ ' BEGIN'\r\n\t\t\t+ ' ALTER TABLE ' + QUOTENAME(OBJECT_SCHEMA_NAME(FK.parent_object_id)) + '.' + QUOTENAME(OBJECT_NAME(FK.parent_object_id))\r\n\t\t\t+ ' WITH ' + CASE FK.is_not_trusted WHEN 0 THEN 'CHECK' ELSE 'NOCHECK' END\r\n\t\t\t+ ' ADD CONSTRAINT ' + QUOTENAME(OBJECT_NAME(FK.object_id))\r\n\t\t\t+ ' FOREIGN KEY'\r\n\t\t\t+ ' (' + STUFF((SELECT ', ' + QUOTENAME(C.NAME)\r\n\t\t\t\t\t\t\tFROM sys.columns AS C\r\n\t\t\t\t\t\t\tINNER JOIN sys.foreign_key_columns AS KC ON C.object_id = KC.parent_object_id AND C.column_id = KC.parent_column_id\r\n\t\t\t\t\t\t\tWHERE KC.constraint_object_id = FK.object_id\r\n\t\t\t\t\t\t\tORDER BY KC.constraint_column_id FOR XML PATH('')), 1, 1, '') + ' )'\r\n\t\t\t+ ' REFERENCES ' + QUOTENAME(OBJECT_SCHEMA_NAME(FK.referenced_object_id)) + '.' + QUOTENAME(OBJECT_NAME(FK.referenced_object_id))\r\n\t\t\t+ ' (' + STUFF((SELECT ', ' + QUOTENAME(C.NAME)\r\n\t\t\t\t\t\t\tFROM sys.columns AS C\r\n\t\t\t\t\t\t\tINNER JOIN sys.foreign_key_columns AS KC ON C.object_id = KC.referenced_object_id AND C.column_id = KC.referenced_column_id\r\n\t\t\t\t\t\t\tWHERE KC.constraint_object_id = FK.object_id\r\n\t\t\t\t\t\t\tORDER BY KC.constraint_column_id FOR XML PATH('')), 1, 1, '') + ' )'\r\n\t\t\t+ ' ON DELETE ' + CASE FK.delete_referential_action WHEN 1 THEN 'CASCADE' WHEN 2 THEN 'SET NULL' WHEN 3 THEN 'SET DEFAULT' ELSE 'NO ACTION' END\r\n\t\t\t+ ' ON UPDATE ' + CASE FK.update_referential_action WHEN 1 THEN 'CASCADE' WHEN 2 THEN 'SET NULL' WHEN 3 THEN 'SET DEFAULT' ELSE 'NO ACTION' END\r\n\t\t\t+ CASE FK.is_not_for_replication WHEN 0 THEN '' ELSE ' NOT FOR REPLICATION' END\r\n\t\t\t+ ';'\r\n\t\t\t+ ' ALTER TABLE ' + QUOTENAME(OBJECT_SCHEMA_NAME(FK.parent_object_id)) + '.' + QUOTENAME(OBJECT_NAME(FK.parent_object_id))\r\n\t\t\t+ CASE FK.is_disabled WHEN 0 THEN ' CHECK' ELSE ' NOCHECK' END + ' CONSTRAINT ' + QUOTENAME(OBJECT_NAME(FK.object_id))\r\n\t\t\t+ ';'\r\n\t\t\t+ ' END'\r\n\t\t\tAS \"RECREATE_CONSTRAINT_STATEMENT\"\r\n\t\t--$EndRegion: Generate ReCreate Foreign Keys Statements\r\n\tFROM sys.foreign_keys AS FK\r\n\tWHERE FK.is_ms_shipped = 0\r\n\t--$EndRegion: Getting Foreign Keys and Statements\r\n)\r\nAS CTE\r\nWHERE 1 = 1\r\n\t--AND CONSTRAINT_NAME LIKE '%%'\r\n\t--AND CONSTRAINT_TYPE IN ('PRIMARY_KEY_CONSTRAINT', 'FOREIGN_KEY_CONSTRAINT', 'UNIQUE_CONSTRAINT')\r\n\t--AND [OnDelete?] IN ('NO_ACTION', 'CASCADE', 'SET_NULL', 'SET_DEFAULT')\r\n\t--AND [OnUpdate?] IN ('NO_ACTION', 'CASCADE', 'SET_NULL', 'SET_DEFAULT')\r\n\t--AND [IS_ENABLED?] IN ('YES', 'NO')\r\n\t--AND [IS_TRUSTED?] IN ('YES', 'NO')\r\n\t--AND MAIN_TABLE_SCHEMA LIKE '%%'\r\n\t--AND MAIN_TABLE_NAME LIKE '%%'\r\n\t--AND MAIN_TABLE_COLUMNS LIKE '%%'\r\n\t--AND REFER_TABLE_SCHEMA LIKE '%%'\r\n\t--AND REFER_TABLE_NAME LIKE '%%'\r\n\t--AND REFER_TABLE_COLUMNS LIKE '%%'\r\n"
}