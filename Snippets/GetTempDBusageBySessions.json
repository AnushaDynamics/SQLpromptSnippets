{
  "id": "50927bfd-2c5d-4a83-a6d9-7d5b7c081626",
  "prefix": "GetTempDBusageBySessions",
  "description": "Get TempDB Sessions and Utilization",
  "body": "/* =============================================================================================================================================================\r\n-- Database\t\t: master\r\n-- Script\t\t: GetTempDBusageBySessions\r\n-- Description\t: Get TempDB Sessions and Utilization\r\n-- Refer Links\t: https://github.com/MadeiraData/MadeiraToolbox/blob/master/Monitoring%20Scripts/Find%20TempDB%20Consumers.sql\r\n**Note: Object Types That can use tempdb space-\r\n\t1. User Objects- temp table, table variable\r\n\t2. Internal Objects - query intermidiate results for hash operation\r\n\t3. Version Stores - like snapshot isolation,row version\r\n============================================================================================================================================================= */\r\nSELECT TasksSpaceUsage.SessionId AS \"SessionId\",\r\n\t   TasksSpaceUsage.RequestId AS \"RequestId\",\r\n\t   Sessions.is_user_process AS \"IsUserProcess\",\r\n\t   TasksSpaceUsage.InternalObjectsAllocPageCount AS \"InternalObjectsAllocPageCount\",\r\n\t   TasksSpaceUsage.InternalObjectsDeallocPageCount AS \"InternalObjectsDeallocPageCount\",\r\n\t   TasksSpaceUsage.UserObjectsAllocPageCount AS \"UserObjectsAllocPageCount\",\r\n\t   TasksSpaceUsage.UserObjectsDeallocPageCount AS \"UserObjectsDeallocPageCount\",\r\n\t   RequestsText.text AS \"RequestBatchText\",\r\n\t   ISNULL(NULLIF(SUBSTRING(\t  RequestsText.text,\r\n\t\t\t\t\t\t\t\t  Requests.statement_start_offset / 2,\r\n\t\t\t\t\t\t\t\t  CASE\r\n\t\t\t\t\t\t\t\t\t  WHEN Requests.statement_end_offset < Requests.statement_start_offset THEN 0\r\n\t\t\t\t\t\t\t\t\t  ELSE (Requests.statement_end_offset - Requests.statement_start_offset) / 2\r\n\t\t\t\t\t\t\t\t  END\r\n\t\t\t\t\t\t\t  ), ''\r\n\t\t\t\t\t),\r\n\t\t\t  RequestsText.text\r\n\t\t\t ) AS \"RequestStatement\",\r\n\t   RequestsPlan.query_plan AS \"RequestPlan\",\r\n\t   Sessions.host_name AS \"ClientHostName\",\r\n\t   Sessions.program_name AS \"ClientProgram\",\r\n\t   Sessions.login_name AS \"LoginName\",\r\n\t   Sessions.host_process_id AS \"ClientProcessID\"\r\nFROM (\r\n\t\t SELECT TSU.session_id AS \"SessionId\",\r\n\t\t\t\tTSU.request_id AS \"RequestId\",\r\n\t\t\t\tSUM(TSU.internal_objects_alloc_page_count) AS \"InternalObjectsAllocPageCount\",\r\n\t\t\t\tSUM(TSU.internal_objects_dealloc_page_count) AS \"InternalObjectsDeallocPageCount\",\r\n\t\t\t\tSUM(TSU.user_objects_alloc_page_count) AS \"UserObjectsAllocPageCount\",\r\n\t\t\t\tSUM(TSU.user_objects_dealloc_page_count) AS \"UserObjectsDeallocPageCount\"\r\n\t\t FROM sys.dm_db_task_space_usage AS TSU\r\n\t\t GROUP BY TSU.session_id, TSU.request_id\r\n\t ) AS TasksSpaceUsage\r\nINNER JOIN sys.dm_exec_sessions AS Sessions\r\n\tON TasksSpaceUsage.SessionId = Sessions.session_id\r\nLEFT JOIN sys.dm_exec_requests AS Requests\r\n\tON TasksSpaceUsage.SessionId = Requests.session_id\r\n\t   AND TasksSpaceUsage.RequestId = Requests.request_id\r\nOUTER APPLY sys.dm_exec_sql_text(Requests.sql_handle) AS RequestsText\r\nOUTER APPLY sys.dm_exec_query_plan(Requests.plan_handle) AS RequestsPlan\r\nWHERE TasksSpaceUsage.InternalObjectsAllocPageCount > 0\r\n\t  OR TasksSpaceUsage.InternalObjectsDeallocPageCount > 0\r\n\t  OR TasksSpaceUsage.UserObjectsAllocPageCount > 0\r\n\t  OR TasksSpaceUsage.UserObjectsDeallocPageCount > 0\r\nORDER BY SessionId ASC, RequestId ASC;"
}