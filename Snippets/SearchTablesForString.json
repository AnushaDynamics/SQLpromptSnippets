{
  "id": "bb27a020-8bb4-424d-b4a3-451f1dc1b4d7",
  "prefix": "SearchTablesForString",
  "description": "Search All Tables which Contain Text Columns like %char% and %text%",
  "body": "/* =========================================================================================================================================\r\n-- Server\t\t: Local Server\r\n-- Database\t\t: User Database\r\n-- Script\t\t: SearchTablesForString\r\n-- Description\t: Search All Tables which Contain Text Columns like %char% and %text%.\r\n-- Usage\t\t: @DoPrint = 1 is Most Efficient for Larger Tables Having TableRowCount >= 100000.\r\n--\t\t\t\t  @DoExec = 1 is Most Efficient for Smaller Tables Having TableRowCount <= 100000.\r\n========================================================================================================================================= */\r\nDECLARE @SearchString VARCHAR(1024); SET @SearchString='$String_To_Search$'; --Provide the String here.\r\nDECLARE @DoPrint BIT; SET @DoPrint = 1; --Most Efficient for Larger Tables Having TableRowCount >= 100000.\r\nDECLARE @DoExec BIT; SET @DoExec = 1; --Most Efficient for Smaller Tables Having TableRowCount <= 100000. --Will be Disabled IF @DoPrint = 1\r\n--\r\n/* === DO NOT CHANGE BELOW CODE FROM HERE =============================================================================================== */\r\nSET NOCOUNT ON;\r\nIF @DoPrint = 1 SET @DoExec = 0; --No Need to Print and Execute the Statements. So Setting OFF the @DoExec.\r\nDECLARE @SQLcmd NVARCHAR(MAX);\r\n--$BeginRegion: SearchResultSet TableVariable\r\nSET @SQLcmd = --\r\nN'IF OBJECT_ID(''tempdb..##SearchResults'',''U'') IS NOT NULL\r\n\tDROP TABLE ##SearchResults;\r\nCREATE TABLE ##SearchResults\r\n(\r\n\tDatabaseName VARCHAR(256) NULL,\r\n\tSchemaName VARCHAR(256) NULL,\r\n\tTableName VARCHAR(256) NULL,\r\n\tColumnName VARCHAR(256) NULL,\r\n\tColumnDataType VARCHAR(256) NULL,\r\n\tTableRowCount INT NULL,\r\n\tStringOccuranceCount INT NULL\r\n);';\r\nIF @DoExec = 1 EXECUTE sys.sp_executesql @CMD = @SQLcmd;\r\nIF @DoPrint = 1 PRINT @SQLcmd + CHAR(10) + 'GO' + '--';\r\n--$EndRegion: SearchResultSet TableVariable\r\n--\r\n--$BeginRegion: SearchTableColumn_Cursor\r\nDECLARE @DBname VARCHAR(256), @SCHname VARCHAR(256), @TBLname VARCHAR(256), @COLname VARCHAR(256), @COLdatatype VARCHAR(256);\r\n--\r\nDECLARE SearchTableColumn_Cursor CURSOR LOCAL FAST_FORWARD FOR\r\nSELECT COL.TABLE_CATALOG, COL.TABLE_SCHEMA, COL.TABLE_NAME, COL.COLUMN_NAME, COL.DATA_TYPE\r\nFROM INFORMATION_SCHEMA.COLUMNS AS COL\r\nINNER JOIN INFORMATION_SCHEMA.TABLES AS TBL ON TBL.TABLE_SCHEMA=COL.TABLE_SCHEMA AND TBL.TABLE_NAME=COL.TABLE_NAME \r\nWHERE TBL.TABLE_TYPE='BASE TABLE' AND COL.DATA_TYPE LIKE '%char%' OR COL.DATA_TYPE LIKE '%text%';\r\n--\r\nOPEN SearchTableColumn_Cursor;\r\nFETCH NEXT FROM SearchTableColumn_Cursor INTO @DBname, @SCHname, @TBLname, @COLname, @COLdatatype;\r\n--\r\nWHILE @@FETCH_STATUS=0 \r\nBEGIN\r\n\tSET @SQLcmd = NULL; --Reset Value\r\n\tSET @SQLcmd --\r\n\t\t =N'INSERT INTO ##SearchResults(DatabaseName, SchemaName, TableName, ColumnName, ColumnDataType, TableRowCount, StringOccuranceCount)'+CHAR(10) --\r\n\t\t +N'SELECT '''+@DBname+''' AS \"DatabaseName\",'+CHAR(10) --\r\n\t\t +N'\t'''+@SCHname+''' AS \"SchemaName\",'+CHAR(10) --\r\n\t\t +N'\t'''+@TBLname+''' AS \"TableName\",'+CHAR(10) --\r\n\t\t +N'\t'''+@COLname+''' AS \"ColumnName\",'+CHAR(10) --\r\n\t\t +N'\t'''+@COLdatatype+''' AS \"ColumnDataType\",'+CHAR(10) --\r\n\t\t +N'\t(SELECT COUNT(1) FROM ['+@DBname+'].['+@SCHname+'].['+@TBLname+'] WITH (NOLOCK)) AS \"TableRowCount\",'+CHAR(10) --\r\n\t\t +N'\tCOUNT(1) AS \"StringOccuranceCount\"'+CHAR(10) --\r\n\t\t +N'FROM ['+@DBname+'].['+@SCHname+'].['+@TBLname+'] WITH (NOLOCK)'+CHAR(10) --\r\n\t\t +N'WHERE ['+@COLname+'] LIKE ''%'+@SearchString+'%'';';\r\n\t--\r\n\tIF @DoExec = 1 EXECUTE sys.sp_executesql @CMD = @SQLcmd;\r\n\tIF @DoPrint = 1 PRINT @SQLcmd + CHAR(10) + 'GO';\r\n\t--\r\n\tFETCH NEXT FROM SearchTableColumn_Cursor INTO @DBname, @SCHname, @TBLname, @COLname, @COLdatatype;\r\nEND;\r\nCLOSE SearchTableColumn_Cursor;\r\nDEALLOCATE SearchTableColumn_Cursor;\r\n--$EndRegion: SearchTableColumn_Cursor\r\n--\r\nSET @SQLcmd = --\r\nN'SELECT DatabaseName, SchemaName, TableName, ColumnName, ColumnDataType, TableRowCount, StringOccuranceCount,\r\n\t(''SELECT * FROM [''+DatabaseName+''].[''+SchemaName+''].[''+TableName+''] WHERE [''+ColumnName+''] LIKE ''''%'+@SearchString+'%'''';'') AS SearchQuery\r\nFROM ##SearchResults\r\nWHERE StringOccuranceCount<>0;';\r\n--\r\nIF @DoExec = 1 EXECUTE sys.sp_executesql @CMD = @SQLcmd;\r\nIF @DoPrint = 1 PRINT N'--' + CHAR(10) + @SQLcmd + CHAR(10) + 'GO';",
  "placeholders": [
    {
      "name": "String_To_Search",
      "defaultValue": ""
    }
  ]
}