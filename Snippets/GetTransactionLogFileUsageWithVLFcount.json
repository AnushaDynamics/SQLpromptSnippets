{
  "id": "9caf9e4d-c90d-4be4-84e4-1ac89fcda608",
  "prefix": "GetTransactionLogFileUsageWithVLFcount",
  "description": "To Get the TransactionLog File Usage and VLF Count using DBCC SQLPERF(LOGSPACE)",
  "body": "/* =========================================================================================================================================\r\n-- Server\t\t: LOCAL SERVER\r\n-- Database\t\t: master\r\n-- Script\t\t: GetTransactionLogFileUsageWithVLFcount\r\n-- Description\t: To Get the TransactionLog File Usage and VLF Count using DBCC SQLPERF(LOGSPACE)\r\n========================================================================================================================================= */\r\nUSE master;\r\nGO\r\n\r\n--\r\nDECLARE @LogSpaceTbl TABLE\r\n(\r\n\tDatabaseName VARCHAR(256) NOT NULL,\r\n\t[LogSize(MB)] DECIMAL(18,2) NULL,\r\n\t[LogSpaceUsed(%)] DECIMAL(18,2) NULL,\r\n\tSTATUS INT NULL\r\n);\r\n\r\nINSERT INTO @LogSpaceTbl\r\n\t(\r\n\t\tDatabaseName,\r\n\t\t[LogSize(MB)],\r\n\t\t[LogSpaceUsed(%)],\r\n\t\tSTATUS\r\n\t)\r\nEXEC sys.sp_executesql @command = N'DBCC SQLPERF(LOGSPACE);';\r\n\r\n--\r\nSELECT @@SERVERNAME AS \"ServerName\",\r\n\t   LST.DatabaseName,\r\n\t   MFLI.name AS \"LogicalFileName\",\r\n\t   MFLI.physical_name AS \"PhysicalFileLocation\",\r\n\t   MFLI.recovery_model_desc AS \"RecModel\",\r\n\t   LST.[LogSize(MB)],\r\n\t   LST.[LogSpaceUsed(%)] AS \"SpaceUsed(%)\",\r\n\t   (LST.[LogSize(MB)] * LST.[LogSpaceUsed(%)] / 100) AS \"SpaceUsed(MB)\",\r\n\t   CASE MFLI.is_percent_growth\r\n\t\t   WHEN 1 THEN CONVERT(NVARCHAR(15), MFLI.growth) + N'%'\r\n\t\t   ELSE CONVERT(NVARCHAR(15), (MFLI.growth * 8 / 1024)) + N' MB'\r\n\t\t   END AS \"FileGrowth\",\r\n\t   CASE MFLI.max_size\r\n\t\t   WHEN 0 THEN 'Limited'\r\n\t\t   WHEN -1 THEN 'UnLimited'\r\n\t\t   WHEN 268435456 THEN 'UpTo 2 TB'\r\n\t\t   ELSE 'Limited (' + CONVERT(VARCHAR(15), MFLI.max_size / 128) + ' MB)'\r\n\t\t   END AS \"RestrictedGrowth\",\r\n\t   MFLI.VLF_Count,\r\n\t   MFLI.[VLF_Size (MB)],\r\n\t   MFLI.Active_VLF\r\nFROM @LogSpaceTbl AS LST\r\nINNER JOIN (\r\n\t\t\t   SELECT DB_NAME(MF.database_id) AS \"DatabaseName\",\r\n\t\t\t\t\t  MF.name,\r\n\t\t\t\t\t  MF.physical_name,\r\n\t\t\t\t\t  MF.is_percent_growth,\r\n\t\t\t\t\t  MF.growth,\r\n\t\t\t\t\t  MF.max_size,\r\n\t\t\t\t\t  DBs.recovery_model_desc,\r\n\t\t\t\t\t  COUNT(LI.database_id) AS \"VLF_Count\",\r\n\t\t\t\t\t  SUM(LI.vlf_size_mb) AS \"VLF_Size (MB)\",\r\n\t\t\t\t\t  SUM(CAST(LI.vlf_active AS INT)) AS \"Active_VLF\"\r\n\t\t\t   FROM sys.master_files AS MF\r\n\t\t\t   INNER JOIN sys.databases AS DBs\r\n\t\t\t\t   ON DBs.database_id = MF.database_id\r\n\t\t\t   CROSS APPLY sys.dm_db_log_info(DBs.database_id) AS LI\r\n\t\t\t   WHERE MF.type = 1\r\n\t\t\t   GROUP BY DB_NAME(MF.database_id),\r\n\t\t\t\t\t\tMF.name,\r\n\t\t\t\t\t\tMF.physical_name,\r\n\t\t\t\t\t\tMF.is_percent_growth,\r\n\t\t\t\t\t\tMF.growth,\r\n\t\t\t\t\t\tMF.max_size,\r\n\t\t\t\t\t\tDBs.recovery_model_desc\r\n\t\t   ) AS MFLI ON MFLI.DatabaseName = LST.DatabaseName\r\nWHERE 1 = 1;\r\n--AND DB_ID(MFLI.DatabaseName) > 4;"
}