{
  "id": "24a012c4-0b85-4bdd-9fd9-006518e586f7",
  "prefix": "GetBlockingChain",
  "description": "Finding All Blocking Chain Sessions and Root Blockers",
  "body": "/* =============================================================================================================================================================\r\n-- Database\t\t: master\r\n-- Script\t\t: GetBlockingChain\r\n-- Description\t: Finding All Blocking Chain Sessions and Root Blockers\r\n-- Usage\t\t:\r\n-- History\t\t:\r\n-- Refer Links\t: https://blog.sqlauthority.com/2020/04/20/sql-server-blocking-tree-identifying-blocking-chain-using-sql-scripts/\r\n============================================================================================================================================================= */\r\n;WITH _All_SPIDs (spid, blocked)\r\nAS \r\n(\r\n\tSELECT spid, blocked\r\n\tFROM sys.sysprocesses\r\n),\r\nBlockingTree (spid, blocking_spid, level)\r\nAS \r\n(\r\n\tSELECT blc.spid, blc.blocked,\r\n\t\t   CAST(REPLICATE('0', 4 - LEN(CAST(blc.spid AS VARCHAR(8)))) + CAST(blc.spid AS VARCHAR(8)) AS VARCHAR(1000)) AS \"level\"\r\n\tFROM _All_SPIDs AS blc\r\n\tWHERE (blc.blocked = 0 OR blc.blocked = blc.spid)\r\n\t\tAND EXISTS (SELECT * FROM _All_SPIDs AS blc2 WHERE blc2.blocked = blc.spid AND blc2.blocked <> blc2.spid)\r\n\tUNION ALL\r\n\tSELECT blc.spid, blc.blocked,\r\n\t\t   CAST(bt.level + RIGHT(CAST((1000 + blc.spid) AS VARCHAR(100)), 4) AS VARCHAR(1000)) AS \"level\"\r\n\tFROM _All_SPIDs AS blc\r\n\tINNER JOIN BlockingTree AS bt ON blc.blocked = bt.spid\r\n\tWHERE blc.blocked > 0\r\n\t\tAND blc.blocked <> blc.spid\r\n)\r\nSELECT ISNULL(REPLICATE('|    ', LEN(bt.level) / 4 - 1), '') + CASE WHEN (LEN(bt.level) / 4 - 1) = 0 THEN '|| ' ELSE '>>  ' END + CAST(bt.spid AS NVARCHAR(10)) AS \"BlockingTree\",\r\n\t   spr.lastwaittype AS \"Type\",\r\n\t   spr.loginame AS \"Login Name\",\r\n\t   DB_NAME(spr.dbid) AS \"Source database\",\r\n\t   st.text AS \"SQL Text\",\r\n\t   CASE WHEN cur.sql_handle IS NULL THEN '' ELSE (SELECT text FROM sys.dm_exec_sql_text(cur.sql_handle)) END AS \"Cursor SQL Text\",\r\n\t   DB_NAME(sli.rsc_dbid) AS \"Database\",\r\n\t   OBJECT_SCHEMA_NAME(sli.rsc_objid, sli.rsc_dbid) AS \"Schema\",\r\n\t   OBJECT_NAME(sli.rsc_objid, sli.rsc_dbid) AS \"Table\",\r\n\t   spr.waitresource AS \"Wait Resource\",\r\n\t   spr.cmd AS \"Command\",\r\n\t   spr.program_name AS \"Application\",\r\n\t   spr.hostname AS \"HostName\",\r\n\t   spr.last_batch AS \"Last Batch Time\"\r\nFROM BlockingTree AS bt\r\nLEFT OUTER JOIN sys.sysprocesses AS spr ON spr.spid = bt.spid\r\nCROSS APPLY sys.dm_exec_sql_text(spr.sql_handle) AS st\r\nLEFT JOIN sys.dm_exec_cursors(0) AS cur ON cur.session_id = spr.spid AND cur.fetch_status <> 0\r\nJOIN sys.syslockinfo AS sli ON sli.req_spid = spr.spid AND sli.rsc_type = 5 AND OBJECT_NAME(sli.rsc_objid, sli.rsc_dbid) IS NOT NULL\r\nORDER BY bt.level ASC;"
}