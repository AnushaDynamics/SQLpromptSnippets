{
  "id": "99c64f8a-343d-4f17-885a-f9203b61f84b",
  "prefix": "GetWaitStatsInfo",
  "description": "To Get Wait Statistics Information to Check Where SQL Server Hurts",
  "body": "/* =========================================================================================================================================\r\n-- Server\t\t: LOCAL SERVER\r\n-- Database\t\t: master\r\n-- Script\t\t: GetWaitStatsInfo\r\n-- Description\t: To Get Wait Statistics(Wait Stats) Information to Check Where SQL Server Hurts\r\n-- Link\t\t\t: https://www.sqlskills.com/blogs/paul/wait-statistics-or-please-tell-me-where-it-hurts/\r\n-- Usage\t\t: Just Execute and UnComment Where Clause if Required.\r\n\t\t\t***** We Can Reset Aggregated Statistics using this code:\r\n\t\t\t\t--DBCC SQLPERF (N'sys.dm_os_wait_stats', CLEAR);\r\n========================================================================================================================================= */\r\nUSE master;\r\nGO\r\n--\r\n;WITH Waits\r\nAS (\r\n\t   SELECT wait_type,\r\n\t\t\t  wait_time_ms / 1000.0 AS \"WaitS\",\r\n\t\t\t  (wait_time_ms - signal_wait_time_ms) / 1000.0 AS \"ResourceS\",\r\n\t\t\t  signal_wait_time_ms / 1000.0 AS \"SignalS\",\r\n\t\t\t  waiting_tasks_count AS \"WaitCount\",\r\n\t\t\t  100.0 * wait_time_ms / SUM(wait_time_ms) OVER () AS \"Percentage\",\r\n\t\t\t  ROW_NUMBER() OVER (ORDER BY wait_time_ms DESC) AS \"RowNum\"\r\n\t   FROM sys.dm_os_wait_stats\r\n\t   WHERE wait_type NOT IN (\r\n\t\t\t\t\t\t\t\t  -- These wait types are almost 100% never a problem and so they are filtered out to avoid them skewing the results. \r\n\t\t\t\t\t\t\t\t  -- Click on the URL for more information.\r\n\t\t\t\t\t\t\t\t  N'BROKER_EVENTHANDLER',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/BROKER_EVENTHANDLER\r\n\t\t\t\t\t\t\t\t  N'BROKER_RECEIVE_WAITFOR',\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/BROKER_RECEIVE_WAITFOR\r\n\t\t\t\t\t\t\t\t  N'BROKER_TASK_STOP',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/BROKER_TASK_STOP\r\n\t\t\t\t\t\t\t\t  N'BROKER_TO_FLUSH',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/BROKER_TO_FLUSH\r\n\t\t\t\t\t\t\t\t  N'BROKER_TRANSMITTER',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/BROKER_TRANSMITTER\r\n\t\t\t\t\t\t\t\t  N'CHECKPOINT_QUEUE',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/CHECKPOINT_QUEUE\r\n\t\t\t\t\t\t\t\t  N'CHKPT',\t\t\t\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/CHKPT\r\n\t\t\t\t\t\t\t\t  N'CLR_AUTO_EVENT',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/CLR_AUTO_EVENT\r\n\t\t\t\t\t\t\t\t  N'CLR_MANUAL_EVENT',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/CLR_MANUAL_EVENT\r\n\t\t\t\t\t\t\t\t  N'CLR_SEMAPHORE',\t\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/CLR_SEMAPHORE\r\n\t\t\t\t\t\t\t\t-- Maybe comment this out if you have parallelism issues\r\n\t\t\t\t\t\t\t\t  N'CXCONSUMER',\t\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/CXCONSUMER\r\n\t\t\t\t\t\t\t\t-- Maybe comment these four out if you have mirroring issues\r\n\t\t\t\t\t\t\t\t  N'DBMIRROR_DBM_EVENT',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/DBMIRROR_DBM_EVENT\r\n\t\t\t\t\t\t\t\t  N'DBMIRROR_EVENTS_QUEUE',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/DBMIRROR_EVENTS_QUEUE\r\n\t\t\t\t\t\t\t\t  N'DBMIRROR_WORKER_QUEUE',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/DBMIRROR_WORKER_QUEUE\r\n\t\t\t\t\t\t\t\t  N'DBMIRRORING_CMD',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/DBMIRRORING_CMD\r\n\t\t\t\t\t\t\t\t  N'DIRTY_PAGE_POLL',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/DIRTY_PAGE_POLL\r\n\t\t\t\t\t\t\t\t  N'DISPATCHER_QUEUE_SEMAPHORE',\t\t\t\t\t -- https://www.sqlskills.com/help/waits/DISPATCHER_QUEUE_SEMAPHORE\r\n\t\t\t\t\t\t\t\t  N'EXECSYNC',\t\t\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/EXECSYNC\r\n\t\t\t\t\t\t\t\t  N'FSAGENT',\t\t\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/FSAGENT\r\n\t\t\t\t\t\t\t\t  N'FT_IFTS_SCHEDULER_IDLE_WAIT',\t\t\t\t\t -- https://www.sqlskills.com/help/waits/FT_IFTS_SCHEDULER_IDLE_WAIT\r\n\t\t\t\t\t\t\t\t  N'FT_IFTSHC_MUTEX',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/FT_IFTSHC_MUTEX\r\n\t\t\t\t\t\t\t\t-- Maybe comment these six out if you have AG issues\r\n\t\t\t\t\t\t\t\t  N'HADR_CLUSAPI_CALL',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/HADR_CLUSAPI_CALL\r\n\t\t\t\t\t\t\t\t  N'HADR_FILESTREAM_IOMGR_IOCOMPLETION',\t\t\t -- https://www.sqlskills.com/help/waits/HADR_FILESTREAM_IOMGR_IOCOMPLETION\r\n\t\t\t\t\t\t\t\t  N'HADR_LOGCAPTURE_WAIT',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/HADR_LOGCAPTURE_WAIT\r\n\t\t\t\t\t\t\t\t  N'HADR_NOTIFICATION_DEQUEUE',\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/HADR_NOTIFICATION_DEQUEUE\r\n\t\t\t\t\t\t\t\t  N'HADR_TIMER_TASK',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/HADR_TIMER_TASK\r\n\t\t\t\t\t\t\t\t  N'HADR_WORK_QUEUE',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/HADR_WORK_QUEUE\r\n\t\t\t\t\t\t\t\t  N'KSOURCE_WAKEUP',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/KSOURCE_WAKEUP\r\n\t\t\t\t\t\t\t\t  N'LAZYWRITER_SLEEP',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/LAZYWRITER_SLEEP\r\n\t\t\t\t\t\t\t\t  N'LOGMGR_QUEUE',\t\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/LOGMGR_QUEUE\r\n\t\t\t\t\t\t\t\t  N'MEMORY_ALLOCATION_EXT',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/MEMORY_ALLOCATION_EXT\r\n\t\t\t\t\t\t\t\t  N'ONDEMAND_TASK_QUEUE',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/ONDEMAND_TASK_QUEUE\r\n\t\t\t\t\t\t\t\t  N'PARALLEL_REDO_DRAIN_WORKER',\t\t\t\t\t -- https://www.sqlskills.com/help/waits/PARALLEL_REDO_DRAIN_WORKER\r\n\t\t\t\t\t\t\t\t  N'PARALLEL_REDO_LOG_CACHE',\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/PARALLEL_REDO_LOG_CACHE\r\n\t\t\t\t\t\t\t\t  N'PARALLEL_REDO_TRAN_LIST',\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/PARALLEL_REDO_TRAN_LIST\r\n\t\t\t\t\t\t\t\t  N'PARALLEL_REDO_WORKER_SYNC',\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/PARALLEL_REDO_WORKER_SYNC\r\n\t\t\t\t\t\t\t\t  N'PARALLEL_REDO_WORKER_WAIT_WORK',\t\t\t\t -- https://www.sqlskills.com/help/waits/PARALLEL_REDO_WORKER_WAIT_WORK\r\n\t\t\t\t\t\t\t\t  N'PREEMPTIVE_OS_FLUSHFILEBUFFERS',\t\t\t\t -- https://www.sqlskills.com/help/waits/PREEMPTIVE_OS_FLUSHFILEBUFFERS\r\n\t\t\t\t\t\t\t\t  N'PREEMPTIVE_XE_GETTARGETSTATE',\t\t\t\t\t -- https://www.sqlskills.com/help/waits/PREEMPTIVE_XE_GETTARGETSTATE\r\n\t\t\t\t\t\t\t\t  N'PVS_PREALLOCATE',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/PVS_PREALLOCATE\r\n\t\t\t\t\t\t\t\t  N'PWAIT_ALL_COMPONENTS_INITIALIZED',\t\t\t\t -- https://www.sqlskills.com/help/waits/PWAIT_ALL_COMPONENTS_INITIALIZED\r\n\t\t\t\t\t\t\t\t  N'PWAIT_DIRECTLOGCONSUMER_GETNEXT',\t\t\t\t -- https://www.sqlskills.com/help/waits/PWAIT_DIRECTLOGCONSUMER_GETNEXT\r\n\t\t\t\t\t\t\t\t  N'QDS_PERSIST_TASK_MAIN_LOOP_SLEEP',\t\t\t\t -- https://www.sqlskills.com/help/waits/QDS_PERSIST_TASK_MAIN_LOOP_SLEEP\r\n\t\t\t\t\t\t\t\t  N'QDS_ASYNC_QUEUE',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/QDS_ASYNC_QUEUE\r\n\t\t\t\t\t\t\t\t  N'QDS_CLEANUP_STALE_QUERIES_TASK_MAIN_LOOP_SLEEP', -- https://www.sqlskills.com/help/waits/QDS_CLEANUP_STALE_QUERIES_TASK_MAIN_LOOP_SLEEP\r\n\t\t\t\t\t\t\t\t  N'QDS_SHUTDOWN_QUEUE',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/QDS_SHUTDOWN_QUEUE\r\n\t\t\t\t\t\t\t\t  N'REDO_THREAD_PENDING_WORK',\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/REDO_THREAD_PENDING_WORK\r\n\t\t\t\t\t\t\t\t  N'REQUEST_FOR_DEADLOCK_SEARCH',\t\t\t\t\t -- https://www.sqlskills.com/help/waits/REQUEST_FOR_DEADLOCK_SEARCH\r\n\t\t\t\t\t\t\t\t  N'RESOURCE_QUEUE',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/RESOURCE_QUEUE\r\n\t\t\t\t\t\t\t\t  N'SERVER_IDLE_CHECK',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/SERVER_IDLE_CHECK\r\n\t\t\t\t\t\t\t\t  N'SLEEP_BPOOL_FLUSH',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/SLEEP_BPOOL_FLUSH\r\n\t\t\t\t\t\t\t\t  N'SLEEP_DBSTARTUP',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/SLEEP_DBSTARTUP\r\n\t\t\t\t\t\t\t\t  N'SLEEP_DCOMSTARTUP',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/SLEEP_DCOMSTARTUP\r\n\t\t\t\t\t\t\t\t  N'SLEEP_MASTERDBREADY',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/SLEEP_MASTERDBREADY\r\n\t\t\t\t\t\t\t\t  N'SLEEP_MASTERMDREADY',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/SLEEP_MASTERMDREADY\r\n\t\t\t\t\t\t\t\t  N'SLEEP_MASTERUPGRADED',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/SLEEP_MASTERUPGRADED\r\n\t\t\t\t\t\t\t\t  N'SLEEP_MSDBSTARTUP',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/SLEEP_MSDBSTARTUP\r\n\t\t\t\t\t\t\t\t  N'SLEEP_SYSTEMTASK',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/SLEEP_SYSTEMTASK\r\n\t\t\t\t\t\t\t\t  N'SLEEP_TASK',\t\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/SLEEP_TASK\r\n\t\t\t\t\t\t\t\t  N'SLEEP_TEMPDBSTARTUP',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/SLEEP_TEMPDBSTARTUP\r\n\t\t\t\t\t\t\t\t  N'SNI_HTTP_ACCEPT',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/SNI_HTTP_ACCEPT\r\n\t\t\t\t\t\t\t\t  N'SOS_WORK_DISPATCHER',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/SOS_WORK_DISPATCHER\r\n\t\t\t\t\t\t\t\t  N'SP_SERVER_DIAGNOSTICS_SLEEP',\t\t\t\t\t -- https://www.sqlskills.com/help/waits/SP_SERVER_DIAGNOSTICS_SLEEP\r\n\t\t\t\t\t\t\t\t  N'SQLTRACE_BUFFER_FLUSH',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/SQLTRACE_BUFFER_FLUSH\r\n\t\t\t\t\t\t\t\t  N'SQLTRACE_INCREMENTAL_FLUSH_SLEEP',\t\t\t\t -- https://www.sqlskills.com/help/waits/SQLTRACE_INCREMENTAL_FLUSH_SLEEP\r\n\t\t\t\t\t\t\t\t  N'SQLTRACE_WAIT_ENTRIES',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/SQLTRACE_WAIT_ENTRIES\r\n\t\t\t\t\t\t\t\t  N'VDI_CLIENT_OTHER',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/VDI_CLIENT_OTHER\r\n\t\t\t\t\t\t\t\t  N'WAIT_FOR_RESULTS',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/WAIT_FOR_RESULTS\r\n\t\t\t\t\t\t\t\t  N'WAITFOR',\t\t\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/WAITFOR\r\n\t\t\t\t\t\t\t\t  N'WAITFOR_TASKSHUTDOWN',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/WAITFOR_TASKSHUTDOWN\r\n\t\t\t\t\t\t\t\t  N'WAIT_XTP_RECOVERY',\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/WAIT_XTP_RECOVERY\r\n\t\t\t\t\t\t\t\t  N'WAIT_XTP_HOST_WAIT',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/WAIT_XTP_HOST_WAIT\r\n\t\t\t\t\t\t\t\t  N'WAIT_XTP_OFFLINE_CKPT_NEW_LOG',\t\t\t\t\t -- https://www.sqlskills.com/help/waits/WAIT_XTP_OFFLINE_CKPT_NEW_LOG\r\n\t\t\t\t\t\t\t\t  N'WAIT_XTP_CKPT_CLOSE',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/WAIT_XTP_CKPT_CLOSE\r\n\t\t\t\t\t\t\t\t  N'XE_DISPATCHER_JOIN',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/XE_DISPATCHER_JOIN\r\n\t\t\t\t\t\t\t\t  N'XE_DISPATCHER_WAIT',\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/XE_DISPATCHER_WAIT\r\n\t\t\t\t\t\t\t\t  N'XE_TIMER_EVENT'\t\t\t\t\t\t\t\t\t -- https://www.sqlskills.com/help/waits/XE_TIMER_EVENT\r\n\t\t\t\t\t\t\t  )\r\n\t\t\t AND waiting_tasks_count > 0\r\n   )\r\nSELECT MAX(W1.wait_type) AS \"WaitType\",\r\n\t   CAST(MAX(W1.WaitS) AS DECIMAL(16, 2)) AS \"Wait_S\",\r\n\t   CAST(MAX(W1.ResourceS) AS DECIMAL(16, 2)) AS \"Resource_S\",\r\n\t   CAST(MAX(W1.SignalS) AS DECIMAL(16, 2)) AS \"Signal_S\",\r\n\t   MAX(W1.WaitCount) AS \"WaitCount\",\r\n\t   CAST(MAX(W1.Percentage) AS DECIMAL(5, 2)) AS \"Percentage\",\r\n\t   CAST((MAX(W1.WaitS) / MAX(W1.WaitCount)) AS DECIMAL(16, 4)) AS \"AvgWait_S\",\r\n\t   CAST((MAX(W1.ResourceS) / MAX(W1.WaitCount)) AS DECIMAL(16, 4)) AS \"AvgRes_S\",\r\n\t   CAST((MAX(W1.SignalS) / MAX(W1.WaitCount)) AS DECIMAL(16, 4)) AS \"AvgSig_S\",\r\n\t   CAST('https://www.sqlskills.com/help/waits/' + MAX(W1.wait_type) AS XML) AS \"Help/Info URL\"\r\nFROM Waits AS W1\r\nINNER JOIN Waits AS W2 ON W2.RowNum <= W1.RowNum\r\n--WHERE W1.wait_type LIKE '%IO%'\r\nGROUP BY W1.RowNum\r\nHAVING (SUM(W2.Percentage) - MAX(W1.Percentage)) < 95; -- Percentage Threshold\r\nGO"
}