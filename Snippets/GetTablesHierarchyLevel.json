{
  "id": "7bde5d99-8699-4255-bfd0-55ae6ddb865f",
  "prefix": "GetTablesHierarchyLevel",
  "description": "Get Hierarchy Level of Tables using Existing Foreign Keys",
  "body": "/* =========================================================================================================================================\r\n-- Server\t\t: LOCALSERVER\r\n-- Database\t\t: USER Database\r\n-- Script\t\t: GetTablesHierarchyLevel\r\n-- Description\t: Get Hierarchy Level of Tables using Existing Foreign Keys\r\n--\t\t\t\t**Note: Self Reference Foreign Keys should be Excluded or Dropped before Executing and Then ReCreated.\r\n========================================================================================================================================= */\r\nSET NOCOUNT ON;\r\nWITH _Dependencies -- Get Objects with FK Dependencies\r\nAS (\r\n\t   SELECT FK.TABLE_SCHEMA AS \"OBJECTschema\", FK.TABLE_NAME AS \"OBJECTname\",\r\n\t\t\t  PK.TABLE_SCHEMA AS \"DEPENDSschema\", PK.TABLE_NAME AS \"DEPENDSname\"\r\n\t   FROM INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS AS C\r\n\t   INNER JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS AS FK ON C.CONSTRAINT_NAME = FK.CONSTRAINT_NAME\r\n\t   INNER JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS AS PK ON C.UNIQUE_CONSTRAINT_NAME = PK.CONSTRAINT_NAME\r\n   ),\r\n_NoDependencies -- The First Level Objects are with No Dependencies\r\nAS (\r\n\t   SELECT T.TABLE_SCHEMA AS \"OBJECTschema\", T.TABLE_NAME AS \"OBJECTname\"\r\n\t   FROM INFORMATION_SCHEMA.TABLES AS T\r\n\t   WHERE T.TABLE_TYPE = 'BASE TABLE' -- Just Tables Only\r\n\t\t\t AND NOT EXISTS (SELECT 1 FROM _Dependencies AS D WHERE D.OBJECTschema = T.TABLE_SCHEMA AND D.OBJECTname = T.TABLE_NAME)\r\n   ),\r\n_Recursive -- Recursive CTE to Get Dependencies\r\nAS (\r\n\t   SELECT ND.OBJECTschema AS \"SchemaName\", ND.OBJECTname AS \"TableName\", 0 AS \"LVL\" -- Level 0 Indicates Tables with No Dependencies\r\n\t   FROM _NoDependencies AS ND\r\n\t   UNION ALL\r\n\t   SELECT D.OBJECTschema AS \"SchemaName\", D.OBJECTname AS \"TableName\", R.LVL + 1 AS \"LVL\"\r\n\t   FROM _Dependencies AS D\r\n\t   INNER JOIN _Recursive AS R ON D.DEPENDSschema = R.SchemaName AND D.DEPENDSname = R.TableName\r\n   )\r\nSELECT R.SchemaName, R.TableName, MAX(R.LVL) AS \"LVL\"\r\nFROM _Recursive AS R\r\nGROUP BY R.SchemaName, R.TableName\r\nORDER BY LVL ASC, R.SchemaName ASC, R.TableName ASC;"
}