{
  "id": "20b2b005-8945-48e0-a7f3-1a2adea540f4",
  "prefix": "GenerateDatabaseBackupAndRestoreScript",
  "description": "Generate Database Backup and Restore Script",
  "body": "/* =============================================================================================================================================================\r\n-- Server\t\t: LOCALSERVER\r\n-- Database\t\t: master\r\n-- Script\t\t: Generate_Database_Backup_and_Restore_Script.sql\r\n-- Description\t: In Dev Env, There might be required to Backup and Restore Database Multiple Times.\r\n--\tSo, This will Generate Script for Backup and Restore to Original File Locations.\r\n--\tThis Backup will be a Copy_Only Backup to Avoid \"Breaking LSN Chain\".\r\n-- Usage\t\t: Provide the @DBname, @BackupLocation, @Description (optional)\r\n--PreRequisities:\r\n----$BeginRegion: Enable CMDshell and Create Folders\r\n\tEXEC sys.sp_configure @configname = 'show advanced options', @configvalue = '1'; RECONFIGURE;\r\n\tEXEC sys.sp_configure @configname = 'xp_cmdshell', @configvalue = '1'; RECONFIGURE;\r\n\tEXEC sys.sp_configure @configname = 'show advanced options', @configvalue = '0'; RECONFIGURE;\r\n\tEXEC sys.xp_cmdshell @command = 'mkdir \"C:\\SQL\\Backups\\\"';\r\n\tEXEC sys.xp_cmdshell @command = 'mkdir \"C:\\SQL\\MSSQL\\DATA\\\"';\r\n\tEXEC sys.xp_cmdshell @command = 'mkdir \"C:\\SQL\\MSSQL\\LOG\\\"';\r\n----$EndRegion: Enable CMDshell and Create Folders\r\n============================================================================================================================================================= */\r\nUSE master;\r\nGO\r\n--\r\nDECLARE @DBname VARCHAR(256) = '$DatabaseName$';\r\nDECLARE @BackupFileLocation VARCHAR(1024) = '$BackupFileLocation$'; --Most Preffered Path \"C:\\SQL\\Backups\"\r\nDECLARE @Description VARCHAR(32) = '$Description$'; --Pls DoNot Put Spaces in @Description\r\nDECLARE @RestoreDBasCopy BIT = 1; --Enable If we Want to Restore the Main Database as Copy Database\r\nDECLARE @IncludeTimeStampInFileName BIT = 0; --Enable If We are Making Multiple Backups On the Same Day\r\n--\r\n/* ===== ** DO NOT CHANGE CODE BELOW FROM HERE ** =========================================================================================================== */\r\nIF DB_ID(@DBname) IS NULL\r\nBEGIN\r\n\tRAISERROR('Database Does Not Exists, Please check the \"@DBname\" and Try Again...!', 16, 1);\r\n\tRETURN;\r\nEND;\r\n--\r\nIF LTRIM(RTRIM(@Description)) = '' OR @Description IS NULL SET @Description = NULL;\r\nDECLARE @BackupFileName VARCHAR(255);\r\nSET @BackupFileName = REPLACE(@@SERVERNAME, '\\', '-')+'_'+REPLACE(@DBname, ' ', '-')+'_v'+CAST(SERVERPROPERTY('ProductVersion') AS VARCHAR(2))+'_'+ISNULL(@Description, 'FullCopyOnly')+'_'+CONVERT(VARCHAR(8), GETDATE(), 112);\r\nIF @IncludeTimeStampInFileName = 1 SET @BackupFileName = @BackupFileName + '_'+REPLACE(CONVERT(VARCHAR(9), GETDATE(), 108), ':', '');\r\nSET @BackupFileName = @BackupFileName + '.bak';\r\n--\r\n--$BeginRegion: Backup Script Generation\r\nPRINT N'/* ===== ** Backup Script for Database: ' + @DBname + ' ** ======================================================================================== */';\r\nPRINT N'USE [master];';\r\nPRINT N'GO';\r\n--\r\nPRINT N'--$BeginRegion: Copy Only Backup Script for Database \"' + @DBname + '\"';\r\nPRINT N'BACKUP DATABASE [' + @DBname + ']';\r\nPRINT N'TO DISK = N''' + @BackupFileLocation + '\\' + @BackupFileName + '''';\r\nPRINT N'WITH NAME = N''' + @DBname + '-Full Copy Only Database Backup'',';\r\nPRINT N'\tCOPY_ONLY, NOFORMAT, INIT, SKIP, NOREWIND, NOUNLOAD, COMPRESSION, CHECKSUM, STATS = 5;';\r\nPRINT N'GO';\r\nPRINT N'RESTORE VERIFYONLY';\r\nPRINT N'FROM DISK = N''' + @BackupFileLocation + '\\' + @BackupFileName + '''';\r\nPRINT N'WITH NOUNLOAD, NOREWIND;';\r\nPRINT N'GO';\r\nPRINT N'--$EndRegion: Copy Only Backup Script for Database \"' + @DBname + '\"';\r\n--$EndRegion: Backup Script Generation\r\n--\r\nPRINT '';\r\n--\r\n--$BeginRegion: Restore Script Generation\r\nDECLARE @LogicalName VARCHAR(256), @PhysicalFileLocation VARCHAR(MAX), @PhysicalFileName VARCHAR(256);\r\n--\r\n----$BeginRegion: MainDB_RestoreScript\r\nBEGIN\r\n\tPRINT N'/* ===== ** Restore Script for Database: ' + @DBname + ' ** ======================================================================================= */';\r\n\tIF @RestoreDBasCopy = 1 PRINT N'/* --Commented as Requested to Restore the Database \"' + @DBname + '\" as a Copy Database:';\r\n\tPRINT N'USE [master];';\r\n\tPRINT N'GO';\r\n\t--\r\n\tPRINT N'--$BeginRegion: Killing All Sessions for Database \"' + @DBname + '\"';\r\n\tPRINT N'DECLARE @KillSPIDs NVARCHAR(MAX) = N'''';';\r\n\tPRINT N'SELECT @KillSPIDs = @KillSPIDs + CHAR(10) + N''KILL '' + CONVERT(VARCHAR(5), session_id) + N'';''';\r\n\tPRINT N'FROM sys.dm_exec_sessions';\r\n\tPRINT N'WHERE session_id > 50 AND session_id <> @@SPID AND DB_NAME(database_id) = ''' + @DBname + ''';';\r\n\tPRINT N'----PRINT @KillSPIDs;';\r\n\tPRINT N'EXEC sys.sp_executesql @command = @KillSPIDs;';\r\n\tPRINT N'GO';\r\n\tPRINT N'--$EndRegion: Killing All Sessions for Database \"' + @DBname + '\"';\r\n\r\n\tDECLARE MainDB_FileCursor CURSOR FAST_FORWARD READ_ONLY LOCAL FOR\r\n\tSELECT name AS LogicalName,\r\n\t\t\t--physical_name AS PhysicalName,\r\n\t\t\tSUBSTRING(physical_name, 1, (LEN(physical_name) - CHARINDEX('\\', REVERSE(physical_name), 1))) AS PhysicalFileLocation,\r\n\t\t\tSUBSTRING(physical_name, (LEN(physical_name) - CHARINDEX('\\', REVERSE(physical_name), 1) + 2), LEN(physical_name)) AS PhysicalFileName\r\n\tFROM sys.master_files\r\n\tWHERE DB_NAME(database_id) = @DBname\r\n\tORDER BY type ASC, data_space_id ASC;\r\n\r\n\tPRINT '';\r\n\tPRINT N'--$BeginRegion: Restoring Database \"' + @DBname + '\" From Backup \"' + @BackupFileLocation + '\\' + @BackupFileName + '\"';\r\n\tPRINT N'RESTORE DATABASE [' + @DBname + ']';\r\n\tPRINT N'FROM DISK = N''' + @BackupFileLocation + '\\' + @BackupFileName + '''';\r\n\tPRINT N'WITH ';\r\n\r\n\tOPEN MainDB_FileCursor;\r\n\tFETCH NEXT FROM MainDB_FileCursor INTO @LogicalName, @PhysicalFileLocation, @PhysicalFileName;\r\n\r\n\tWHILE @@FETCH_STATUS = 0\r\n\tBEGIN\r\n\t\tPRINT N'\tMOVE N''' + @LogicalName + ''' TO N''' + @PhysicalFileLocation + '\\' + @PhysicalFileName + ''',';\r\n\t\t--\r\n\t\tFETCH NEXT FROM MainDB_FileCursor INTO @LogicalName, @PhysicalFileLocation, @PhysicalFileName;\r\n\tEND;\r\n\r\n\tPRINT N'NOUNLOAD, REPLACE, STATS = 5;';\r\n\tPRINT N'GO';\r\n\tPRINT N'--$EndRegion: Restoring Database \"' + @DBname + '\" From Backup \"' + @BackupFileLocation + '\\' + @BackupFileName + '\"';\r\n\r\n\tCLOSE MainDB_FileCursor;\r\n\tDEALLOCATE MainDB_FileCursor;\r\n\tIF @RestoreDBasCopy = 1 PRINT N'*/';\r\nEND\r\n----$EndRegion: MainDB_RestoreScript\r\n--\r\nPRINT '';\r\n--\r\n----$BeginRegion: CopyDB_RestoreScript\r\nIF @RestoreDBasCopy = 1\r\nBEGIN\r\n\t--$BeginRegion: Kill Sessions and Drop Copy Database as @RestoreDBasCopy = 1\r\n\tPRINT N'/* ===== ** Restore Script for Database: ' + @DBname + '_Copy ** ================================================================================== */';\r\n\tPRINT N'USE [master];';\r\n\tPRINT N'GO';\r\n\t--\r\n\tPRINT N'--$BeginRegion: Killing All Sessions for Database \"' + @DBname + '_Copy\"';\r\n\tPRINT N'DECLARE @KillSPIDs NVARCHAR(MAX) = N'''';';\r\n\tPRINT N'SELECT @KillSPIDs = @KillSPIDs + CHAR(10) + N''KILL '' + CONVERT(VARCHAR(5), session_id) + N'';''';\r\n\tPRINT N'FROM sys.dm_exec_sessions';\r\n\tPRINT N'WHERE session_id > 50 AND session_id <> @@SPID AND DB_NAME(database_id) = ''' + @DBname + '_Copy'';';\r\n\tPRINT N'----PRINT @KillSPIDs;';\r\n\tPRINT N'EXEC sys.sp_executesql @command = @KillSPIDs;';\r\n\tPRINT N'GO';\r\n\tPRINT N'--$EndRegion: Killing All Sessions for Database \"' + @DBname + '_Copy\"';\r\n\tPRINT '';\r\n\tPRINT N'--$BeginRegion: Dropping Database \"' + @DBname + '_Copy\" to Restore Fresh DB Copy';\r\n\tPRINT N'IF EXISTS (SELECT name FROM sys.databases WHERE name = ''' + @DBname + '_Copy'')';\r\n\tPRINT N'BEGIN';\r\n    PRINT N'\tALTER DATABASE [' + @DBname + '_Copy] SET SINGLE_USER WITH ROLLBACK IMMEDIATE;';\r\n\tPRINT N'\tDROP DATABASE [' + @DBname + '_Copy];';\r\n\tPRINT N'END;';\r\n\tPRINT N'--$EndRegion: Dropping Database \"' + @DBname + '_Copy\" to Restore Fresh DB Copy';\r\n\t--$EndRegion: Kill Sessions and Drop Copy Database as @RestoreDBasCopy = 1\r\n\t--\r\n\tDECLARE CopyDB_FileCursor CURSOR FAST_FORWARD READ_ONLY LOCAL FOR\r\n\tSELECT name AS LogicalName,\r\n\t\t   --physical_name AS PhysicalName,\r\n\t\t   SUBSTRING(physical_name, 1, (LEN(physical_name) - CHARINDEX('\\', REVERSE(physical_name), 1))) AS PhysicalFileLocation,\r\n\t\t   SUBSTRING(physical_name, (LEN(physical_name) - CHARINDEX('\\', REVERSE(physical_name), 1) + 2), LEN(physical_name)) AS PhysicalFileName\r\n\tFROM sys.master_files\r\n\tWHERE DB_NAME(database_id) = @DBname\r\n\tORDER BY type ASC, data_space_id ASC;\r\n\r\n\tPRINT '';\r\n\tPRINT N'--$BeginRegion: Restoring Database \"' + @DBname + '_Copy\" From Backup \"' + @BackupFileLocation + '\\' + @BackupFileName + '\"';\r\n\tPRINT N'RESTORE DATABASE [' + @DBname + '_Copy]';\r\n\tPRINT N'FROM DISK = N''' + @BackupFileLocation + '\\' + @BackupFileName + '''';\r\n\tPRINT N'WITH ';\r\n\r\n\tOPEN CopyDB_FileCursor;\r\n\tFETCH NEXT FROM CopyDB_FileCursor INTO @LogicalName, @PhysicalFileLocation, @PhysicalFileName;\r\n\r\n\tWHILE @@FETCH_STATUS = 0\r\n\tBEGIN\r\n\t\tIF @PhysicalFileName LIKE '%.mdf' --Primary Files\r\n\t\t\tPRINT N'\tMOVE N''' + @LogicalName + ''' TO N''' + @PhysicalFileLocation + '\\' + REPLACE(@PhysicalFileName, '.mdf', '_Copy.mdf') + ''',';\r\n\t\tIF @PhysicalFileName LIKE '%.ndf' --Secondary Files\r\n\t\t\tPRINT N'\tMOVE N''' + @LogicalName + ''' TO N''' + @PhysicalFileLocation + '\\' + REPLACE(@PhysicalFileName, '.ndf', '_Copy.ndf') + ''',';\r\n\t\tIF @PhysicalFileName LIKE '%.ldf' --Log Files\r\n\t\t\tPRINT N'\tMOVE N''' + @LogicalName + ''' TO N''' + @PhysicalFileLocation + '\\' + REPLACE(@PhysicalFileName, '.ldf', '_Copy.ldf') + ''',';\r\n\t\t--\r\n\t\tFETCH NEXT FROM CopyDB_FileCursor INTO @LogicalName, @PhysicalFileLocation, @PhysicalFileName;\r\n\tEND;\r\n\r\n\tPRINT N'NOUNLOAD, REPLACE, STATS = 5;';\r\n\tPRINT N'GO';\r\n\tPRINT N'--$EndRegion: Restoring Database \"' + @DBname + '_Copy\" From Backup \"' + @BackupFileLocation + '\\' + @BackupFileName + '\"';\r\n\r\n\tCLOSE CopyDB_FileCursor;\r\n\tDEALLOCATE CopyDB_FileCursor;\r\nEND;\r\n----$EndRegion: CopyDB_RestoreScript\r\n--$EndRegion: Restore Script Generation",
  "placeholders": [
    {
      "name": "DatabaseName",
      "defaultValue": null
    },
    {
      "name": "BackupFileLocation",
      "defaultValue": "C:\\SQL\\Backups"
    },
    {
      "name": "Description",
      "defaultValue": ""
    }
  ]
}