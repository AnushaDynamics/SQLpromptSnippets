{
  "id": "20b2b005-8945-48e0-a7f3-1a2adea540f4",
  "prefix": "GenerateDatabaseBackupAndRestoreScript",
  "description": "Generate Database Backup and Restore Script",
  "body": "/* =============================================================================================================================================================\r\n-- Server\t\t: LOCALSERVER\r\n-- Database\t\t: master\r\n-- Script\t\t: Generate_Database_Backup_and_Restore_Script.sql\r\n-- Description\t: In Dev Env, There might be required to Backup and Restore Database Multiple Times.\r\n--\tSo, This will Generate Script for Backup and Restore to Original File Locations.\r\n--\tThis Backup will be a Copy_Only Backup to Avoid Breaking LSN chain.\r\n-- Usage\t\t: Provide the @DBname, @BackupLocation, @Description (optional)\r\n============================================================================================================================================================= */\r\nUSE master;\r\nGO\r\n--\r\nDECLARE @DBname VARCHAR(256) = '$DatabaseName$';\r\nDECLARE @BackupLocation VARCHAR(1024) = '$BackupFileLocation$'; --Most Preffered Path \"C:\\SQL\\Backups\"\r\nDECLARE @Description VARCHAR(32) = '$Description$'; --Pls DoNot Put Spaces in @Description\r\n--\r\nDECLARE @RequireDatabaseToBeRestoredAsAdditionalBaseDB BIT = 0;\r\n--\r\n/* ===== ** DO NOT CHANGE CODE BELOW FROM HERE ** =========================================================================================================== */\r\nIF DB_ID(@DBname) IS NULL\r\nBEGIN\r\n\tRAISERROR('Database Does Not Exists, Please check the \"@DBname\" and Try Again...!', 16, 1);\r\n\tRETURN;\r\nEND;\r\n--\r\nIF LTRIM(RTRIM(@Description)) = '' OR @Description IS NULL SET @Description = NULL;\r\nDECLARE @BackupFileName VARCHAR(255);\r\nSET @BackupFileName=REPLACE(@@SERVERNAME, '\\', '-')+'_'+REPLACE(@DBname, ' ', '-')+'_v'+CAST(SERVERPROPERTY('ProductVersion') AS VARCHAR(2))+'_'+ISNULL(@Description, 'FullCopyOnly')+'_'+CONVERT(VARCHAR(8), GETDATE(), 112)+'_'+REPLACE(CONVERT(VARCHAR(9), GETDATE(), 108), ':', '')+'.bak';\r\n--\r\n--$BeginRegion: Backup Script Generation\r\nPRINT N'/* ===== ** Backup Script for Database: ' + @DBname + ' ** ======================================================================================== */';\r\nPRINT N'USE [master];';\r\nPRINT N'GO';\r\n--\r\nPRINT N'--$BeginRegion: Copy Only Backup Script for Database \"' + @DBname + '\"';\r\nPRINT N'BACKUP DATABASE [' + @DBname + ']';\r\nPRINT N'TO DISK = N''' + @BackupLocation + '\\' + @BackupFileName + '''';\r\nPRINT N'WITH NAME = N''' + @DBname + '-Full Copy Only Database Backup'',';\r\nPRINT N'\tCOPY_ONLY, NOFORMAT, INIT, SKIP, NOREWIND, NOUNLOAD, COMPRESSION, CHECKSUM, STATS = 5;';\r\nPRINT N'GO';\r\nPRINT N'RESTORE VERIFYONLY';\r\nPRINT N'FROM DISK = N''' + @BackupLocation + '\\' + @BackupFileName + '''';\r\nPRINT N'WITH NOUNLOAD, NOREWIND;';\r\nPRINT N'GO';\r\nPRINT N'--$EndRegion: Copy Only Backup Script for Database \"' + @DBname + '\"';\r\n--$EndRegion: Backup Script Generation\r\n--\r\nPRINT '';\r\n--\r\n--$BeginRegion: Restore Script Generation\r\nPRINT N'/* ===== ** Restore Script for Database: ' + @DBname + ' ** ======================================================================================= */';\r\nPRINT N'USE [master];';\r\nPRINT N'GO';\r\n--\r\nPRINT N'--$BeginRegion: Killing All Sessions for Database \"' + @DBname + '\"';\r\nPRINT N'DECLARE @KillSPIDs NVARCHAR(MAX) = N'''';';\r\nPRINT N'SELECT @KillSPIDs = @KillSPIDs + CHAR(10) + N''KILL '' + CONVERT(VARCHAR(5), session_id) + N'';''';\r\nPRINT N'FROM sys.dm_exec_sessions';\r\nPRINT N'WHERE session_id > 50 AND session_id <> @@SPID AND DB_NAME(database_id) IN (''' + @DBname + ''', '''+@DBname+'_Base'');';\r\nPRINT N'----PRINT @KillSPIDs;';\r\nPRINT N'EXEC sys.sp_executesql @statement = @KillSPIDs;';\r\nPRINT N'GO';\r\nPRINT N'--$EndRegion: Killing All Sessions for Database \"' + @DBname + '\"';\r\n--\r\nDECLARE @LogicalName VARCHAR(256), @PhysicalFileLocation VARCHAR(MAX);\r\n--\r\n----$BeginRegion: MainDB_RestoreScript\r\nDECLARE MainDB_FileCursor CURSOR FAST_FORWARD READ_ONLY LOCAL FOR\r\nSELECT name, physical_name\r\nFROM sys.master_files\r\nWHERE DB_NAME(database_id) = @DBname\r\nORDER BY type ASC, data_space_id ASC;\r\n\r\nPRINT '';\r\nPRINT N'--$BeginRegion: Restore Database \"' + @DBname + '\" From Backup \"' + @BackupLocation + '\\' + @BackupFileName + '\"';\r\nPRINT N'RESTORE DATABASE [' + @DBname + ']';\r\nPRINT N'FROM DISK = N''' + @BackupLocation + '\\' + @BackupFileName + '''';\r\nPRINT N'WITH ';\r\n\r\nOPEN MainDB_FileCursor;\r\nFETCH NEXT FROM MainDB_FileCursor INTO @LogicalName, @PhysicalFileLocation;\r\n\r\nWHILE @@FETCH_STATUS = 0\r\nBEGIN\r\n\tPRINT N'\tMOVE N''' + @LogicalName + ''' TO N''' + @PhysicalFileLocation + ''',';\r\n\t--\r\n\tFETCH NEXT FROM MainDB_FileCursor INTO @LogicalName, @PhysicalFileLocation;\r\nEND;\r\n\r\nPRINT N'NOUNLOAD, REPLACE, STATS = 5;';\r\nPRINT N'GO';\r\nPRINT N'--$EndRegion: Restore Database \"' + @DBname + '\" From Backup \"' + @BackupLocation + '\\' + @BackupFileName + '\"';\r\n\r\nCLOSE MainDB_FileCursor;\r\nDEALLOCATE MainDB_FileCursor;\r\n----$EndRegion: MainDB_RestoreScript\r\n--\r\n----$BeginRegion: BaseDB_RestoreScript\r\nIF @RequireDatabaseToBeRestoredAsAdditionalBaseDB = 1\r\nBEGIN\r\n\tDECLARE BaseDB_FileCursor CURSOR FAST_FORWARD READ_ONLY LOCAL FOR\r\n\tSELECT name, physical_name\r\n\tFROM sys.master_files\r\n\tWHERE DB_NAME(database_id) = @DBname\r\n\tORDER BY type ASC, data_space_id ASC;\r\n\r\n\tPRINT '';\r\n\tPRINT N'--$BeginRegion: Restore Database \"' + @DBname + '_Base\" From Backup \"' + @BackupLocation + '\\' + @BackupFileName + '\"';\r\n\tPRINT N'RESTORE DATABASE [' + @DBname + '_Base]';\r\n\tPRINT N'FROM DISK = N''' + @BackupLocation + '\\' + @BackupFileName + '''';\r\n\tPRINT N'WITH ';\r\n\r\n\tOPEN BaseDB_FileCursor;\r\n\tFETCH NEXT FROM BaseDB_FileCursor INTO @LogicalName, @PhysicalFileLocation;\r\n\r\n\tWHILE @@FETCH_STATUS = 0\r\n\tBEGIN\r\n\t\tPRINT N'\tMOVE N''' + @LogicalName + ''' TO N''' + REPLACE(@PhysicalFileLocation,@DBname, @DBname+'_Base') + ''',';\r\n\t\t--\r\n\t\tFETCH NEXT FROM BaseDB_FileCursor INTO @LogicalName, @PhysicalFileLocation;\r\n\tEND;\r\n\r\n\tPRINT N'NOUNLOAD, REPLACE, STATS = 5;';\r\n\tPRINT N'GO';\r\n\tPRINT N'--$EndRegion: Restore Database \"' + @DBname + '_Base\" From Backup \"' + @BackupLocation + '\\' + @BackupFileName + '\"';\r\n\r\n\tCLOSE BaseDB_FileCursor;\r\n\tDEALLOCATE BaseDB_FileCursor;\r\nEND;\r\n----$EndRegion: BaseDB_RestoreScript\r\n--$EndRegion: Restore Script Generation",
  "placeholders": [
    {
      "name": "DatabaseName",
      "defaultValue": null
    },
    {
      "name": "BackupFileLocation",
      "defaultValue": "C:\\SQL\\Backups"
    },
    {
      "name": "Description",
      "defaultValue": ""
    }
  ]
}
