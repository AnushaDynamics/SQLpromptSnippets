{
  "id": "20b2b005-8945-48e0-a7f3-1a2adea540f4",
  "prefix": "GenerateDatabaseBackupAndRestoreScript",
  "description": "Generate Database Backup and Restore Script",
  "body": "/* =====================================================================================================================\r\n-- Server\t\t: LOCALSERVER\r\n-- Database\t\t: master\r\n-- Script\t\t: Generate_Database_Backup_and_Restore_Script.sql\r\n-- Description\t: In Dev Env, There might be required to Backup and Restore Database Multiple Times.\r\n--\tSo, This will Generate Script for Backup and Restore to Original File Locations.\r\n--\tThis Backup will be a Copy_Only Backup to Avoid Breaking LSN chain.\r\n-- Usage\t\t: Provide the @DBname, @BackupLocation\r\n===================================================================================================================== */\r\nUSE master;\r\nGO\r\n--\r\nDECLARE @DBname VARCHAR(256) = '$DatabaseName$';\r\nDECLARE @BackupLocation VARCHAR(1024) = '$BackupFileLocation$';\r\n--\r\n/* == No Need to Change the Below Script ======================================================== */\r\nIF DB_ID(@DBname) IS NULL\r\nBEGIN\r\n\tRAISERROR('Database Does Not Exists, Please check the @DBname and Try Again...!', 16, 1);\r\n\tRETURN;\r\nEND;\r\n--\r\nDECLARE @BackupFileName VARCHAR(255) = REPLACE(@DBname, ' ', '_') + '__v' + REPLACE(CAST(SERVERPROPERTY('ProductVersion') AS VARCHAR(4)), '.', '_') + '__FullCopyOnly__' + REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR(32), GETDATE(), 120), '-', '_'), ':', '_'), ' ', '__') + '.bak';\r\nDECLARE @SQLcmd VARCHAR(MAX) = '';\r\n--\r\n--$BeginRegion: Backup Script Generation\r\nPRINT '/***** Backup Script for Database: ' + @DBname + ' *****/';\r\nSET @SQLcmd = 'USE [master];\r\nGO\r\nBACKUP DATABASE [' + @DBname + '] \r\nTO DISK = N''' + @BackupLocation + '\\' + @BackupFileName + '''\r\nWITH NAME = N''' + @DBname + '-Full Copy Only Database Backup'',\r\nCOPY_ONLY, NOFORMAT, INIT, SKIP, NOREWIND, NOUNLOAD, COMPRESSION, CHECKSUM, STATS = 5;\r\nGO\r\nRESTORE VERIFYONLY\r\nFROM DISK = N''' + @BackupLocation + '\\' + @BackupFileName + '''\r\nWITH NOUNLOAD, NOREWIND;\r\nGO';\r\nPRINT @SQLcmd;\r\n--$EndRegion: Backup Script Generation\r\nPRINT '';\r\n--$BeginRegion: Restore Script Generation\r\nPRINT '/***** Restore Script for Database: ' + @DBname + ' *****/';\r\nSET @SQLcmd = --\r\n'--$BeginRegion: Killing All Sessions for Database \"' + @DBname + '\"\r\nDECLARE @KillSPIDs NVARCHAR(MAX) = N'''';\r\nSELECT @KillSPIDs = @KillSPIDs + CHAR(10) + N''KILL '' + CONVERT(VARCHAR(5), session_id) + N'';''\r\nFROM sys.dm_exec_sessions \r\nWHERE session_id > 50 AND session_id <> @@SPID AND DB_NAME(database_id) = ''' + @DBname + ''';\r\n--PRINT @KillSPIDs;\r\nEXEC sys.sp_executesql @statement = @KillSPIDs;\r\nGO\r\n--$EndRegion: Killing All Sessions for Database \"' + @DBname + '\"';\r\nPRINT @SQLcmd;\r\n--\r\nDECLARE @LogicalName VARCHAR(256), @PhysicalFileLocation VARCHAR(MAX);\r\n\r\nDECLARE DBFileCursor CURSOR FAST_FORWARD READ_ONLY LOCAL FOR\r\nSELECT name, physical_name\r\nFROM sys.master_files\r\nWHERE DB_NAME(database_id) = @DBname\r\nORDER BY type ASC, data_space_id ASC;\r\n\r\nPRINT 'USE [master];\r\nGO\r\nRESTORE DATABASE [' + @DBname + ']\r\nFROM DISK = N''' + @BackupLocation + '\\' + @BackupFileName + '''\r\nWITH ';\r\n\r\nOPEN DBFileCursor;\r\nFETCH NEXT FROM DBFileCursor INTO @LogicalName, @PhysicalFileLocation;\r\n\r\nWHILE @@FETCH_STATUS = 0\r\n\tBEGIN\r\n\t\tSET @SQLcmd = '\tMOVE N''' + @LogicalName + ''' TO N''' + @PhysicalFileLocation + ''',';\r\n\t\tPRINT @SQLcmd;\r\n\t\tFETCH NEXT FROM DBFileCursor INTO @LogicalName, @PhysicalFileLocation;\r\n\tEND;\r\n\r\nPRINT 'NOUNLOAD, REPLACE, STATS = 5;\r\nGO';\r\n\r\nCLOSE DBFileCursor;\r\nDEALLOCATE DBFileCursor;\r\n--$EndRegion: Restore Script Generation",
  "placeholders": [
    {
      "name": "DatabaseName",
      "defaultValue": null
    },
    {
      "name": "BackupFileLocation",
      "defaultValue": "C:\\SQL\\Backups"
    }
  ]
}
