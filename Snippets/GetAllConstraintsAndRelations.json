{
  "id": "14b2e8b8-5b41-4ce3-a3fa-8b04f4e8575b",
  "prefix": "GetAllConstraintsAndRelations",
  "description": "To Get Details of All Constraints like PK, FK, UK etc",
  "body": "/* =========================================================================================================================================\r\n-- Script\t\t: Get_All_Constraints_And_PK_FK_Relations_Between_Tables(PK_FK_UK)\r\n-- Description\t: To Get Details of All Constraints like 'PRIMARY_KEY_CONSTRAINT', 'FOREIGN_KEY_CONSTRAINT', 'UNIQUE_CONSTRAINT'\r\n--\tGets All Complex Relations like Composite Primary Keys and Foreign Keys And Columns Related\r\n-- Server\t\t: LOCALHOST\r\n-- Database\t\t: USER Database\r\n========================================================================================================================================= */\r\n;WITH _CTE_ALL_RAW_CONSTRAINTS --\r\n(CONSTRAINT_NAME, CONSTRAINT_TYPE, PARENT_SCHEMA_NAME, PARENT_TABLE_NAME, PARENT_CONSTRAINT_COLUMN, REFERENCED_SCHEMA_NAME, REFERENCED_TABLE_NAME, REFERENCED_CONSTRAINT_COLUMN)\r\nAS (\r\n\t   --$BeginRegion: Getting Primary Keys and Unique Keys\r\n\t   SELECT CAST(QUOTENAME(PKnUKEY.name) AS VARCHAR(255)) AS \"CONSTRAINT_NAME\",\r\n\t\t\t  CAST(PKnUKEY.type_desc AS VARCHAR(255)) AS \"CONSTRAINT_TYPE\",\r\n\t\t\t  --'|' AS \"||\"\r\n\t\t\t  CAST(QUOTENAME(SCHEMA_NAME(PKnUTable.schema_id)) AS VARCHAR(255)) AS \"PARENT_SCHEMA_NAME\",\r\n\t\t\t  CAST(QUOTENAME(PKnUTable.name) AS VARCHAR(255)) AS \"PARENT_TABLE_NAME\",\r\n\t\t\t  CAST(QUOTENAME(PKnUKEYCol.name) AS VARCHAR(255)) AS \"PARENT_CONSTRAINT_COLUMN\",\r\n\t\t\t  --'' AS \"=>\",\r\n\t\t\t  NULL AS \"REFERENCED_SCHEMA_NAME\",\r\n\t\t\t  NULL AS \"REFERENCED_TABLE_NAME\",\r\n\t\t\t  NULL AS \"REFERENCED_CONSTRAINT_COLUMN\"\r\n\t   FROM sys.key_constraints AS PKnUKEY\r\n\t   INNER JOIN sys.tables AS PKnUTable ON PKnUTable.object_id = PKnUKEY.parent_object_id\r\n\t   INNER JOIN sys.index_columns AS PKnUColIdx ON PKnUColIdx.object_id = PKnUTable.object_id AND PKnUColIdx.index_id = PKnUKEY.unique_index_id\r\n\t   INNER JOIN sys.columns AS PKnUKEYCol ON PKnUKEYCol.object_id = PKnUTable.object_id AND PKnUKEYCol.column_id = PKnUColIdx.column_id\r\n\t   INNER JOIN INFORMATION_SCHEMA.COLUMNS AS oParentColDtl ON oParentColDtl.TABLE_NAME = PKnUTable.name AND oParentColDtl.COLUMN_NAME = PKnUKEYCol.name\r\n\t   --$EndRegion: Getting Primary Keys and Unique Keys\r\n\t   UNION ALL\r\n\r\n\t   --$BeginRegion: Getting Foreign Keys\r\n\t   SELECT CAST(QUOTENAME(oConstraint.name) AS VARCHAR(255)) AS \"CONSTRAINT_NAME\",\r\n\t\t\t  'FOREIGN_KEY_CONSTRAINT' AS \"CONSTRAINT_TYPE\",\r\n\t\t\t  --'|' AS \"||\"\r\n\t\t\t  CAST(QUOTENAME(SCHEMA_NAME(oParent.uid)) AS VARCHAR(255)) AS \"PARENT_SCHEMA_NAME\",\r\n\t\t\t  CAST(QUOTENAME(oParent.name) AS VARCHAR(255)) AS \"PARENT_TABLE_NAME\",\r\n\t\t\t  CAST(QUOTENAME(oParentCol.name) AS VARCHAR(255)) AS \"PARENT_CONSTRAINT_COLUMN\",\r\n\t\t\t  --'=>' AS \"=>\",\r\n\t\t\t  CAST(QUOTENAME(SCHEMA_NAME(oReference.uid)) AS VARCHAR(255)) AS \"REFERENCED_SCHEMA_NAME\",\r\n\t\t\t  CAST(QUOTENAME(oReference.name) AS VARCHAR(255)) AS \"REFERENCED_TABLE_NAME\",\r\n\t\t\t  CAST(QUOTENAME(oReferenceCol.name) AS VARCHAR(255)) AS \"REFERENCED_CONSTRAINT_COLUMN\"\r\n\t   FROM sys.foreign_key_columns AS FKC\r\n\t   INNER JOIN sys.sysobjects AS oConstraint ON FKC.constraint_object_id = oConstraint.id\r\n\t   INNER JOIN sys.sysobjects AS oParent ON FKC.parent_object_id = oParent.id\r\n\t   INNER JOIN sys.all_columns AS oParentCol ON FKC.parent_object_id = oParentCol.object_id AND FKC.parent_column_id = oParentCol.column_id\r\n\t   INNER JOIN sys.sysobjects AS oReference ON FKC.referenced_object_id = oReference.id\r\n\t   INNER JOIN sys.all_columns AS oReferenceCol ON FKC.referenced_object_id = oReferenceCol.object_id AND FKC.referenced_column_id = oReferenceCol.column_id\r\n   --$EndRegion: Getting Foreign Keys\r\n   )\r\n,_CTE_FINAL_RESULT_SET --\r\nAS (\r\n\t   SELECT DISTINCT FRS.CONSTRAINT_NAME AS \"CONSTRAINT_NAME\",\r\n\t\t\t\t\t   FRS.CONSTRAINT_TYPE AS \"CONSTRAINT_TYPE\",\r\n\t\t\t\t\t   '|' AS \"||\",\r\n\t\t\t\t\t   FRS.PARENT_SCHEMA_NAME AS \"PARENT_SCHEMA_NAME\",\r\n\t\t\t\t\t   FRS.PARENT_TABLE_NAME AS \"PARENT_TABLE_NAME\",\r\n\t\t\t\t\t   FRS.PARENT_SCHEMA_NAME + '.' + FRS.PARENT_TABLE_NAME AS \"PARENT_OBJECT_NAME\",\r\n\t\t\t\t\t   CASE FRS.CONSTRAINT_TYPE\r\n\t\t\t\t\t\t   WHEN 'PRIMARY_KEY_CONSTRAINT' THEN\r\n\t\t\t\t\t\t\t   'PK: ' + IIF(CHARINDEX(',', FRS.PARENT_CONSTRAINT_COLUMNS) > 0, '( ' + FRS.PARENT_CONSTRAINT_COLUMNS + ' )', FRS.PARENT_CONSTRAINT_COLUMNS)\r\n\t\t\t\t\t\t   WHEN 'FOREIGN_KEY_CONSTRAINT' THEN\r\n\t\t\t\t\t\t\t   'FK: ' + IIF(CHARINDEX(',', FRS.PARENT_CONSTRAINT_COLUMNS) > 0, '( ' + FRS.PARENT_CONSTRAINT_COLUMNS + ' )', FRS.PARENT_CONSTRAINT_COLUMNS)\r\n\t\t\t\t\t\t   WHEN 'UNIQUE_CONSTRAINT' THEN\r\n\t\t\t\t\t\t\t   'UK: ' + IIF(CHARINDEX(',', FRS.PARENT_CONSTRAINT_COLUMNS) > 0, '( ' + FRS.PARENT_CONSTRAINT_COLUMNS + ' )', FRS.PARENT_CONSTRAINT_COLUMNS)\r\n\t\t\t\t\t\t   ELSE\r\n\t\t\t\t\t\t\t   ''\r\n\t\t\t\t\t   END AS \"PARENT_CONSTRAINT_COLUMNS\",\r\n\t\t\t\t\t   IIF(FRS.CONSTRAINT_TYPE = 'FOREIGN_KEY_CONSTRAINT', '=>', '  |') AS \"=>\",\r\n\t\t\t\t\t   FRS.REFERENCED_SCHEMA_NAME AS \"REFERENCED_SCHEMA_NAME\",\r\n\t\t\t\t\t   FRS.REFERENCED_TABLE_NAME AS \"REFERENCED_TABLE_NAME\",\r\n\t\t\t\t\t   FRS.REFERENCED_SCHEMA_NAME + '.' + FRS.REFERENCED_TABLE_NAME AS \"REFERENCED_OBJECT_NAME\",\r\n\t\t\t\t\t   'PK: ' + IIF(CHARINDEX(',', FRS.REFERENCED_CONSTRAINT_COLUMNS) > 0, '(' + FRS.REFERENCED_CONSTRAINT_COLUMNS + ')', FRS.REFERENCED_CONSTRAINT_COLUMNS) AS \"REFERENCED_CONSTRAINT_COLUMNS\",\r\n\t\t\t\t\t   '|' AS \"|||\",\r\n\t\t\t\t\t   CASE FRS.CONSTRAINT_TYPE\r\n\t\t\t\t\t\t   WHEN 'FOREIGN_KEY_CONSTRAINT' THEN\r\n\t\t\t\t\t\t\t   'FK:: Columns \" ' + FRS.PARENT_CONSTRAINT_COLUMNS + ' \" in Table \" ' + FRS.PARENT_SCHEMA_NAME + '.' + FRS.PARENT_TABLE_NAME + ' \" => REFERENCES => ' + 'PK:: Columns \" ' + FRS.REFERENCED_CONSTRAINT_COLUMNS + ' \" in Table \" ' + FRS.REFERENCED_SCHEMA_NAME + '.' + FRS.REFERENCED_TABLE_NAME + ' \"'\r\n\t\t\t\t\t\t   ELSE\r\n\t\t\t\t\t\t\t   NULL\r\n\t\t\t\t\t   END AS \"PRIMARYKEY_FOREIGNKEY NOTATION\"\r\n\t   FROM (\r\n\t\t\t\tSELECT ARC.CONSTRAINT_NAME,\r\n\t\t\t\t\t   ARC.CONSTRAINT_TYPE,\r\n\t\t\t\t\t   ARC.PARENT_SCHEMA_NAME,\r\n\t\t\t\t\t   ARC.PARENT_TABLE_NAME,\r\n\t\t\t\t\t   STUFF((\r\n\t\t\t\t\t\t\t\t SELECT ', ' + B.PARENT_CONSTRAINT_COLUMN\r\n\t\t\t\t\t\t\t\t FROM _CTE_ALL_RAW_CONSTRAINTS AS B\r\n\t\t\t\t\t\t\t\t WHERE B.PARENT_SCHEMA_NAME = ARC.PARENT_SCHEMA_NAME\r\n\t\t\t\t\t\t\t\t\t   AND B.PARENT_TABLE_NAME = ARC.PARENT_TABLE_NAME\r\n\t\t\t\t\t\t\t\t\t   AND B.CONSTRAINT_NAME = ARC.CONSTRAINT_NAME\r\n\t\t\t\t\t\t\t\t\t   AND B.CONSTRAINT_TYPE = ARC.CONSTRAINT_TYPE\r\n\t\t\t\t\t\t\t\t ORDER BY B.PARENT_CONSTRAINT_COLUMN ASC\r\n\t\t\t\t\t\t\t\t FOR XML PATH('')), 1, 2, ''\r\n\t\t\t\t\t\t\t) AS \"PARENT_CONSTRAINT_COLUMNS\",\r\n\t\t\t\t\t   ARC.REFERENCED_SCHEMA_NAME,\r\n\t\t\t\t\t   ARC.REFERENCED_TABLE_NAME,\r\n\t\t\t\t\t   STUFF((\r\n\t\t\t\t\t\t\t\t SELECT ', ' + B.REFERENCED_CONSTRAINT_COLUMN\r\n\t\t\t\t\t\t\t\t FROM _CTE_ALL_RAW_CONSTRAINTS AS B\r\n\t\t\t\t\t\t\t\t WHERE B.PARENT_SCHEMA_NAME = ARC.PARENT_SCHEMA_NAME\r\n\t\t\t\t\t\t\t\t\t   AND B.PARENT_TABLE_NAME = ARC.PARENT_TABLE_NAME\r\n\t\t\t\t\t\t\t\t\t   AND B.CONSTRAINT_NAME = ARC.CONSTRAINT_NAME\r\n\t\t\t\t\t\t\t\t\t   AND B.CONSTRAINT_TYPE = ARC.CONSTRAINT_TYPE\r\n\t\t\t\t\t\t\t\t ORDER BY B.PARENT_CONSTRAINT_COLUMN ASC\r\n\t\t\t\t\t\t\t\t FOR XML PATH('')), 1, 2, ''\r\n\t\t\t\t\t\t\t) AS \"REFERENCED_CONSTRAINT_COLUMNS\"\r\n\t\t\t\tFROM _CTE_ALL_RAW_CONSTRAINTS AS ARC\r\n\t\t\t\tGROUP BY ARC.CONSTRAINT_NAME,\r\n\t\t\t\t\t\t ARC.CONSTRAINT_TYPE,\r\n\t\t\t\t\t\t ARC.PARENT_SCHEMA_NAME,\r\n\t\t\t\t\t\t ARC.PARENT_TABLE_NAME,\r\n\t\t\t\t\t\t ARC.REFERENCED_SCHEMA_NAME,\r\n\t\t\t\t\t\t ARC.REFERENCED_TABLE_NAME\r\n\t\t\t) AS FRS\r\n   )\r\nSELECT FRS.CONSTRAINT_NAME,\r\n\t   FRS.CONSTRAINT_TYPE,\r\n\t   FRS.[||],\r\n\t   FRS.PARENT_SCHEMA_NAME,\r\n\t   FRS.PARENT_TABLE_NAME,\r\n\t   --FRS.PARENT_OBJECT_NAME,\r\n\t   FRS.PARENT_CONSTRAINT_COLUMNS,\r\n\t   FRS.[=>],\r\n\t   FRS.REFERENCED_SCHEMA_NAME,\r\n\t   FRS.REFERENCED_TABLE_NAME,\r\n\t   --FRS.REFERENCED_OBJECT_NAME,\r\n\t   FRS.REFERENCED_CONSTRAINT_COLUMNS,\r\n\t   FRS.[|||],\r\n\t   FRS.[PRIMARYKEY_FOREIGNKEY NOTATION]\r\nFROM _CTE_FINAL_RESULT_SET AS FRS\r\nWHERE 1 = 1 --** Note: Use QUOTENAME for Filtering any Value.\r\n\t  --AND FRS.CONSTRAINT_NAME = QUOTENAME('')\r\n\t  --AND FRS.CONSTRAINT_TYPE IN ('PRIMARY_KEY_CONSTRAINT', 'FOREIGN_KEY_CONSTRAINT', 'UNIQUE_CONSTRAINT')\r\n\t  --AND FRS.PARENT_SCHEMA_NAME = QUOTENAME('')\r\n\t  --AND FRS.PARENT_TABLE_NAME = QUOTENAME('')\r\n\t  --AND FRS.PARENT_OBJECT_NAME LIKE '%%'\r\n\t  --AND FRS.PARENT_CONSTRAINT_COLUMNS LIKE '%%'\r\n\t  --AND FRS.REFERENCED_SCHEMA_NAME = QUOTENAME('')\r\n\t  --AND FRS.REFERENCED_TABLE_NAME = QUOTENAME('')\r\n\t  --AND FRS.REFERENCED_OBJECT_NAME LIKE '%%'\r\n\t  --AND FRS.REFERENCED_CONSTRAINT_COLUMNS LIKE '%%'\r\nORDER BY FRS.CONSTRAINT_TYPE DESC;"
}