{
  "id": "82e6669a-4b5c-4a67-9a16-9a482405182c",
  "prefix": "GetDatabaseSpaceUsedByTables",
  "description": "Get Database Space Used By Tables and RowCount",
  "body": "USE $DBNAME$;\r\nGO\r\n;WITH DTS --DetailedTableSize\r\nAS (\r\n\t   --$BeginRegion: TablePartitionStats\r\n\t   SELECT DDPS.object_id,\r\n\t\t\t  SUM(IIF((DDPS.index_id < 2), DDPS.row_count, 0)) AS \"Rows\",\r\n\t\t\t  SUM(DDPS.reserved_page_count) AS \"ReservedPages\",\r\n\t\t\t  SUM(DDPS.used_page_count) AS \"UsedPages\",\r\n\t\t\t  SUM(IIF((DDPS.index_id < 2), (DDPS.in_row_data_page_count + DDPS.lob_used_page_count + DDPS.row_overflow_used_page_count), 0)) AS \"Pages\"\r\n\t   FROM sys.dm_db_partition_stats AS DDPS\r\n\t   WHERE OBJECT_SCHEMA_NAME(DDPS.object_id) <> 'sys'\r\n\t   GROUP BY DDPS.object_id\r\n\t   --$EndRegion: TablePartitionStats\r\n\t   UNION ALL\r\n\r\n\t   --$BeginRegion: InternalTablePartitionStats\r\n\t   SELECT IT.parent_id AS \"object_id\",\r\n\t\t\t  0 AS \"Rows\",\r\n\t\t\t  SUM(DDPS.reserved_page_count) AS \"ReservedPages\",\r\n\t\t\t  SUM(DDPS.used_page_count) AS \"UsedPages\",\r\n\t\t\t  0 AS \"pages\"\r\n\t   FROM sys.dm_db_partition_stats AS DDPS\r\n\t   INNER JOIN sys.internal_tables AS IT\r\n\t\t   ON DDPS.object_id = IT.object_id\r\n\t   WHERE IT.internal_type IN ( 202, 204, 207, 211, 212, 213, 214, 215, 216, 221, 222, 236 )\r\n\t   GROUP BY IT.parent_id\r\n   --$EndRegion: InternalTablePartitionStats\r\n   )\r\nSELECT OBJECT_SCHEMA_NAME(DTS.object_id) AS \"SchemaName\",\r\n\t   OBJECT_NAME(DTS.object_id) AS \"TableName\",\r\n\t   SUM(DTS.Rows) AS \"RowCount\",\r\n\t   SUM(DTS.ReservedPages) * 8 AS \"Reserved(kB)\",\r\n\t   SUM(DTS.Pages) * 8 AS \"Data(kB)\",\r\n\t   IIF((SUM(DTS.UsedPages) > SUM(DTS.Pages)), (SUM(DTS.UsedPages) - SUM(DTS.Pages)), 0) * 8 AS \"Index(kB)\",\r\n\t   IIF((SUM(DTS.ReservedPages) > SUM(DTS.UsedPages)), (SUM(DTS.ReservedPages) - SUM(DTS.UsedPages)), 0) * 8 AS \"UnUsed(kB)\",\r\n\t   EP.value AS \"Comments\"\r\nFROM DTS\r\nINNER JOIN sys.tables AS T\r\n\tON T.object_id = DTS.object_id\r\nLEFT JOIN sys.extended_properties AS EP\r\n\tON T.object_id = EP.major_id AND (EP.name = 'MS_Description' AND EP.minor_id = 0 AND EP.class_desc = 'OBJECT_OR_COLUMN')\r\nGROUP BY DTS.object_id, EP.value\r\nORDER BY SchemaName, TableName ASC;"
}