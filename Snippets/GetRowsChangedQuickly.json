{
  "id": "c7742c40-6805-4578-a61e-1aa9a687fe17",
  "prefix": "GetRowsChangedQuickly",
  "description": "Get Rows Changed For Inserted or Deleted Only But Not UseFul for Updated Rows",
  "body": "/* =========================================================================================================================================\r\n-- Server\t\t: LOCAL SERVER\r\n-- Database\t\t: USER DATABASE\r\n-- Script\t\t: GetRowsChangedQuickly\r\n-- Description\t: Get Rows Changed For Inserted or Deleted Only But Not UseFul for Updated Rows\r\n-- Usage\t\t: Set 1 = 0 To ReUse the #InitialRows | Set 1 = 1 To ReCollect #InitialRows\r\n-- **Note\t\t: Using sys.dm_db_partition_stats is faster than sys.partitions\r\n========================================================================================================================================= */\r\nUSE [$DBNAME$];\r\nGO\r\n--\r\n--$BeginRegion: Reset #InitialRows Collected\r\nIF 1 = 0 --Set 1 = 1 To ReCollect #InitialRows\r\n\tIF OBJECT_ID('tempdb..#InitialRows', 'U') IS NOT NULL DROP TABLE #InitialRows;\r\n--$EndRegion: Reset #InitialRows Collected\r\n--\r\n--$BeginRegion: Collecting #InitialRows\r\nIF OBJECT_ID('tempdb..#InitialRows', 'U') IS NULL\r\nBEGIN\r\n\tSELECT OBJECT_SCHEMA_NAME(PS.object_id) AS \"SchName\", OBJECT_NAME(PS.object_id) AS \"TblName\", SUM(PS.row_count) AS \"Rows\"\r\n\tINTO #InitialRows\r\n\tFROM sys.dm_db_partition_stats AS PS\r\n\tWHERE PS.index_id < 2\r\n\t\tAND OBJECTPROPERTY(PS.object_id, 'IsUserTable') = 1\r\n\tGROUP BY PS.object_id\r\n\tORDER BY SchName ASC, TblName ASC;\r\nEND;\r\n--$EndRegion: Collecting #InitialRows\r\n--\r\n--$BeginRegion: Collecting #FinalRows\r\nIF OBJECT_ID('tempdb..#FinalRows', 'U') IS NOT NULL DROP TABLE #FinalRows;\r\nBEGIN\r\n\tSELECT OBJECT_SCHEMA_NAME(PS.object_id) AS \"SchName\", OBJECT_NAME(PS.object_id) AS \"TblName\", SUM(PS.row_count) AS \"Rows\"\r\n\tINTO #FinalRows\r\n\tFROM sys.dm_db_partition_stats AS PS\r\n\tWHERE PS.index_id < 2\r\n\t\tAND OBJECTPROPERTY(PS.object_id, 'IsUserTable') = 1\r\n\tGROUP BY PS.object_id\r\n\tORDER BY SchName ASC, TblName ASC;\r\nEND;\r\n--$EndRegion: Collecting #FinalRows\r\n--\r\nSELECT ISNULL(IR.SchName, FR.SchName) AS \"SchName\", ISNULL(IR.TblName, FR.TblName) AS \"TblName\", IR.Rows, FR.Rows\r\nFROM #InitialRows AS IR\r\nFULL OUTER JOIN #FinalRows AS FR ON FR.SchName = IR.SchName AND FR.TblName = IR.TblName\r\nWHERE ISNULL(IR.Rows, 0) <> ISNULL(FR.Rows, 0)\r\n\tAND ISNULL(IR.SchName, FR.SchName) NOT LIKE ''\r\n\tAND ISNULL(IR.TblName, FR.TblName) NOT LIKE '';\r\n--\r\nUSE master;\r\nGO"
}