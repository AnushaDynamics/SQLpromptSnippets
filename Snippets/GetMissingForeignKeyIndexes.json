{
  "id": "a4f5552e-408f-476a-8a6d-9090a9f81b6f",
  "prefix": "GetMissingForeignKeyIndexes",
  "description": "Find Missing ForeignKey Indexes which are not Created on the ForeignKey columns in the Referenced Tables",
  "body": "/* =============================================================================================================================================================\r\n-- Database\t\t: USER DATABASE\r\n-- Script\t\t: GetForeignKeysWithoutIndexes\r\n-- Description\t: Find ForeignKeys which doesnot have Indexes Created on the FK columns\r\n-- Refer Links\t: https://github.com/MadeiraData/MadeiraToolbox/blob/master/Best%20Practices%20Checklists/Foreign_Keys_Without_Corresponding_Indexes.sql\r\n-- Acceptable placeholders for @IndexNameTemplate: \r\n\t\t{ParentTableSchema} || {ParentTableName} || {ReferencedTableSchema} || {ReferencedTableName} || {ColumnsList} || {FKName}\r\n============================================================================================================================================================= */\r\nDECLARE @IndexOptions NVARCHAR(MAX) = N' WITH (ONLINE = ON);';\r\nDECLARE @IndexNameTemplate sysname = N'NCIX_{ParentTableName}_{ColumnsList}';\r\n--\r\nSELECT OBJECT_SCHEMA_NAME(FKdetails.ObjectId) AS \"SchemaName\",\r\n\t   OBJECT_NAME(FKdetails.ObjectId) AS \"TableName\",\r\n\t   FKdetails.ForeignKeyName AS \"ForeignKeyName\",\r\n\t   FKdetails.ForeignKeyColList AS \"ForeignKeyColumns\",\r\n\t   OBJECT_SCHEMA_NAME(FKdetails.ReferencedObjectId) AS \"ReferencedSchemaName\",\r\n\t   OBJECT_NAME(FKdetails.ReferencedObjectId) AS \"ReferencedTableName\",\r\n\t   FKdetails.IsDisabled AS \"isDisabled\",\r\n\t   FKdetails.IsNotTrusted AS \"isNotTrusted\",\r\n\t   ISNULL(UsageStats.user_updates, 0) AS \"UserUpdates\",\r\n\t   ISNULL(UsageStats.user_scans, 0) AS \"UserScans\",\r\n\t   UsageStats.last_user_update AS \"LastUpdate\",\r\n\t   UsageStats.last_user_scan AS \"LastScan\",\r\n\t   ISNULL(PartitionStats.TotalRows, 0) AS \"TotalRows\",\r\n\t   --$BeginRegion: Script Formation\r\n\t   'CREATE NONCLUSTERED INDEX '\r\n\t\t+ QUOTENAME(\r\n\t\t\tREPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(\r\n\t\t\t@IndexNameTemplate\r\n\t\t\t, N'{ParentTableSchema}', OBJECT_SCHEMA_NAME(FKdetails.ObjectId))\r\n\t\t\t, N'{ParentTableName}', OBJECT_NAME(FKdetails.ObjectId))\r\n\t\t\t, N'{ReferencedTableSchema}', OBJECT_SCHEMA_NAME(FKdetails.ReferencedObjectId))\r\n\t\t\t, N'{ReferencedTableName}', OBJECT_NAME(FKdetails.ReferencedObjectId))\r\n\t\t\t, N'{ColumnsList}', REPLACE(REPLACE(REPLACE(FKdetails.ForeignKeyColList, N'],[', N'_'), N'[', N''), N']', N''))\r\n\t\t\t, N'{FKName}', FKdetails.ForeignKeyName)\r\n\t\t\t)\r\n\t\t+ ' ON ' + QUOTENAME(OBJECT_SCHEMA_NAME(FKdetails.ObjectId)) + '.' + QUOTENAME(OBJECT_NAME(FKdetails.ObjectId))\r\n\t\t+ ' (' + FKdetails.ForeignKeyColList + ')' + ISNULL(@IndexOptions, N'') AS \"ForeignKeyMissingIndex_RemediationScript\"\r\n\t   --$EndRegion: Script Formation\r\nFROM (\r\n\t\t SELECT ForeignKeys.parent_object_id AS \"ObjectId\",\r\n\t\t\t\tForeignKeys.referenced_object_id AS \"ReferencedObjectId\",\r\n\t\t\t\tForeignKeyColumns.ForeignKeyColList AS \"ForeignKeyColList\",\r\n\t\t\t\tForeignKeys.name AS \"ForeignKeyName\",\r\n\t\t\t\tForeignKeys.is_disabled AS \"IsDisabled\",\r\n\t\t\t\tForeignKeys.is_not_trusted AS \"IsNotTrusted\"\r\n\t\t FROM sys.foreign_keys AS ForeignKeys\r\n\t\t CROSS APPLY (\r\n\t\t\t\t\t\t SELECT STUFF((\r\n\t\t\t\t\t\t\t\t\t\t  SELECT N',' + QUOTENAME(Columns.name)\r\n\t\t\t\t\t\t\t\t\t\t  FROM sys.foreign_key_columns AS ForeignKeyColumns\r\n\t\t\t\t\t\t\t\t\t\t  INNER JOIN sys.columns AS Columns\r\n\t\t\t\t\t\t\t\t\t\t\t  ON ForeignKeyColumns.parent_object_id = Columns.object_id\r\n\t\t\t\t\t\t\t\t\t\t\t\t AND ForeignKeyColumns.parent_column_id = Columns.column_id\r\n\t\t\t\t\t\t\t\t\t\t  WHERE ForeignKeyColumns.constraint_object_id = ForeignKeys.object_id\r\n\t\t\t\t\t\t\t\t\t\t  ORDER BY ForeignKeyColumns.constraint_column_id ASC\r\n\t\t\t\t\t\t\t\t\t\t  FOR XML PATH(N'')), 1, 1, N''\r\n\t\t\t\t\t\t\t\t\t ) AS \"ForeignKeyColList\"\r\n\t\t\t\t\t ) AS ForeignKeyColumns\r\n\t ) AS FKdetails\r\nLEFT OUTER JOIN (\r\n\t\t\t\t\tSELECT Indexes.object_id AS \"ObjectId\",\r\n\t\t\t\t\t\t   IndexKeyColumns.IndexKeyColList AS \"IndexKeyColList\"\r\n\t\t\t\t\tFROM sys.indexes AS Indexes\r\n\t\t\t\t\tCROSS APPLY (\r\n\t\t\t\t\t\t\t\t\tSELECT STUFF((\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t SELECT N',' + QUOTENAME(Columns.name)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t FROM sys.index_columns AS IndexColumns\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t INNER JOIN sys.columns AS Columns\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t ON IndexColumns.object_id = Columns.object_id\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAND IndexColumns.column_id = Columns.column_id\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t WHERE IndexColumns.object_id = Indexes.object_id\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t   AND IndexColumns.index_id = Indexes.index_id\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t ORDER BY IndexColumns.index_column_id ASC\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t FOR XML PATH(N'')), 1, 1, N''\r\n\t\t\t\t\t\t\t\t\t\t\t\t) AS \"IndexKeyColList\"\r\n\t\t\t\t\t\t\t\t) AS IndexKeyColumns\r\n\t\t\t\t) AS IDXdetails\r\n\tON FKdetails.ObjectId = IDXdetails.ObjectId\r\n\t   AND (\r\n\t\t\t   IDXdetails.IndexKeyColList LIKE REPLACE(REPLACE(FKdetails.ForeignKeyColList, '[', '_'), ']', '_') + N'%'\r\n\t\t\t   OR FKdetails.ForeignKeyColList LIKE REPLACE(REPLACE(IDXdetails.IndexKeyColList, '[', '_'), ']', '_') + N'%'\r\n\t\t   )\r\nOUTER APPLY (\r\n\t\t\t\tSELECT IUS.user_updates,\r\n\t\t\t\t\t   IUS.user_scans,\r\n\t\t\t\t\t   IUS.last_user_update,\r\n\t\t\t\t\t   IUS.last_user_scan\r\n\t\t\t\tFROM sys.dm_db_index_usage_stats AS IUS\r\n\t\t\t\tWHERE IUS.database_id = DB_ID() AND IUS.object_id = FKdetails.ObjectId AND IUS.index_id <= 1\r\n\t\t\t) AS UsageStats\r\nOUTER APPLY (\r\n\t\t\t\tSELECT SUM(P.rows) AS \"TotalRows\"\r\n\t\t\t\tFROM sys.partitions AS P\r\n\t\t\t\tWHERE P.object_id = FKdetails.ObjectId AND P.index_id <= 1\r\n\t\t\t) AS PartitionStats\r\nWHERE IDXdetails.ObjectId IS NULL --Gives Missing Indexes on ForeignKeys\r\nORDER BY SchemaName ASC, TableName ASC, ForeignKeyName ASC;\r\nGO"
}